@model QuanLyVatTu_ASP.Areas.Admin.ViewModels.ThongKe.DashboardViewModel
@{
    ViewData["Title"] = "Thống kê doanh thu";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="container-fluid p-4" style="background-color: #f8f9fa;">

    <div class="card border-0 shadow-sm rounded-4 mb-4">
        <div class="card-body p-4">
            <form asp-action="Index" asp-controller="ThongKe" method="get">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label fw-medium text-secondary small">Từ ngày</label>
                        <input type="date" name="fromDate" class="form-control bg-light border-0 rounded-3"
                               value="@Model.FromDate?.ToString("yyyy-MM-dd")">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-medium text-secondary small">Đến ngày</label>
                        <input type="date" name="toDate" class="form-control bg-light border-0 rounded-3"
                               value="@Model.ToDate?.ToString("yyyy-MM-dd")">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-medium text-secondary small">Trạng thái</label>
                        <select name="status" class="form-select bg-light border-0 rounded-3">
                            <option value="">Tất cả</option>
                            @foreach (var st in ViewBag.TrangThais)
                            {
                                <option value="@st" selected="@(Model.Status == st)">@st</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-medium text-secondary small">Phương thức thanh toán</label>
                        <select name="paymentMethod" class="form-select bg-light border-0 rounded-3">
                            <option value="">Tất cả</option>
                            @foreach (var pm in ViewBag.PhuongThucs)
                            {
                                <option value="@pm" selected="@(Model.PaymentMethod == pm)">@pm</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-medium text-secondary small">Nhân viên phụ trách</label>
                        <select name="nhanVienId" class="form-select bg-light border-0 rounded-3" asp-items="ViewBag.NhanViens">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-medium text-secondary small">Khách hàng</label>
                        <select name="khachHangId" class="form-select bg-light border-0 rounded-3" asp-items="ViewBag.KhachHangs">
                            <option value="">Tất cả</option>
                        </select>
                    </div>

                    <div class="col-md-6 d-flex align-items-end justify-content-end gap-3">
                        <a asp-action="Index" class="btn btn-light text-secondary fw-medium rounded-3 px-4" style="background-color: #e9ecef;">
                            <i class="bi bi-arrow-clockwise me-1"></i> Làm mới
                        </a>
                        <button type="submit" class="btn btn-primary fw-medium rounded-3 px-5" style="background-color: #3b82f6; border: none;">
                            <i class="bi bi-bar-chart-line me-1"></i> Thống kê
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-header bg-white border-0 py-3 px-4">
                    <h6 class="mb-0 fw-bold text-secondary">
                        <i class="bi bi-cart3 text-primary me-2 fs-5"></i>Danh sách đơn hàng
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light sticky-top">
                                <tr>
                                    <th class="ps-4 text-secondary small fw-bold py-3">Mã ĐH</th>
                                    <th class="text-secondary small fw-bold">Ngày</th>
                                    <th class="text-secondary small fw-bold">Khách hàng</th>
                                    <th class="text-secondary small fw-bold">Nhân viên</th>
                                    <th class="text-end text-secondary small fw-bold">Tổng tiền</th>
                                    <th class="text-center pe-4 text-secondary small fw-bold">Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.Orders.Any())
                                {
                                    foreach (var order in Model.Orders)
                                    {
                                        <tr>
                                            <td class="ps-4">
                                                <a asp-controller="ChiTietDonHang" asp-action="ChiTiet" asp-route-id="@order.Id"
                                                   class="text-decoration-none fw-medium" style="color: #3b82f6;">
                                                    @order.MaDH
                                                </a>
                                            </td>
                                            <td class="text-secondary small">@order.Ngay.ToString("yyyy-MM-dd")</td>
                                            <td class="text-dark small">@order.KhachHang</td>
                                            <td class="text-secondary small">@order.NhanVien</td>
                                            <td class="text-end fw-medium text-dark">
                                                @order.TongTien.ToString("N0") đ
                                            </td>
                                            <td class="text-center pe-4">
                                                @if (order.DaThanhToan)
                                                {
                                                    <span class="badge rounded-pill fw-normal px-3 py-2"
                                                          style="background-color: #d1fae5; color: #059669;">
                                                        <i class="bi bi-check2 me-1"></i>Đã thanh toán
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge rounded-pill fw-normal px-3 py-2"
                                                          style="background-color: #ffedd5; color: #c2410c;">
                                                        <i class="bi bi-clock me-1"></i>Chưa thanh toán
                                                    </span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="6" class="text-center py-5 text-muted small">
                                            Không có dữ liệu phù hợp
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-header bg-white border-0 py-3 px-4">
                    <h6 class="mb-0 fw-bold text-secondary">
                        <i class="bi bi-graph-up-arrow text-success me-2 fs-5"></i>Biểu đồ doanh thu
                    </h6>
                </div>
                <div class="card-body px-3 d-flex align-items-center justify-content-center">
                    <div style="width: 100%; height: 320px;">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-body p-4 d-flex align-items-center">
                    <div class="rounded-circle d-flex align-items-center justify-content-center me-4"
                         style="width: 60px; height: 60px; background-color: #eff6ff;">
                        <i class="bi bi-currency-dollar fs-3" style="color: #3b82f6;"></i>
                    </div>
                    <div>
                        <div class="text-secondary small fw-medium mb-1">Tổng doanh thu</div>
                        <h4 class="fw-bold mb-0 text-dark">@Model.TotalRevenue.ToString("N0") đ</h4>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-body p-4 d-flex align-items-center">
                    <div class="rounded-circle d-flex align-items-center justify-content-center me-4"
                         style="width: 60px; height: 60px; background-color: #f3e8ff;">
                        <i class="bi bi-file-earmark-text fs-3" style="color: #9333ea;"></i>
                    </div>
                    <div>
                        <div class="text-secondary small fw-medium mb-1">Số đơn hàng</div>
                        <h4 class="fw-bold mb-0 text-dark">@Model.TotalOrders</h4>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-body p-4 d-flex align-items-center">
                    <div class="rounded-circle d-flex align-items-center justify-content-center me-4"
                         style="width: 60px; height: 60px; background-color: #dcfce7;">
                        <i class="bi bi-check-circle fs-3" style="color: #16a34a;"></i>
                    </div>
                    <div>
                        <div class="text-secondary small fw-medium mb-1">Đã thanh toán</div>
                        <h4 class="fw-bold mb-0 text-dark">@Model.PaidOrders</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Lấy dữ liệu từ ViewModel
            const chartLabels = @Html.Raw(Json.Serialize(Model.ChartLabels));
            const chartData = @Html.Raw(Json.Serialize(Model.ChartData));

            const ctx = document.getElementById('revenueChart').getContext('2d');

            // Tạo Gradient màu xanh dương giống hình
            let gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.2)'); // Xanh nhạt
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');   // Trong suốt

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Doanh thu',
                        data: chartData,
                        borderColor: '#3b82f6',       // Đường màu xanh dương chuẩn
                        backgroundColor: gradient,    // Màu nền gradient
                        borderWidth: 2,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#3b82f6',
                        pointRadius: 0,               // Ẩn điểm tròn (giống hình)
                        pointHoverRadius: 6,
                        fill: true,
                        tension: 0.4                  // Đường cong mềm
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },   // Ẩn chú thích
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 10,
                            callbacks: {
                                label: function(context) {
                                    let value = context.parsed.y;
                                    return ' ' + value.toLocaleString('vi-VN') + ' đ';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            border: { display: false },
                            grid: {
                                color: '#f3f4f6',
                                drawBorder: false,
                            },
                            ticks: {
                                color: '#9ca3af',
                                font: { size: 11 },
                                callback: function(value) {
                                    if(value >= 1000000) return (value/1000000) + 'M';
                                    if(value >= 1000) return (value/1000) + 'k';
                                    return value;
                                }
                            }
                        },
                        x: {
                            grid: { display: false }, 
                            ticks: {
                                color: '#9ca3af',
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        });
    </script>
}