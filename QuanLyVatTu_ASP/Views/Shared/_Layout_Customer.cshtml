@using QuanLyVatTu_ASP.Repositories
@using QuanLyVatTu_ASP.Extensions
@using QuanLyVatTu_ASP.Models.ViewModels
@inject IUnitOfWork _unitOfWork
@{
    var _layoutCategories = await _unitOfWork.LoaiVatTuRepository.GetAllAsync();
    
    // Lấy dữ liệu giỏ hàng - ưu tiên DB cho user đã đăng nhập
    var _cart = new List<CartItem>();
    var _khachHangId = Context.Session.GetInt32("KhachHangId");
    if (_khachHangId != null)
    {
        var _gioHang = await _unitOfWork.GioHangRepository.GetByKhachHangIdAsync(_khachHangId.Value);
        if (_gioHang?.ChiTietGioHangs != null)
        {
            _cart = _gioHang.ChiTietGioHangs.Select(ct => new CartItem
            {
                VatTuId = ct.MaVatTu,
                TenVatTu = ct.VatTu?.TenVatTu ?? "",
                DonGia = ct.VatTu?.GiaBan ?? 0,
                SoLuong = ct.SoLuong,
                DonViTinh = ct.VatTu?.DonViTinh ?? "",
                HinhAnh = !string.IsNullOrEmpty(ct.VatTu?.HinhAnh) ? ct.VatTu.HinhAnh : $"https://placehold.co/120x120?text={Uri.EscapeDataString(ct.VatTu?.TenVatTu ?? "SP")}"
            }).ToList();
        }
    }
    else
    {
        _cart = Context.Session.Get<List<CartItem>>("MY_CART") ?? new List<CartItem>();
    }
    var _cartCount = _cart.Sum(x => x.SoLuong);
    var _cartTotal = _cart.Sum(x => x.ThanhTien);
    
    // Lấy dữ liệu wishlist
    var _wishlist = Context.Session.Get<List<WishlistItem>>("WISHLIST") ?? new List<WishlistItem>();
    var _wishlistCount = _wishlist.Count;
}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Cửa hàng vật tư</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" />
    <!-- Core Material CSS -->
    <link rel="stylesheet" href="~/user/css/google-material.css" asp-append-version="true" />
    
    <link rel="stylesheet" href="~/user/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/user/css/Layout_Customer.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/user/css/cart-dropdown.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/user/css/reviews.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
<header class="main-header">
    <div class="container-fluid px-4 px-lg-5 d-flex align-items-center justify-content-between">
        <!-- Logo -->
        <div class="logo">
            <a href="/" class="logo-icon-text d-flex align-items-center gap-2">
                <img src="/images/khachhang/Logo.jpg" alt="VatTu Store" style="height: 50px; object-fit: contain;" />
            </a>
        </div>

        <!-- Search Box (Centered & Modern) -->
        <div class="search-box-wrapper d-none d-md-block">
            <form action="/Search" method="get" class="search-form">
                <button type="submit" class="search-btn">
                    <i class="fas fa-search"></i>
                </button>
                <input type="text" name="q" placeholder="Tìm kiếm sản phẩm, danh mục..." class="search-input" />
            </form>
        </div>
        
        <!-- Admin Shortcut for authenticated employees/admins -->
        <!-- Admin Shortcut for authenticated employees/admins -->
        <!-- Admin Shortcut for authenticated employees/admins -->
        @{
             var currentRole = Context.Session.GetString("Role");
             var currentName = Context.Session.GetString("UserName");
             bool showAdminLink = (!string.IsNullOrEmpty(currentRole) && (currentRole.Equals("Admin", StringComparison.OrdinalIgnoreCase) || currentRole.Equals("Employee", StringComparison.OrdinalIgnoreCase))) 
                                  || (!string.IsNullOrEmpty(currentName) && currentName.Contains("Admin", StringComparison.OrdinalIgnoreCase));
        }

        @if (showAdminLink)
        {
            <div class="ms-3 d-none d-md-block">
                <a asp-route="AdminDonHang" class="btn btn-outline-primary rounded-pill btn-sm fw-bold">
                    <i class="fas fa-user-shield me-1"></i> Trang Quản Trị
                </a>
            </div>
            <!-- Mobile Icon -->
            <div class="d-md-none ms-2">
                <a asp-route="AdminDonHang" class="text-primary fs-4">
                    <i class="fas fa-user-shield"></i>
                </a>
            </div>
        }

        <!-- Action Icons -->
        <div class="header-actions d-flex align-items-center gap-3">
            <!-- Wishlist -->
            <a href="/GioHang/Wishlist" class="icon-btn position-relative text-secondary" style="font-size: 1.2rem;">
                <i class="fa-regular fa-heart"></i>
                @if(_wishlistCount > 0) {
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem;">
                        @_wishlistCount
                    </span>
                }
            </a>

            <!-- Cart -->
            <div class="cart-dropdown-wrapper position-relative">
                <a href="/GioHang/GioHang" class="icon-link cart-icon text-secondary" title="Giỏ hàng" style="font-size: 1.2rem; text-decoration: none;">
                     <i class="fa-solid fa-cart-shopping"></i>
                     @if(_cartCount > 0) {
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-primary" id="headerCartCount" style="font-size: 0.6rem;">
                            @_cartCount
                        </span>
                     }
                </a>
                <!-- Cart Quick Preview Dropdown (Included as previously) -->
                <!-- Reuse existing dropdown HTML structure but styled by CSS -->
                @* ... Dropdown content preserved in Layout_Customer.css rules ... *@
                 <div class="cart-quick-preview" id="cartQuickPreview">
                        <div class="cart-preview-header">
                            <div class="cart-preview-title">
                                <i class="fa-solid fa-shopping-bag"></i>
                                <span>Giỏ hàng của bạn</span>
                            </div>
                            <span class="cart-items-badge" id="dropdownCartBadge">@_cartCount sản phẩm</span>
                        </div>
                        
                        <div class="cart-preview-items" id="cartPreviewItems">
                            @if (_cart.Any())
                            {
                                @foreach (var item in _cart.Take(5))
                                {
                                    <div class="cart-preview-item" data-product-id="@item.VatTuId">
                                        <div class="cart-item-thumb">
                                            <img src="@(string.IsNullOrEmpty(item.HinhAnh) ? $"https://placehold.co/60x60?text={Uri.EscapeDataString(item.TenVatTu?.Substring(0, Math.Min(item.TenVatTu?.Length ?? 0, 8)) ?? "SP")}" : item.HinhAnh)" alt="@item.TenVatTu">
                                        </div>
                                        <div class="cart-item-details">
                                            <h6 class="cart-item-name">@item.TenVatTu</h6>
                                            <div class="cart-item-meta">
                                                <span class="cart-item-price">@item.DonGia.ToString("N0")₫</span>
                                                <span class="cart-item-qty">x@item.SoLuong</span>
                                            </div>
                                        </div>
                                        <button class="btn-remove-cart-item" title="Xóa sản phẩm" onclick="removeFromDropdown(@item.VatTuId)">
                                            <i class="fa-regular fa-trash-can"></i>
                                        </button>
                                    </div>
                                }
                                @if (_cart.Count > 5)
                                {
                                    <div class="cart-preview-more">
                                        <span>+ @(_cart.Count - 5) sản phẩm khác...</span>
                                    </div>
                                }
                            }
                            
                            <!-- Empty State -->
                            <div class="cart-preview-empty" style="@(_cart.Any() ? "display: none;" : "display: flex;")">
                                <i class="fa-solid fa-cart-shopping"></i>
                                <p>Giỏ hàng đang trống</p>
                            </div>
                        </div>
                        
                        <div class="cart-preview-footer" style="@(_cart.Any() ? "" : "display: none;")">
                            <div class="cart-preview-total">
                                <span>Tạm tính:</span>
                                <strong id="dropdownCartTotal">@_cartTotal.ToString("N0")₫</strong>
                            </div>
                            <div class="dropdown-actions">
                                <a href="/GioHang/GioHang" class="btn-view-full-cart">
                                    <i class="fa-regular fa-eye"></i>
                                    Xem giỏ hàng
                                </a>
                                <a href="/ThanhToan/Checkout" class="btn-checkout">
                                    Thanh toán
                                    <i class="fa-solid fa-arrow-right"></i>
                                </a>
                            </div>
                        </div>
                    </div>
            </div>

            <!-- User Profile -->
            @if (!string.IsNullOrEmpty(Context.Session.GetString("UserName")))
            {
                <div class="user-dropdown dropdown">
                    <a href="#" class="user-info d-flex align-items-center gap-2 text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
                        @{
                            var avatarUrl = Context.Session.GetString("AvatarUrl");
                            if (string.IsNullOrEmpty(avatarUrl))
                            {
                                avatarUrl = $"https://ui-avatars.com/api/?name={Uri.EscapeDataString(Context.Session.GetString("UserName") ?? "User")}&background=0B57D0&color=fff";
                            }
                        }
                        <img src="@avatarUrl" alt="Avatar" class="rounded-circle shadow-sm" style="width: 40px; height: 40px; object-fit: cover; border: 2px solid white;" />
                        <div class="d-none d-lg-flex flex-column" style="line-height: 1.2;">
                            <span class="fw-bold text-dark" style="font-size: 0.9rem;">@Context.Session.GetString("UserName")</span>
                        </div>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg rounded-4 p-2 bg-white" style="min-width: 220px;">
                        <li>
                            <div class="px-3 py-2">
                                <strong class="d-block text-truncate text-dark">@Context.Session.GetString("UserName")</strong>
                                <small class="text-muted d-block text-truncate">@Context.Session.GetString("Email")</small>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        
                        @* Admin Link Logic: Check Role or Session/Claims *@
                        @* Admin Link Logic: Check Role or Session/Claims *@
                        @{
                            var userRole = Context.Session.GetString("Role");
                            var userName = Context.Session.GetString("UserName");
                            bool isAdmin = !string.IsNullOrEmpty(userRole) && (userRole.Equals("Admin", StringComparison.OrdinalIgnoreCase) || userRole.Equals("Employee", StringComparison.OrdinalIgnoreCase));
                            bool isLegacyAdmin = !string.IsNullOrEmpty(userName) && userName.Contains("Admin", StringComparison.OrdinalIgnoreCase);
                        }
                        
                        @if (isAdmin || isLegacyAdmin)
                        {
                            <li><a class="dropdown-item rounded-3 py-2 text-primary fw-bold" asp-route="AdminDonHang"><i class="fas fa-user-shield me-2"></i>Trang Quản Trị</a></li>
                        }
                        
                        @* Only show Customer Profile links if Role is Customer or Not Set (Legacy) AND it's not explicitly an Admin role *@
                        @if (Context.Session.GetString("Role") != "Admin" && Context.Session.GetString("Role") != "Employee")
                        {
                            <li><a class="dropdown-item rounded-3 py-2" href="/Customer/Profile"><i class="fas fa-user-circle me-2 text-primary"></i>Hồ sơ cá nhân</a></li>
                            <li><a class="dropdown-item rounded-3 py-2" href="/Customer/Orders"><i class="fas fa-box-open me-2 text-primary"></i>Đơn hàng của tôi</a></li>
                        }
                        
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item rounded-3 py-2 text-danger" href="javascript:void(0);" onclick="location.replace('/Account/Logout')"><i class="fas fa-sign-out-alt me-2"></i>Đăng xuất</a></li>
                    </ul>
                </div>
            }
            else
            {
                <div class="auth-buttons d-flex gap-2">
                    <a href="/Account/Login" class="btn btn-outline-primary rounded-pill px-4">Đăng nhập</a>
                    <a href="/Account/Login?show=register" class="btn btn-primary rounded-pill px-4">Đăng ký</a>
                </div>
            }
        </div>
    </div>

    <!-- Navigation Bar (Sub-header) -->
    <div class="sub-nav border-bottom bg-white d-none d-md-block">
        <div class="container-fluid px-4 px-lg-5">
            <nav class="nav">
                <a class="nav-link py-3 text-dark fw-medium active" href="/">Trang chủ</a>
                <div class="nav-item dropdown">
                     <a class="nav-link py-3 text-dark fw-medium dropdown-toggle" href="/SanPham" data-bs-toggle="dropdown">Danh mục sản phẩm</a>
                     <div class="dropdown-menu border-0 shadow-lg rounded-4 mt-0 bg-white">
                        <a class="dropdown-item py-2" href="/SanPham">Tất cả sản phẩm</a>
                        @if (_layoutCategories != null)
                        {
                            foreach (var cat in _layoutCategories)
                            {
                                <a href="/SanPham?loaiId=@cat.ID" class="dropdown-item py-2">@cat.TenLoaiVatTu</a>
                            }
                        }
                     </div>
                </div>
                <a class="nav-link py-3 text-dark fw-medium" href="/Customer/About">Giới thiệu</a>
                <a class="nav-link py-3 text-dark fw-medium" asp-controller="Home" asp-action="Contact">Liên hệ</a>
            </nav>
        </div>
    </div>
</header>

    <main role="main">
        @RenderBody()
    </main>
<footer class="main-footer">
    <div class="container-fluid px-4 px-lg-5">
        <div class="footer-top row">
            <!-- Cột liên hệ -->
            <div class="col-md-3 col-sm-6 mb-4">
                <h5 class="footer-title">Liên hệ</h5>
                <ul class="footer-links list-unstyled">
                    <li><i class="bi bi-clock me-2"></i>Liên hệ trong giờ làm việc</li>
                    <li><i class="bi bi-chat-dots me-2"></i>Zalo: 0302370432</li>
                    <li><i class="bi bi-envelope me-2"></i>Email: dainhtb01722@gmail.com</li>
                </ul>
            </div>
            
            <!-- Cột về chúng tôi -->
            <div class="col-md-3 col-sm-6 mb-4">
                <h5 class="footer-title">Về chúng tôi</h5>
                <ul class="footer-links list-unstyled">
                    <li><a href="#"><i class="bi bi-info-circle me-2"></i>Giới thiệu</a></li>
                    <li><a href="#"><i class="bi bi-telephone me-2"></i>Liên hệ</a></li>
                    <li><a href="#"><i class="bi bi-question-circle me-2"></i>FAQs</a></li>
                </ul>
            </div>
            
            <!-- Cột chính sách đại lý -->
            <div class="col-md-3 col-sm-6 mb-4">
                <h5 class="footer-title">Chính sách đại lý</h5>
                <ul class="footer-links list-unstyled">
                    <li><a href="/ChinhSach"><i class="bi bi-book me-2"></i>Tổng quan chính sách</a></li>
                    <li><a href="/ChinhSach/ThanhToan"><i class="bi bi-cash-coin me-2"></i>Thanh toán & Đặt cọc</a></li>
                    <li><a href="/ChinhSach/GiaoHang"><i class="bi bi-truck me-2"></i>Vận chuyển hàng hóa</a></li>
                    <li><a href="/ChinhSach/DoiTra"><i class="bi bi-arrow-repeat me-2"></i>Đổi trả & Hoàn tiền</a></li>
                    <li><a href="/ChinhSach/BaoHanh"><i class="bi bi-shield-check me-2"></i>Bảo hành sản phẩm</a></li>
                </ul>
            </div>
            
            <!-- Cột hợp tác & hỗ trợ -->
            <div class="col-md-3 col-sm-6 mb-4">
                <h5 class="footer-title">Hợp tác</h5>
                <ul class="footer-links list-unstyled">
                    <li><a href="#"><i class="bi bi-person-plus me-2"></i>Tuyển dụng</a></li>
                    <li><a href="#"><i class="bi bi-shop me-2"></i>Đăng ký đại lý</a></li>
                    <li><a href="#"><i class="bi bi-headset me-2"></i>Hotline: 1900 xxxx</a></li>
                </ul>
            </div>
        </div>
        
        <!-- Dòng bên dưới với bản quyền và mạng xã hội -->
        <div class="footer-bottom border-top border-secondary pt-4 mt-4">
            <div class="row align-items-center">
                <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                    <p class="mb-0">&copy; 2025 Furniture Store. Tất cả quyền được bảo lưu.</p>
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <div class="social-icons">
                        <a href="#" class="btn btn-outline-light btn-sm me-2">
                            <i class="bi bi-facebook me-1"></i>Facebook
                        </a>
                        <a href="#" class="btn btn-outline-light btn-sm me-2">
                            <i class="bi bi-instagram me-1"></i>Instagram
                        </a>
                        <a href="#" class="btn btn-outline-light btn-sm">
                            <i class="bi bi-chat-dots me-1"></i>Zalo
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</footer>

    <!-- Global Message Modal -->
    <div class="modal fade" id="globalMessageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" id="globalMessageTitle">Thông báo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-3">
                        <i class="fas fa-info-circle text-primary" style="font-size: 3rem;" id="globalMessageIcon"></i>
                    </div>
                    <p id="globalMessageContent" class="fs-5">Nội dung thông báo</p>
                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button type="button" class="btn btn-primary px-4 rounded-pill" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Global Confirm Modal -->
    <div class="modal fade" id="globalConfirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" id="globalConfirmTitle">Xác nhận</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-3">
                        <i class="fas fa-question-circle text-warning" style="font-size: 3rem;"></i>
                    </div>
                    <p id="globalConfirmContent" class="fs-5">Bạn có chắc chắn muốn thực hiện?</p>
                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button type="button" class="btn btn-secondary px-4 rounded-pill" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-danger px-4 rounded-pill" id="globalConfirmBtn">Đồng ý</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Fix paths based on actual structure if needed or remove query string for now if it causes issues -->
    <script src="/user/lib/jquery/dist/jquery.min.js"></script>
    <script src="/user/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/user/js/site.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)
    @await RenderSectionAsync("Styles", required: false)
    <script>
        // Global variables for Modals
        var confirmCallback = null;
        var messageModal = null;
        var confirmModal = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Mobile menu toggle
            const menuToggle = document.getElementById('mobileMenuToggle');
            if (menuToggle) {
                menuToggle.addEventListener('click', function() {
                    const nav = document.getElementById('mainNav');
                    if (nav) nav.classList.toggle('active');
                });
            }

            // Search functionality
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.trim();
                    const suggestions = document.getElementById('searchSuggestions');
                    if (suggestions) {
                        if (searchTerm.length > 2) {
                            suggestions.style.display = 'block';
                        } else {
                            suggestions.style.display = 'none';
                        }
                    }
                });
            }
            
            // User dropdown
            document.querySelectorAll('.user-dropdown').forEach(dropdown => {
                const toggle = dropdown.querySelector('.user-info');
                const menu = dropdown.querySelector('.user-menu');
                if (toggle && menu) {
                    toggle.addEventListener('click', function(e) {
                        e.preventDefault();
                        menu.classList.toggle('show');
                    });
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                document.querySelectorAll('.user-dropdown').forEach(dropdown => {
                     const menu = dropdown.querySelector('.user-menu');
                     if (menu && !dropdown.contains(e.target)) {
                         menu.classList.remove('show');
                     }
                });
            });

            // Initialize Modals
            const msgEl = document.getElementById('globalMessageModal');
            if (msgEl) messageModal = new bootstrap.Modal(msgEl);

            const confirmEl = document.getElementById('globalConfirmModal');
            if (confirmEl) confirmModal = new bootstrap.Modal(confirmEl);

            // Confirm Button Listener
            const confirmBtn = document.getElementById('globalConfirmBtn');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', function() {
                    if (confirmCallback) {
                        confirmCallback();
                    }
                    if (confirmModal) confirmModal.hide();
                });
            }

            // Quick cart preview
            const cartIcon = document.querySelector('.cart-icon');
            if(cartIcon) {
                 cartIcon.addEventListener('mouseenter', function() {
                    // Preview logic
                });
            }
        });

        // Global Helper Functions attached to window
        window.showGlobalMessage = function(message, title = "Thông báo", type = "info") {
            const contentEl = document.getElementById('globalMessageContent');
            const titleEl = document.getElementById('globalMessageTitle');
            const iconEl = document.getElementById('globalMessageIcon');
            
            if (contentEl) contentEl.innerHTML = message;
            if (titleEl) titleEl.innerText = title;
            
            if (iconEl) {
                iconEl.className = ''; // Reset
                if (type === 'success') {
                    iconEl.className = 'fas fa-check-circle text-success';
                    iconEl.style.fontSize = '3rem';
                } else if (type === 'error') {
                    iconEl.className = 'fas fa-times-circle text-danger';
                    iconEl.style.fontSize = '3rem';
                } else {
                    iconEl.className = 'fas fa-info-circle text-primary';
                    iconEl.style.fontSize = '3rem';
                }
            }
            
            if (messageModal) messageModal.show();
        };

        window.showGlobalConfirm = function(message, callback) {
            const contentEl = document.getElementById('globalConfirmContent');
            if (contentEl) contentEl.innerText = message;
            
            confirmCallback = callback;
            
            if (confirmModal) confirmModal.show();
        };

        function updateCartCount(count) {
            document.querySelectorAll('.cart-count').forEach(el => {
                el.textContent = count;
            });
            const badge = document.getElementById('dropdownCartBadge');
            if (badge) badge.textContent = count + ' sản phẩm';
        }

        function updateCartTotal(total) {
            const el = document.getElementById('dropdownCartTotal');
            if (el) el.textContent = total.toLocaleString('vi-VN') + '₫';
        }

        // Add to cart globally available function
        window.addToCart = function(productId, quantity = 1) {
            $.post('/GioHang/AddToCart', { productId, quantity }, function(res) {
                if (res.success) {
                    updateCartCount(res.cartCount);
                    updateCartTotal(res.cartTotal);
                    showCartToast(res.message);
                    // Reload dropdown after adding
                    refreshCartDropdown();
                } else {
                    showGlobalMessage(res.message, 'Lỗi', 'error');
                }
            }).fail(function() {
                showGlobalMessage('Có lỗi xảy ra. Vui lòng thử lại.', 'Lỗi', 'error');
            });
        };

        // Remove from dropdown
        window.removeFromDropdown = function(productId) {
            $.post('/GioHang/RemoveFromCart', { productId }, function(res) {
                if (res.success) {
                    updateCartCount(res.cartCount);
                    updateCartTotal(res.cartTotal);
                    // Remove item from DOM
                    const item = document.querySelector(`[data-product-id="${productId}"]`);
                    if (item) item.remove();
                    // Check if cart is now empty
                    if (res.cartCount === 0) {
                        document.querySelector('.cart-preview-empty').style.display = 'flex';
                        document.querySelector('.cart-preview-footer').style.display = 'none';
                    }
                    showCartToast(res.message);
                }
            });
        };

        // Refresh cart dropdown via AJAX
        window.refreshCartDropdown = function() {
            $.get('/GioHang/GetCartData', function(res) {
                if (res.success) {
                    updateCartCount(res.cartCount);
                    updateCartTotal(res.cartTotal);
                    
                    // Update dropdown items with full DOM rebuild
                    const container = document.getElementById('cartPreviewItems');
                    const footer = document.querySelector('.cart-preview-footer');
                    const emptyState = document.querySelector('.cart-preview-empty');
                    
                    if (container && res.items && res.items.length > 0) {
                        let html = '';
                        const itemsToShow = res.items.slice(0, 5);
                        
                        itemsToShow.forEach(item => {
                            const imgSrc = item.hinhAnh || `https://placehold.co/60x60?text=${encodeURIComponent(item.tenVatTu?.substring(0, 8) || 'SP')}`;
                            html += `
                            <div class="cart-preview-item" data-product-id="${item.vatTuId}">
                                <div class="cart-item-thumb">
                                    <img src="${imgSrc}" alt="${item.tenVatTu}">
                                </div>
                                <div class="cart-item-details">
                                    <h6 class="cart-item-name">${item.tenVatTu}</h6>
                                    <div class="cart-item-meta">
                                        <span class="cart-item-price">${item.donGia.toLocaleString('vi-VN')}₫</span>
                                        <span class="cart-item-qty">x${item.soLuong}</span>
                                    </div>
                                </div>
                                <button class="btn-remove-cart-item" title="Xóa sản phẩm" onclick="removeFromDropdown(${item.vatTuId})">
                                    <i class="fa-regular fa-trash-can"></i>
                                </button>
                            </div>`;
                        });
                        
                        // Add "more items" indicator if needed
                        if (res.items.length > 5) {
                            html += `<div class="cart-preview-more"><span>+ ${res.items.length - 5} sản phẩm khác...</span></div>`;
                        }
                        
                        container.innerHTML = html;
                        if (emptyState) emptyState.style.display = 'none';
                        if (footer) footer.style.display = '';
                    } else if (container) {
                        container.innerHTML = '';
                        if (emptyState) emptyState.style.display = 'flex';
                        if (footer) footer.style.display = 'none';
                    }
                    
                    // Update badge in header
                    const badge = document.getElementById('headerCartCount');
                    if (badge) badge.textContent = res.cartCount + ' sản phẩm';
                }
            });
        };

        // Cart toast notification
        function showCartToast(message) {
            // Create or update toast
            let toast = document.getElementById('cartActionToast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'cartActionToast';
                toast.className = 'cart-action-toast';
                toast.innerHTML = `<i class="fa-solid fa-check-circle"></i><span class="toast-text"></span>`;
                document.body.appendChild(toast);
                
                // Add styles if not exists
                if (!document.getElementById('cartToastStyles')) {
                    const style = document.createElement('style');
                    style.id = 'cartToastStyles';
                    style.textContent = `
                        .cart-action-toast {
                            position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #28a745, #20c997);
                            color: white; padding: 12px 24px; border-radius: 10px; display: flex; align-items: center; gap: 10px;
                            box-shadow: 0 4px 20px rgba(40,167,69,0.4); z-index: 10000; transform: translateX(150%); transition: transform 0.3s ease;
                        }
                        .cart-action-toast.show { transform: translateX(0); }
                        .cart-action-toast i { font-size: 1.2rem; }
                    `;
                    document.head.appendChild(style);
                }
            }
            toast.querySelector('.toast-text').textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
    <div class="modal fade" id="globalLoginModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">Yêu cầu đăng nhập</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-3">
                        <i class="fas fa-user-lock text-warning" style="font-size: 3rem;"></i>
                    </div>
                    <p class="fs-5" id="globalLoginMessage">Bạn cần đăng nhập để thực hiện chức năng này.</p>
                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button type="button" class="btn btn-secondary px-4 rounded-pill" data-bs-dismiss="modal">Để sau</button>
                    <a href="/Account/Login" class="btn btn-primary px-4 rounded-pill">Đăng nhập ngay</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ... (previous scripts)
        
        var loginModal = null;
        
        document.addEventListener('DOMContentLoaded', function() {
           // ... (previous listeners)
           const loginEl = document.getElementById('globalLoginModal');
           if (loginEl) loginModal = new bootstrap.Modal(loginEl);
        });

        window.showGlobalLogin = function(message) {
            if (message) document.getElementById('globalLoginMessage').innerText = message;
            if (loginModal) loginModal.show();
        };

        // Global Wishlist Function
        window.addToWishlist = function(productId) {
            $.post('/GioHang/AddToWishlist', { productId }, function(res) {
                 if (res.success) {
                    // Update header wishlist badge if it exists
                    const wishlistBadge = document.querySelector('.icon-btn .badge-count');
                    // Check logic for badge update (assume checking DOM element existence)
                    if(document.querySelector('.fa-heart + span')) { // Simplistic check
                         // If badge specifically exists
                         // Better to reload page or just notify if we don't have easy badge access
                    }
                    showCartToast(res.message); 
                } else if (res.requireLogin) {
                    showGlobalLogin(res.message);
                } else {
                    showGlobalMessage(res.message, 'Thông báo', 'info');
                }
            }).fail(function() {
                showGlobalMessage('Có lỗi xảy ra. Vui lòng thử lại.', 'Lỗi', 'error');
            });
        };
    </script>
    <script>
        // Handle TempData messages from Controller
        document.addEventListener('DOMContentLoaded', function() {
            @if (TempData["Success"] != null)
            {
                <text>showGlobalMessage(@Html.Raw(Json.Serialize(TempData["Success"])), 'Thành công', 'success');</text>
            }
            @if (TempData["Error"] != null)
            {
                <text>showGlobalMessage(@Html.Raw(Json.Serialize(TempData["Error"])), 'Lỗi', 'error');</text>
            }
            @if (TempData["Warning"] != null)
            {
                <text>showGlobalMessage(@Html.Raw(Json.Serialize(TempData["Warning"])), 'Thông báo', 'info');</text>
            }
        });
    </script>
</body>
</html>