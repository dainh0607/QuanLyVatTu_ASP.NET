@using QuanLyVatTu_ASP.Models.ViewModels
@model ProfileViewModel
@{
    ViewData["Title"] = "Tài khoản của tôi";

}

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Leaflet CSS for Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Profile CSS -->
<link rel="stylesheet" href="~/user/css/profile-new.css" asp-append-version="true" />

<div class="profile-page-new">
    <div class="profile-container">
        
        <!-- Breadcrumb -->
        <nav class="profile-breadcrumb">
            <a href="/">Trang chủ</a>
            <span class="separator"><i class="fas fa-chevron-right"></i></span>
            <span class="current">Tài khoản của tôi</span>
        </nav>

        <div class="profile-layout">
            
            <!-- SIDEBAR -->
            <aside class="profile-sidebar">
                
                <!-- User Card -->
                <div class="sidebar-user-card">
                    <div class="user-avatar-wrapper">
                        <img src="@(string.IsNullOrEmpty(Model.KhachHang.AnhDaiDien) ? "https://i.pravatar.cc/150?img=12" : Model.KhachHang.AnhDaiDien)" alt="Avatar" class="user-avatar" id="userAvatar">
                        <label for="avatarUpload" class="avatar-edit-btn">
                            <i class="fas fa-camera"></i>
                        </label>
                        <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
                    </div>
                    <h3 class="user-name">@Model.KhachHang.HoTen</h3>
                    <p class="user-email">@Model.KhachHang.Email</p>
                    <div class="user-stats">
                        <div class="stat-item">
                            <div class="stat-value">@Model.SoDonHang</div>
                            <div class="stat-label">Đơn hàng</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">@Model.TongTienMua.ToString("N0")đ</div>
                            <div class="stat-label">Tổng chi</div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Menu -->
                <nav class="sidebar-nav">
                    <!-- Tài khoản của tôi -->
                    <div class="nav-group">
                        <div class="nav-group-title">
                            <i class="fas fa-user-circle"></i>
                            Tài khoản của tôi
                        </div>
                        <a href="#profile" class="nav-item active" data-tab="profile">
                            <i class="fas fa-user"></i>
                            Hồ sơ
                        </a>
                        <a href="#address" class="nav-item" data-tab="address">
                            <i class="fas fa-map-marker-alt"></i>
                            Địa chỉ giao hàng
                        </a>
                        <a href="#password" class="nav-item" data-tab="password">
                            <i class="fas fa-lock"></i>
                            Đổi mật khẩu
                        </a>
                    </div>

                    <!-- Đơn hàng vật tư -->
                    <div class="nav-group">
                        <div class="nav-group-title">
                            <i class="fas fa-box"></i>
                            Đơn hàng vật tư
                        </div>
                        <a href="#orders" class="nav-item" data-tab="orders">
                            <i class="fas fa-shopping-bag"></i>
                            Đơn hàng của tôi
                            @if(Model.SoDonHang > 0) {
                                <span class="badge">@Model.SoDonHang</span>
                            }
                        </a>
                        <a href="#quotes" class="nav-item" data-tab="quotes">
                            <i class="fas fa-file-invoice"></i>
                            Yêu cầu báo giá
                        </a>
                        <a href="#history" class="nav-item" data-tab="history">
                            <i class="fas fa-history"></i>
                            Lịch sử mua hàng
                        </a>
                    </div>

                    <!-- Tài chính -->
                    <div class="nav-group">
                        <div class="nav-group-title">
                            <i class="fas fa-wallet"></i>
                            Tài chính
                        </div>
                        <a href="#debt" class="nav-item" data-tab="debt">
                            <i class="fas fa-money-bill-wave"></i>
                            Công nợ
                        </a>
                        <a href="#invoice" class="nav-item" data-tab="invoice">
                            <i class="fas fa-file-invoice-dollar"></i>
                            Hóa đơn VAT
                        </a>
                    </div>

                    <!-- Thông báo -->
                    <div class="nav-group">
                        <div class="nav-group-title">
                            <i class="fas fa-bell"></i>
                            Thông báo
                        </div>
                        <a href="#notifications" class="nav-item" data-tab="notifications">
                            <i class="fas fa-envelope"></i>
                            Thông báo hệ thống
                        </a>
                        <a href="#promotions" class="nav-item" data-tab="promotions">
                            <i class="fas fa-tags"></i>
                            Ưu đãi & Khuyến mãi
                        </a>
                    </div>

                    <!-- Cài đặt -->
                    <div class="nav-group">
                        <div class="nav-group-title">
                            <i class="fas fa-cog"></i>
                            Cài đặt
                        </div>
                        <a href="#settings" class="nav-item" data-tab="settings">
                            <i class="fas fa-sliders-h"></i>
                            Cài đặt thông báo
                        </a>
                        <a href="#privacy" class="nav-item" data-tab="privacy">
                            <i class="fas fa-shield-alt"></i>
                            Quyền riêng tư
                        </a>
                    </div>

                    <!-- Logout -->
                    <a href="@Url.Action("Logout", "Account")" class="nav-item logout">
                        <i class="fas fa-sign-out-alt"></i>
                        Đăng xuất
                    </a>
                </nav>
            </aside>

            <!-- MAIN CONTENT -->
            <main class="profile-content">
                
                <!-- TAB: HỒ SƠ -->
                <section class="tab-panel active" id="tab-profile">
                    <div class="content-card">
                        <div class="card-header">
                            <div class="card-header-left">
                                <h2 class="card-title">Hồ sơ của tôi</h2>
                                <p class="card-subtitle">Quản lý thông tin hồ sơ để bảo mật tài khoản</p>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="profile-form-grid">
                                <div class="form-fields">
                                    <!-- Họ và tên -->
                                    <div class="form-group">
                                        <label class="form-label">Họ và tên <span class="required">*</span></label>
                                        <input type="text" class="form-input" id="hoTen" value="@Model.KhachHang.HoTen" placeholder="Nhập họ tên">
                                    </div>

                                    <!-- Email & Phone -->
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Email <span class="required">*</span></label>
                                            <div class="input-with-badge">
                                                <input type="email" class="form-input" value="@Model.KhachHang.Email" disabled style="padding-right: 140px;">
                                                <div class="input-badge">
                                                    <span class="verified-badge"><i class="fas fa-check-circle"></i> Đã xác thực</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Số điện thoại <span class="required">*</span></label>
                                            <div class="input-with-badge">
                                                <input type="tel" class="form-input" id="soDienThoai" value="@Model.KhachHang.SoDienThoai" style="padding-right: 140px;">
                                                <div class="input-badge">
                                                    <span class="verified-badge"><i class="fas fa-check-circle"></i> Đã xác thực</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Address -->
                                    <div class="form-group">
                                        <label class="form-label">Địa chỉ</label>
                                        <input type="text" class="form-input" id="diaChi" value="@Model.KhachHang.DiaChi" placeholder="Nhập địa chỉ">
                                    </div>

                                    <button type="button" class="btn-primary" onclick="saveProfile()">
                                        <i class="fas fa-save"></i>
                                        Lưu thay đổi
                                    </button>
                                </div>

                                <!-- Avatar Upload Section (Unified with Sidebar) -->
                                <div class="avatar-upload-section">
                                    <p class="text-muted" style="margin-bottom: 10px;">Ảnh đại diện hiển thị ở cột bên trái</p>
                                    <label for="avatarUpload" class="upload-btn">
                                        <i class="fas fa-camera"></i>
                                        Thay đổi ảnh đại diện
                                    </label>
                                    <!-- Removed duplicate input id="avatarInput" -->
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- TAB: ĐỊA CHỈ GIAO HÀNG -->
                <section class="tab-panel" id="tab-address" style="display: none;">
                    <div class="content-card">
                        <div class="card-header">
                            <div class="card-header-left">
                                <h2 class="card-title">Địa chỉ giao hàng</h2>
                                <p class="card-subtitle">Quản lý địa chỉ nhận hàng của bạn</p>
                            </div>
                            <button class="btn-primary" onclick="openAddressModal()">
                                <i class="fas fa-plus"></i>
                                Thêm địa chỉ mới
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="addressListContainer" class="address-list">
                                <!-- Addresses will be loaded here via AJAX -->
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Tùy chọn mua hàng -->
                    <div class="content-card" style="margin-top: 24px;">
                        <div class="card-header">
                            <div class="card-header-left">
                                <h2 class="card-title">Tùy chọn mua hàng</h2>
                                <p class="card-subtitle">Thiết lập tùy chọn giao nhận phù hợp với bạn</p>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="options-grid">
                                <!-- Phương thức nhận hàng -->
                                <div class="option-group">
                                    <h4 class="option-group-title">Phương thức nhận hàng ưu tiên</h4>
                                    <div class="radio-group">
                                        <label class="radio-option selected">
                                            <input type="radio" name="phuongThucNhan" value="giaotannoi" checked>
                                            <span>🚚 Giao hàng tận nơi</span>
                                        </label>
                                        <label class="radio-option">
                                            <input type="radio" name="phuongThucNhan" value="nhantaikho">
                                            <span>🏪 Nhận tại kho</span>
                                        </label>
                                        <label class="radio-option">
                                            <input type="radio" name="phuongThucNhan" value="dinhky">
                                            <span>📅 Giao theo lịch định kỳ</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Thời gian giao hàng -->
                                <div class="option-group">
                                    <h4 class="option-group-title">Thời gian giao hàng mong muốn</h4>
                                    <select class="form-select">
                                        <option value="sang" selected>Buổi sáng (7h - 12h)</option>
                                        <option value="chieu">Buổi chiều (13h - 18h)</option>
                                        <option value="linhhoat">Linh hoạt</option>
                                    </select>
                                </div>

                                <!-- Yêu cầu đặc biệt -->
                                <div class="option-group">
                                    <h4 class="option-group-title">Yêu cầu đặc biệt</h4>
                                    <div class="checkbox-group">
                                        <label class="checkbox-option">
                                            <input type="checkbox" checked>
                                            <span>📋 Cần hóa đơn VAT</span>
                                        </label>
                                        <label class="checkbox-option">
                                            <input type="checkbox" checked>
                                            <span>📄 Yêu cầu CO/CQ cho vật tư</span>
                                        </label>
                                        <label class="checkbox-option">
                                            <input type="checkbox" checked>
                                            <span>🔔 Nhận thông báo khuyến mãi</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Hạn mức công nợ -->
                                <div class="option-group">
                                    <h4 class="option-group-title">Hạn mức công nợ</h4>
                                    <div class="credit-limit-section">
                                        <div class="credit-header">
                                            <span class="credit-label">Hạn mức tối đa</span>
                                            <span class="credit-value">50.000.000đ</span>
                                        </div>
                                        <div class="credit-progress">
                                            <div class="credit-progress-bar" style="width: 30%;"></div>
                                        </div>
                                        <div class="credit-stats">
                                            <span>Đã sử dụng: 15.000.000đ</span>
                                            <span>Còn lại: 35.000.000đ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button type="button" class="btn-primary" style="margin-top: 24px;" onclick="saveOptions()">
                                <i class="fas fa-save"></i>
                                Lưu tùy chọn
                            </button>
                        </div>
                    </div>
                </section>

                <!-- TAB: ĐỔI MẬT KHẨU -->
                <section class="tab-panel" id="tab-password" style="display: none;">
                    <div class="content-card">
                        <div class="card-header">
                            <div class="card-header-left">
                                <h2 class="card-title">Đổi mật khẩu</h2>
                                <p class="card-subtitle">Cập nhật mật khẩu để bảo mật tài khoản</p>
                            </div>
                        </div>
                        <div class="card-body">
                            <form id="changePassForm" style="max-width: 500px;">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="Id" value="@Model.KhachHang.ID" />
                                <div class="form-group" style="margin-bottom: 20px;">
                                    <label class="form-label">Mật khẩu hiện tại <span class="required">*</span></label>
                                    <div class="input-with-badge">
                                        <input type="password" class="form-input" name="MatKhauCu" required placeholder="Nhập mật khẩu hiện tại" id="currentPass">
                                        <div class="input-badge clickable" onclick="togglePassword('currentPass', this)" style="cursor: pointer;">
                                            <i class="fas fa-eye"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom: 20px;">
                                    <label class="form-label">Mật khẩu mới <span class="required">*</span></label>
                                    <div class="input-with-badge">
                                        <input type="password" class="form-input" name="MatKhauMoi" required placeholder="Nhập mật khẩu mới" id="newPass" minlength="6">
                                        <div class="input-badge clickable" onclick="togglePassword('newPass', this)" style="cursor: pointer;">
                                            <i class="fas fa-eye"></i>
                                        </div>
                                    </div>
                                    <small class="text-muted" style="display: block; margin-top: 5px;">Tối thiểu 6 ký tự</small>
                                </div>
                                <div class="form-group" style="margin-bottom: 24px;">
                                    <label class="form-label">Xác nhận mật khẩu mới <span class="required">*</span></label>
                                    <div class="input-with-badge">
                                        <input type="password" class="form-input" name="XacNhanMatKhau" required placeholder="Nhập lại mật khẩu mới" id="confirmPass">
                                        <div class="input-badge clickable" onclick="togglePassword('confirmPass', this)" style="cursor: pointer;">
                                            <i class="fas fa-eye"></i>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn-primary">
                                    <i class="fas fa-lock"></i>
                                    Cập nhật mật khẩu
                                </button>
                            </form>
                        </div>
                    </div>
                </section>

                <!-- TAB: ĐƠN HÀNG -->
                <section class="tab-panel" id="tab-orders" style="display: none;">
                    <div class="content-card">
                        <div class="card-header">
                            <div class="card-header-left">
                                <h2 class="card-title">Đơn hàng của tôi</h2>
                                <p class="card-subtitle">Theo dõi và quản lý đơn hàng</p>
                            </div>
                        </div>
                        <div class="card-body">
                            @if (Model.DonHangs != null && Model.DonHangs.Any())
                            {
                                foreach (var order in Model.DonHangs)
                                {
                                    <div class="address-card" style="margin-bottom: 16px;">
                                        <div class="address-icon" style="background: #dbeafe;">
                                            <i class="fas fa-box" style="color: #3b82f6;"></i>
                                        </div>
                                        <div class="address-info">
                                            <div class="address-header">
                                                <span class="address-name">Đơn hàng #@order.ID</span>
                                                <span class="address-phone">| @order.NgayDat.ToString("dd/MM/yyyy HH:mm")</span>
                                                <span class="address-type-badge" style="background: @GetStatusColor(order.TrangThai); color: white;">@order.TrangThai</span>
                                            </div>
                                            <p class="address-text" style="margin-bottom: 8px;">
                                                <strong style="color: #111827;">Tổng tiền: <span style="color: #ef4444;">@(order.TongTien?.ToString("N0") ?? "0")đ</span></strong>
                                            </p>
                                            @if (order.ChiTietDonHangs != null)
                                            {
                                                <div style="background: #f9fafb; padding: 12px; border-radius: 8px; font-size: 0.85rem;">
                                                    @foreach (var ct in order.ChiTietDonHangs)
                                                    {
                                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                                            <span style="color: #4b5563;">@ct.VatTu?.TenVatTu x @ct.SoLuong</span>
                                                            <span style="color: #111827; font-weight: 500;">@ct.ThanhTien.ToString("N0")đ</span>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div style="text-align: center; padding: 60px 20px; color: #6b7280;">
                                    <i class="fas fa-shopping-bag" style="font-size: 4rem; color: #e5e7eb; margin-bottom: 16px;"></i>
                                    <p style="margin-bottom: 16px;">Bạn chưa có đơn hàng nào.</p>
                                    <a href="/SanPham" class="btn-primary">
                                        <i class="fas fa-shopping-cart"></i>
                                        Mua sắm ngay
                                    </a>
                                </div>
                            }
                        </div>
                    </div>
                </section>

                <!-- Placeholder tabs -->
                <section class="tab-panel" id="tab-quotes" style="display: none;">
                    <div class="content-card">
                        <div class="card-header">
                            <h2 class="card-title">Yêu cầu báo giá</h2>
                        </div>
                        <div class="card-body" style="text-align: center; padding: 60px;">
                            <i class="fas fa-file-invoice" style="font-size: 4rem; color: #e5e7eb;"></i>
                            <p style="color: #6b7280; margin-top: 16px;">Chức năng đang được phát triển</p>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" id="tab-history" style="display: none;">
                    <div class="content-card">
                        <div class="card-header">
                            <h2 class="card-title">Lịch sử mua hàng</h2>
                        </div>
                        <div class="card-body" style="text-align: center; padding: 60px;">
                            <i class="fas fa-history" style="font-size: 4rem; color: #e5e7eb;"></i>
                            <p style="color: #6b7280; margin-top: 16px;">Xem chi tiết tại tab "Đơn hàng của tôi"</p>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" id="tab-debt" style="display: none;">
                    <div class="content-card">
                        <div class="card-header">
                            <h2 class="card-title">Công nợ</h2>
                        </div>
                        <div class="card-body">
                            <div class="credit-limit-section" style="max-width: 500px;">
                                <div class="credit-header">
                                    <span class="credit-label">Công nợ hiện tại</span>
                                    <span class="credit-value" style="color: #ef4444;">15.000.000đ</span>
                                </div>
                                <div class="credit-progress">
                                    <div class="credit-progress-bar" style="width: 30%; background: linear-gradient(90deg, #ef4444, #f59e0b);"></div>
                                </div>
                                <div class="credit-stats">
                                    <span>Hạn mức: 50.000.000đ</span>
                                    <span>Còn được mua: 35.000.000đ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" id="tab-invoice" style="display: none;">
                    <div class="content-card">
                        <div class="card-header">
                            <h2 class="card-title">Hóa đơn VAT</h2>
                        </div>
                        <div class="card-body" style="text-align: center; padding: 60px;">
                            <i class="fas fa-file-invoice-dollar" style="font-size: 4rem; color: #e5e7eb;"></i>
                            <p style="color: #6b7280; margin-top: 16px;">Chưa có hóa đơn VAT nào</p>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" id="tab-notifications" style="display: none;">
                    <div class="content-card">
                        <div class="card-header">
                            <h2 class="card-title">Thông báo hệ thống</h2>
                        </div>
                        <div class="card-body" style="text-align: center; padding: 60px;">
                            <i class="fas fa-bell" style="font-size: 4rem; color: #e5e7eb;"></i>
                            <p style="color: #6b7280; margin-top: 16px;">Không có thông báo mới</p>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" id="tab-promotions" style="display: none;">
                    <div class="content-card">
                        <div class="card-header">
                            <h2 class="card-title">Ưu đãi & Khuyến mãi</h2>
                        </div>
                        <div class="card-body" style="text-align: center; padding: 60px;">
                            <i class="fas fa-tags" style="font-size: 4rem; color: #e5e7eb;"></i>
                            <p style="color: #6b7280; margin-top: 16px;">Chưa có ưu đãi nào</p>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" id="tab-settings" style="display: none;">
                    <div class="content-card">
                        <div class="card-header">
                            <h2 class="card-title">Cài đặt thông báo</h2>
                        </div>
                        <div class="card-body">
                            <div class="checkbox-group" style="max-width: 500px;">
                                <label class="checkbox-option">
                                    <input type="checkbox" checked>
                                    <span>Nhận email cập nhật đơn hàng</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" checked>
                                    <span>Nhận SMS khi đơn hàng thay đổi trạng thái</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox">
                                    <span>Nhận thông báo về sản phẩm mới</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" checked>
                                    <span>Nhận email khuyến mãi hàng tuần</span>
                                </label>
                            </div>
                            <button type="button" class="btn-primary" style="margin-top: 24px;">
                                <i class="fas fa-save"></i>
                                Lưu cài đặt
                            </button>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" id="tab-privacy" style="display: none;">
                    <div class="content-card">
                        <div class="card-header">
                            <h2 class="card-title">Quyền riêng tư</h2>
                        </div>
                        <div class="card-body">
                            <div class="checkbox-group" style="max-width: 500px;">
                                <label class="checkbox-option">
                                    <input type="checkbox" checked>
                                    <span>Hiển thị tên trong danh sách đánh giá</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox">
                                    <span>Cho phép nhà bán hàng liên hệ trực tiếp</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" checked>
                                    <span>Lưu lịch sử tìm kiếm</span>
                                </label>
                            </div>
                            <button type="button" class="btn-primary" style="margin-top: 24px;">
                                <i class="fas fa-save"></i>
                                Lưu cài đặt
                            </button>
                        </div>
                    </div>
                </section>

            </main>
        </div>
    </div>
</div>

<!-- Map Modal -->
<div class="map-modal-overlay" id="mapModal">
    <div class="map-modal">
        <div class="map-modal-header">
            <h3 class="map-modal-title">📍 Chọn vị trí trên bản đồ</h3>
            <button class="map-modal-close" onclick="closeMapModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="map-search-box">
            <div class="map-search-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" class="map-search-input" id="mapSearchInput" placeholder="Tìm kiếm địa chỉ...">
            </div>
        </div>
        <div class="map-container">
            <div id="leaflet-map"></div>
        </div>
        <div class="map-modal-footer">
            <div class="selected-location" id="selectedLocation">
                <i class="fas fa-map-pin"></i>
                <span>Chưa chọn vị trí</span>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn-secondary" onclick="closeMapModal()">Hủy</button>
                <button class="btn-primary" onclick="confirmLocation()">
                    <i class="fas fa-check"></i>
                    Xác nhận vị trí
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // Tab Navigation
    document.querySelectorAll('.nav-item[data-tab]').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const tabName = this.dataset.tab;
            switchTab(tabName);
            
            // Update active state
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            this.classList.add('active');
        });
    });

    function switchTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-panel').forEach(tab => {
            tab.style.display = 'none';
        });
        
        // Show selected tab
        const targetTab = document.getElementById('tab-' + tabName);
        if (targetTab) {
            targetTab.style.display = 'block';
        }
    }

    // Radio option selection style
    document.querySelectorAll('.radio-option input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const group = this.closest('.radio-group');
            group.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
            this.closest('.radio-option').classList.add('selected');
        });
    });

    // Unified Avatar Change Handler
    document.getElementById('avatarUpload')?.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                // Update all avatar previews
                const userAvatar = document.getElementById('userAvatar');
                if(userAvatar) userAvatar.src = e.target.result;
                
                // If there's a preview in the main content (optional)
                const avatarPreview = document.getElementById('avatarPreview');
                if(avatarPreview) avatarPreview.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    // Map functionality
    let map;
    let marker;
    let selectedLat = null;
    let selectedLng = null;

    function openAddressModal() {
        document.getElementById('mapModal').classList.add('active');
        initMap();
    }

    function closeMapModal() {
        document.getElementById('mapModal').classList.remove('active');
    }

    function initMap() {
        if (!map) {
            // Default to Ho Chi Minh City
            map = L.map('leaflet-map').setView([10.8231, 106.6297], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Add marker on click
            map.on('click', function(e) {
                setMarker(e.latlng.lat, e.latlng.lng);
            });
        }
        setTimeout(() => map.invalidateSize(), 100);
    }

    // Need to rewrite setMarker to handle skipReverseGeocode
    function setMarker(lat, lng, skipReverseGeocode = false) {
        selectedLat = lat;
        selectedLng = lng;
        
        if (marker) {
            map.removeLayer(marker);
        }
        
        marker = L.marker([lat, lng], { draggable: true }).addTo(map);
        
        marker.on('dragend', function(e) {
            const pos = e.target.getLatLng();
            selectedLat = pos.lat;
            selectedLng = pos.lng;
            updateLocationDisplay(pos.lat, pos.lng);
            fetchAddressFromCoords(pos.lat, pos.lng); // Always reverse geocode on drag
        });

        updateLocationDisplay(lat, lng);
        if (!skipReverseGeocode) {
            fetchAddressFromCoords(lat, lng);
        }
    }

    function viewOnMap(lat, lng) {
        openAddressModal();
        setTimeout(() => {
            if (map) {
                map.setView([lat, lng], 16);
                setMarker(lat, lng, true); // Skip reverse geocoding when viewing existing address to keep input clean/or just show logic
                // Actually showing existing address name might be better?
            }
        }, 300);
    }

    function confirmLocation() {
        if (selectedLat && selectedLng) {
            showToast('Đã chọn vị trí thành công!', 'success');
            closeMapModal();
        } else {
            showToast('Vui lòng chọn vị trí trên bản đồ', 'error');
        }
    }

    // Toast notifications
    function showToast(message, type = 'success') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            <span>${message}</span>
        `;
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Save functions
    function saveProfile() {
        // Sử dụng FormData để gửi file
        const formData = new FormData();
        formData.append('id', @Model.KhachHang.ID);
        formData.append('hoTen', document.getElementById('hoTen')?.value || '');
        formData.append('soDienThoai', document.getElementById('soDienThoai')?.value || '');
        formData.append('diaChi', document.getElementById('diaChi')?.value || '');

        // Lấy file ảnh nếu có (input file có id="avatarInput")
        // Lấy file ảnh từ input duy nhất (avatarUpload)
        const fileInput = document.getElementById('avatarUpload');
        if (fileInput && fileInput.files.length > 0) {
            formData.append('anhDaiDienFile', fileInput.files[0]);
        }
        
        // Remove old logic checking 2 inputs
        // ...

        fetch('/Customer/UpdateProfile', {
            method: 'POST',
            // Lưu ý: Không set Content-Type header khi dùng FormData, browser sẽ tự set multipart/form-data
            body: formData
        })
        .then(res => res.json())
        .then(result => {
            if (result.success) {
                showToast(result.message, 'success');
                // Cập nhật tên hiển thị trên sidebar
                const nameDisplay = document.querySelector('.user-name');
                if (nameDisplay) {
                     nameDisplay.textContent = document.getElementById('hoTen')?.value;
                }
            } else {
                showToast(result.message || 'Có lỗi xảy ra!', 'error');
            }
        })
        .catch(err => {
            console.error(err);
            showToast('Không thể kết nối đến server!', 'error');
        });
    }

    function saveOptions() {
        showToast('Đã lưu tùy chọn thành công!', 'success');
    }

    // --- Address Functions ---

    function loadAddresses() {
        $.get('/Customer/GetAddresses', function(response) {
            if (response.success) {
                renderAddresses(response.data);
            }
        });
    }

    function renderAddresses(addresses) {
        const container = document.getElementById('addressListContainer');
        if (!container) return;
        
        if (!addresses || addresses.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-map-marker-alt fa-3x mb-3"></i>
                    <p>Bạn chưa lưu địa chỉ nào.</p>
                    <button class="add-address-btn mt-3" onclick="openAddressModal()">
                        <i class="fas fa-plus-circle"></i> Thêm địa chỉ mới
                    </button>
                </div>
            `;
            return;
        }

        let html = '';
        addresses.forEach(addr => {
            const isDefault = addr.macDinh;
            const badge = isDefault ? '<span class="address-default-badge">Mặc định</span>' : '';
            const defaultAction = !isDefault ? `
                <a class="address-action" onclick="setDefaultAddress(${addr.id})">
                    <i class="fas fa-check"></i> Đặt mặc định
                </a>
            ` : '';

            html += `
                <div class="address-card ${isDefault ? 'default' : ''}">
                    <div class="address-icon">
                        <i class="fas ${addr.loaiDiaChi === 'Văn phòng' ? 'fa-building' : 'fa-home'}"></i>
                    </div>
                    <div class="address-info">
                        <div class="address-header">
                            <span class="address-name">${addr.hoTen}</span>
                            <span class="address-phone">| ${addr.soDienThoai}</span>
                            ${badge}
                            <span class="address-type-badge">${addr.loaiDiaChi}</span>
                        </div>
                        <p class="address-text">${addr.diaChi}</p>
                        <div class="address-actions">
                            ${defaultAction}
                            <a class="address-action" onclick="viewOnMap(${addr.kinhDo || 10.8231}, ${addr.viDo || 106.6297})">
                                <i class="fas fa-map-marker-alt"></i> Xem bản đồ
                            </a>
                            <a class="address-action delete" onclick="deleteAddress(${addr.id})">
                                <i class="fas fa-trash"></i> Xóa
                            </a>
                        </div>
                    </div>
                </div>
            `;
        });
        
        // Append Add Button
        html += `
            <button class="add-address-btn" onclick="openAddressModal()">
                <i class="fas fa-plus-circle"></i> Thêm địa chỉ mới
            </button>
        `;

        container.innerHTML = html;
    }

    function setDefaultAddress(id) {
        $.post('/Customer/SetDefaultAddress', { id: id }, function(res) {
            if (res.success) {
                // Update profile textbox
                const diaChiInput = document.getElementById('diaChi');
                if(diaChiInput) diaChiInput.value = res.newAddress;
                
                // Reload list
                loadAddresses();
                showToast('Đã đổi địa chỉ mặc định', 'success');
            } else {
                showToast(res.message, 'error');
            }
        });
    }

    function deleteAddress(id) {
        if(!confirm('Bạn có chắc muốn xóa địa chỉ này?')) return;
        
        $.post('/Customer/DeleteAddress', { id: id }, function(res) {
            if (res.success) {
                loadAddresses();
                showToast('Đã xóa địa chỉ', 'success');
            } else {
                showToast(res.message, 'error');
            }
        });
    }

    // Confirm location from Map Modal -> Save Address
    function confirmLocation() {
        if (!selectedLat || !selectedLng) {
            showToast('Vui lòng chọn vị trí trên bản đồ', 'error');
            return;
        }

        const addressInput = document.getElementById('mapSearchInput'); 
        // Force reading value again to ensure it's fresh
        const addressStr = addressInput ? addressInput.value : '';
        
        // Auto-fill address details from Map result
        // If user wants to edit, they can do it in the prompt or we can skip prompt if addressStr is good enough
        // "khi tới sân vận động rồi khách hàng chọn nhà riêng hay văn phòng thì trên ô text box sẽ thêm các chữ cho địa chỉ chi tiết thật đúng"
        // Interpretation: The `addressStr` from Nominatim is usually full. Maybe just ask for specific building/floor?
        
        const refinedAddress = prompt("Xác nhận địa chỉ chi tiết:", addressStr);
        if (refinedAddress === null) return; 

        // Get Name/Phone from hidden inputs or current user info
        const currentName = document.getElementById('hoTen')?.value || '';
        const currentPhone = document.getElementById('soDienThoai')?.value || '';

        const name = prompt("Tên người nhận:", currentName);
        if (name === null) return;
        
        const phone = prompt("Số điện thoại:", currentPhone);
        if (phone === null) return;

        const type = confirm("Đây là địa chỉ Văn phòng? (OK = Văn phòng, Cancel = Nhà riêng)") ? "Văn phòng" : "Nhà riêng";

        // Prepend Type to Address if desired? The user said "thêm các chữ cho địa chỉ chi tiết". 
        // Or maybe just saving the refined address is enough.
        
        const data = {
            diaChi: refinedAddress,
            hoTen: name,
            soDienThoai: phone,
            kinhDo: selectedLat,
            viDo: selectedLng,
            loaiDiaChi: type,
            macDinh: false 
        };
        
        if(confirm("Đặt làm địa chỉ mặc định?")) {
            data.macDinh = true;
        }

        fetch('/Customer/AddAddress', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(res => {
            if (res.success) {
                closeMapModal();
                loadAddresses();
                if(data.macDinh) {
                     const diaChiInput = document.getElementById('diaChi');
                     if(diaChiInput) diaChiInput.value = refinedAddress;
                }
                showToast('Thêm địa chỉ thành công', 'success');
            } else {
                showToast(res.message, 'error');
            }
        });
    }

    // --- Forward Geocoding (Search Box -> Map) ---
    let searchTimeout;
    let fetchTimeout; // Declared for fetchAddressFromCoords
    const searchInput = document.getElementById('mapSearchInput');
    if(searchInput) {
        searchInput.addEventListener('input', function(e) {
            const query = e.target.value;
            if (query.length < 5) return;
            function fetchAddressFromCoords(lat, lng) {
                if (fetchTimeout) clearTimeout(fetchTimeout);
                
                fetchTimeout = setTimeout(() => {
                    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`;
                    
                    fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        if (data && data.address) {
                            // Construct a detailed address string "Google Maps style"
                            // House Number, Road, Suburb/Neighborhood, City/State
                            const addr = data.address;
                            const parts = [];
                            
                            if (addr.house_number) parts.push(addr.house_number);
                            if (addr.road) parts.push(addr.road);
                            if (addr.hamlet) parts.push(addr.hamlet);
                            if (addr.village) parts.push(addr.village);
                            if (addr.suburb) parts.push(addr.suburb);
                            if (addr.neighbourhood) parts.push(addr.neighbourhood);
                            if (addr.quarter) parts.push(addr.quarter);
                            if (addr.city_district) parts.push(addr.city_district);
                            if (addr.city) parts.push(addr.city);
                            else if (addr.province) parts.push(addr.province);
                            
                            // Filter duplicates and join
                            const fullAddress = [...new Set(parts)].join(", ");
                            
                            // Fallback to display_name if construction failed basically
                            const finalAddress = fullAddress.length > 5 ? fullAddress : data.display_name;

                            const input = document.getElementById('mapSearchInput');
                            if (input) {
                                input.value = finalAddress;
                            }
                        } else if (data && data.display_name) {
                             const input = document.getElementById('mapSearchInput');
                             if (input) input.value = data.display_name;
                        }
                    })
                    .catch(err => console.error('Geocoding error:', err));
                }, 500); // Shorter debounce
            }

            if (searchTimeout) clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
                
                fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lon = parseFloat(data[0].lon);
                        
                        if (map) {
                            map.flyTo([lat, lon], 16);
                            setMarker(lat, lon); // Update marker and selected location
                            // Note: setMarker calls fetchAddressFromCoords which might overwrite input? 
                            // We should probably pass a flag to setMarker to skip reverse geocode if triggered by search
                        }
                    }
                })
                .catch(err => console.error('Geocoding error:', err));
            }, 1000);
        });
    }

    // Updated setMarker to accept skipReverseGeocode flag
    const originalSetMarker = setMarker; // Store old if needed, but easier to rewrite


    // Load addresses on switch to tab
    document.querySelectorAll('.nav-item[data-tab="address"]').forEach(item => {
        item.addEventListener('click', function() {
            loadAddresses();
        });
    });

    // Check if initial tab is address (if url has hash)
    if(window.location.hash === '#address') {
        loadAddresses();
    }


    // Change Password Form
    document.getElementById('changePassForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        const form = this;
        const matKhauMoi = form.querySelector('[name="MatKhauMoi"]').value;
        const xacNhan = form.querySelector('[name="XacNhanMatKhau"]').value;
        
        if (matKhauMoi !== xacNhan) {
            showToast('Mật khẩu xác nhận không khớp!', 'error');
            return;
        }

        // AJAX call
        // AJAX call
        const btn = form.querySelector('button[type="submit"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
        btn.disabled = true;

        fetch('@Url.Action("ChangePassword", "Customer")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
            },
            body: new URLSearchParams(new FormData(form))
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    title: 'Thành công!',
                    text: 'Đổi mật khẩu thành công. Vui lòng đăng nhập lại.',
                    icon: 'success',
                    confirmButtonText: 'OK'
                }).then(() => {
                    // Optional: Logout or redirect
                     window.location.reload();
                });
                form.reset();
            } else {
                Swal.fire({
                    title: 'Lỗi!',
                    html: data.message || 'Có lỗi xảy ra!',
                    icon: 'error'
                });
            }
        })
        .catch(() => {
            showToast('Không thể kết nối đến server!', 'error');
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    });

    // Toggle Password Visibility
    function togglePassword(inputId, iconContainer) {
        const input = document.getElementById(inputId);
        const icon = iconContainer.querySelector('i');
        
        if (input.type === "password") {
            input.type = "text";
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = "password";
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }
</script>

@functions {
    public string GetStatusColor(string status)
    {
        return status switch
        {
            "Moi" => "#3b82f6",
            "Chờ xử lý" => "#f59e0b",
            "DaGiao" => "#10b981",
            "Huy" => "#ef4444",
            _ => "#6b7280"
        };
    }
}