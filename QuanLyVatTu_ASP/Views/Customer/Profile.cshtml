@model QuanLyVatTu_ASP.Models.ViewModels.ProfileViewModel
@{
    ViewData["Title"] = "Tài khoản của tôi - QLVT";
    Layout = "~/Views/Shared/_Layout_Customer.cshtml";
}

<div class="profile-page">
    <div class="container">
        <div class="page-header">
            <h1>Tài khoản của tôi</h1>
            <p>Quản lý thông tin tài khoản và đơn hàng</p>
        </div>

        <div class="profile-content">
            <!-- Sidebar -->
            <div class="profile-sidebar">
                <div class="user-info-card">
                    <div class="user-avatar">
                        <div class="avatar-placeholder">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="user-details">
                            <h3>@Model.KhachHang.HoTen</h3>
                            <p>Thành viên từ @Model.KhachHang.NgayTao.ToString("MM/yyyy")</p>
                            <p class="member-id">Mã KH: @Model.KhachHang.MaHienThi</p>
                            @if (Model.KhachHang.DangNhapGoogle)
                            {
                                <span class="google-badge">
                                    <i class="fab fa-google"></i> Đăng nhập bằng Google
                                </span>
                            }
                        </div>
                    </div>
                    
                    <div class="user-stats">
                        <div class="stat-item">
                            <div class="stat-number">@Model.SoDonHang</div>
                            <div class="stat-label">Đơn hàng</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">@Model.TongTienMua.ToString("N0")đ</div>
                            <div class="stat-label">Tổng chi tiêu</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">@Model.SoSanPhamDaMua</div>
                            <div class="stat-label">Sản phẩm</div>
                        </div>
                    </div>
                </div>

                <nav class="profile-nav">
                    <a href="#profile" class="nav-link active" data-tab="profile">
                        <i class="fas fa-user"></i>
                        <span>Thông tin tài khoản</span>
                    </a>
                    <a href="#orders" class="nav-link" data-tab="orders">
                        <i class="fas fa-shopping-bag"></i>
                        <span>Đơn hàng của tôi (@Model.SoDonHang)</span>
                    </a>
                    <a href="#address" class="nav-link" data-tab="address">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Địa chỉ giao hàng</span>
                    </a>
                    @if (!Model.KhachHang.DangNhapGoogle)
                    {
                        <a href="#password" class="nav-link" data-tab="password">
                            <i class="fas fa-lock"></i>
                            <span>Đổi mật khẩu</span>
                        </a>
                    }
                    <a href="@Url.Action("Logout", "Customer")" class="nav-link logout">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Đăng xuất</span>
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="profile-main">
                <!-- Tab 1: Profile Information -->
                <div class="tab-content active" id="profile">
                    <div class="tab-header">
                        <h2>Thông tin tài khoản</h2>
                        <p>Quản lý thông tin cá nhân của bạn</p>
                    </div>
                    
                    <div class="profile-form-container">
                        <form id="profileForm">
                            @Html.AntiForgeryToken()
                            <input type="hidden" id="customerId" value="@Model.KhachHang.ID">
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="hoTen">Họ và tên *</label>
                                    <input type="text" id="hoTen" name="HoTen" 
                                           value="@Model.KhachHang.HoTen" required
                                           placeholder="Nhập họ và tên">
                                    <div class="error-message" id="hoTenError"></div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="email">Email *</label>
                                    <input type="email" id="email" name="Email" 
                                           value="@Model.KhachHang.Email" required
                                           placeholder="Nhập địa chỉ email">
                                    <div class="error-message" id="emailError"></div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="soDienThoai">Số điện thoại</label>
                                    <input type="tel" id="soDienThoai" name="SoDienThoai" 
                                           value="@Model.KhachHang.SoDienThoai"
                                           placeholder="Nhập số điện thoại">
                                    <div class="error-message" id="soDienThoaiError"></div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="taiKhoan">Tài khoản đăng nhập</label>
                                    <input type="text" id="taiKhoan" 
                                           value="@Model.KhachHang.TaiKhoan" readonly
                                           class="readonly-field"
                                           title="Tài khoản không thể thay đổi">
                                    <small class="field-note">Tài khoản không thể thay đổi</small>
                                </div>
                                
                                <div class="form-group full-width">
                                    <label for="diaChi">Địa chỉ</label>
                                    <textarea id="diaChi" name="DiaChi" rows="3" 
                                              placeholder="Nhập địa chỉ của bạn">@Model.KhachHang.DiaChi</textarea>
                                    <div class="error-message" id="diaChiError"></div>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn-primary" id="updateProfileBtn">
                                    <i class="fas fa-save"></i>
                                    Cập nhật thông tin
                                </button>
                                <div class="success-message" id="profileSuccess" style="display:none;"></div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Tab 2: Orders -->
                <div class="tab-content" id="orders">
                    <div class="tab-header">
                        <h2>Đơn hàng của tôi</h2>
                        <p>Xem và theo dõi đơn hàng của bạn</p>
                    </div>
                    
                    <div class="orders-list">
                        @if (Model.DonHangs.Any())
                        {
                            foreach (var order in Model.DonHangs)
                            {
                                <div class="order-card">
                                    <div class="order-header">
                                        <div class="order-info">
                                            <h4>Đơn hàng @order.MaHienThi</h4>
                                            <span class="order-date">
                                                <i class="far fa-calendar"></i>
                                                Đặt ngày: @order.NgayDat.ToString("dd/MM/yyyy HH:mm")
                                            </span>
                                            @if (order.NgayDatCoc.HasValue)
                                            {
                                                <span class="order-date">
                                                    <i class="far fa-calendar-check"></i>
                                                    Đặt cọc: @order.NgayDatCoc.Value.ToString("dd/MM/yyyy")
                                                </span>
                                            }
                                        </div>
                                        <div class="order-status">
                                            <span class="status-badge @GetStatusClass(order.TrangThai)">
                                                @order.TrangThai
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="order-summary">
                                        <div class="summary-row">
                                            <div class="summary-item">
                                                <span class="summary-label">Tổng tiền:</span>
                                                <span class="summary-value">@order.TongTien.ToString("N0")đ</span>
                                            </div>
                                            @if (order.SoTienDatCoc.HasValue && order.SoTienDatCoc > 0)
                                            {
                                                <div class="summary-item">
                                                    <span class="summary-label">Tiền đặt cọc:</span>
                                                    <span class="summary-value">@order.SoTienDatCoc.Value.ToString("N0")đ</span>
                                                </div>
                                            }
                                        </div>
                                        
                                        @if (!string.IsNullOrEmpty(order.PhuongThucDatCoc))
                                        {
                                            <div class="summary-item">
                                                <span class="summary-label">Phương thức đặt cọc:</span>
                                                <span class="summary-value">@order.PhuongThucDatCoc</span>
                                            </div>
                                        }
                                        
                                        @if (!string.IsNullOrEmpty(order.GhiChu))
                                        {
                                            <div class="summary-item">
                                                <span class="summary-label">Ghi chú:</span>
                                                <p class="summary-note">@order.GhiChu</p>
                                            </div>
                                        }
                                    </div>
                                    
                                    <div class="order-footer">
                                        <div class="order-total">
                                            <span>Cần thanh toán:</span>
                                            @{
                                                var canThanhToan = order.TongTien - (order.SoTienDatCoc ?? 0);
                                            }
                                            <span class="total-price">@canThanhToan.ToString("N0")đ</span>
                                        </div>
                                        <div class="order-actions">
                                            @if (order.TrangThai == "Chờ xác nhận" || order.TrangThai == "Đang xử lý")
                                            {
                                                <button class="btn-outline cancel-order" data-order-id="@order.ID">
                                                    Hủy đơn
                                                </button>
                                            }
                                            @if (order.TrangThai == "Đã giao hàng")
                                            {
                                                <button class="btn-primary" onclick="window.location.href='@Url.Action("CreateReview", "Customer", new { orderId = order.ID })'">
                                                    <i class="fas fa-star"></i> Đánh giá
                                                </button>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <i class="fas fa-shopping-bag"></i>
                                </div>
                                <h3>Chưa có đơn hàng nào</h3>
                                <p>Bạn chưa mua sản phẩm nào từ cửa hàng của chúng tôi</p>
                                <a asp-controller="Customer" asp-action="Categories" class="btn-primary">Mua sắm ngay</a>
                            </div>
                        }
                    </div>
                </div>

                <!-- Tab 3: Address -->
                <div class="tab-content" id="address">
                    <div class="tab-header">
                        <h2>Địa chỉ giao hàng</h2>
                        <p>Quản lý địa chỉ nhận hàng của bạn</p>
                    </div>
                    
                    <div class="address-list">
                        <div class="address-card @(string.IsNullOrEmpty(Model.KhachHang.DiaChi) ? "" : "primary")">
                            <div class="address-header">
                                <h4>Địa chỉ mặc định</h4>
                                @if (!string.IsNullOrEmpty(Model.KhachHang.DiaChi))
                                {
                                    <span class="badge-primary">Mặc định</span>
                                }
                            </div>
                            <div class="address-details">
                                <p><strong>@Model.KhachHang.HoTen</strong></p>
                                <p>@Model.KhachHang.SoDienThoai</p>
                                <p>@(string.IsNullOrEmpty(Model.KhachHang.DiaChi) ? "Chưa có địa chỉ" : Model.KhachHang.DiaChi)</p>
                            </div>
                            <div class="address-actions">
                                <button class="btn-edit" onclick="editAddress()">
                                    <i class="fas fa-edit"></i> Sửa
                                </button>
                                @if (!string.IsNullOrEmpty(Model.KhachHang.DiaChi))
                                {
                                    <button class="btn-delete">
                                        <i class="fas fa-trash"></i> Xóa
                                    </button>
                                }
                            </div>
                        </div>
                        
                        <button class="btn-add-address">
                            <i class="fas fa-plus"></i>
                            Thêm địa chỉ mới
                        </button>
                    </div>
                </div>

                <!-- Tab 4: Change Password (chỉ hiển thị nếu không đăng nhập bằng Google) -->
                @if (!Model.KhachHang.DangNhapGoogle)
                {
                    <div class="tab-content" id="password">
                        <div class="tab-header">
                            <h2>Đổi mật khẩu</h2>
                            <p>Cập nhật mật khẩu để bảo vệ tài khoản</p>
                        </div>
                        
                        <div class="password-form">
                            <form id="passwordForm">
                                @Html.AntiForgeryToken()
                                <input type="hidden" id="customerId" value="@Model.KhachHang.ID">
                                
                                <div class="form-group">
                                    <label for="currentPassword">Mật khẩu hiện tại *</label>
                                    <input type="password" id="currentPassword" name="MatKhauCu" required
                                           placeholder="Nhập mật khẩu hiện tại">
                                    <div class="error-message" id="currentPasswordError"></div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="newPassword">Mật khẩu mới *</label>
                                    <input type="password" id="newPassword" name="MatKhauMoi" required
                                           placeholder="Nhập mật khẩu mới (ít nhất 6 ký tự)">
                                    <div class="error-message" id="newPasswordError"></div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="confirmPassword">Xác nhận mật khẩu mới *</label>
                                    <input type="password" id="confirmPassword" name="XacNhanMatKhauMoi" required
                                           placeholder="Nhập lại mật khẩu mới">
                                    <div class="error-message" id="confirmPasswordError"></div>
                                </div>
                                
                                <div class="form-actions">
                                    <button type="submit" class="btn-primary" id="changePasswordBtn">
                                        <i class="fas fa-key"></i>
                                        Đổi mật khẩu
                                    </button>
                                    <div class="success-message" id="passwordSuccess" style="display:none;"></div>
                                </div>
                            </form>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@functions {
    public string GetStatusClass(string status)
    {
        if (string.IsNullOrEmpty(status))
            return "status-unknown";
            
        return status.ToLower() switch
        {
            "chờ xác nhận" => "status-pending",
            "đã xác nhận" => "status-confirmed",
            "đang xử lý" => "status-processing",
            "đang giao hàng" => "status-shipped",
            "đã giao hàng" => "status-delivered",
            "đã hủy" => "status-cancelled",
            "hoàn thành" => "status-completed",
            _ => "status-unknown"
        };
    }
}

@section Styles {
    <link rel="stylesheet" href="~/user/css/profile.css" />
    <style>
        .order-summary {
            padding: 20px;
            background-color: #f9fafb;
            border-top: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .summary-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .summary-item {
            flex: 1;
            min-width: 200px;
        }
        
        .summary-label {
            display: block;
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 4px;
        }
        
        .summary-value {
            display: block;
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
        }
        
        .summary-note {
            background-color: white;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #2563eb;
            margin-top: 8px;
            color: #4b5563;
            font-size: 0.9375rem;
            line-height: 1.5;
        }
        
        .order-date {
            display: block;
            color: #6b7280;
            font-size: 0.875rem;
            margin-top: 4px;
        }
        
        .order-date i {
            margin-right: 5px;
            width: 16px;
            text-align: center;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }
        
        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: #92400e;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .status-confirmed {
            background: rgba(37, 99, 235, 0.1);
            color: #1e40af;
            border: 1px solid rgba(37, 99, 235, 0.2);
        }
        
        .status-processing {
            background: rgba(59, 130, 246, 0.1);
            color: #1d4ed8;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .status-shipped {
            background: rgba(124, 58, 237, 0.1);
            color: #5b21b6;
            border: 1px solid rgba(124, 58, 237, 0.2);
        }
        
        .status-delivered {
            background: rgba(16, 185, 129, 0.1);
            color: #065f46;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        .status-cancelled {
            background: rgba(239, 68, 68, 0.1);
            color: #991b1b;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        .status-completed {
            background: rgba(139, 92, 246, 0.1);
            color: #5b21b6;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }
        
        .status-unknown {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #e5e7eb;
        }
        
        .order-total {
            font-size: 1.125rem;
        }
        
        .order-total span:first-child {
            color: #6b7280;
            font-weight: 500;
        }
        
        .total-price {
            font-size: 1.25rem;
            font-weight: 700;
            color: #2563eb;
            margin-left: 10px;
        }
    </style>
}
@section Scripts {
    <script src="~/user/js/profile.js"></script>
}