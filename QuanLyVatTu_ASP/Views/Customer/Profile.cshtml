@using QuanLyVatTu_ASP.Models.ViewModels
@model ProfileViewModel
@{
    ViewData["Title"] = "Tài khoản của tôi";
    Layout = "~/Views/Shared/_Layout_Customer.cshtml";
}

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Leaflet CSS for Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Profile CSS -->
<link rel="stylesheet" href="~/user/css/profile-new.css" asp-append-version="true" />

<div class="profile-page-new">
    <div class="profile-container">
        
        <!-- Breadcrumb -->
        <nav class="profile-breadcrumb">
            <a href="/">Trang chủ</a>
            <span class="separator"><i class="fas fa-chevron-right"></i></span>
            <span class="current">Tài khoản của tôi</span>
        </nav>

        <div class="profile-layout">
            
            <!-- SIDEBAR -->
            <aside class="profile-sidebar">
                
                <!-- User Card -->
                <div class="sidebar-user-card">
                    <div class="user-avatar-wrapper">
                        <img src="https://i.pravatar.cc/150?img=12" alt="Avatar" class="user-avatar" id="userAvatar">
                        <label for="avatarUpload" class="avatar-edit-btn">
                            <i class="fas fa-camera"></i>
                        </label>
                        <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
                    </div>
                    <h3 class="user-name">@Model.KhachHang.HoTen</h3>
                    <p class="user-email">@Model.KhachHang.Email</p>
                    <div class="user-stats">
                        <div class="stat-item">
                            <div class="stat-value">@Model.SoDonHang</div>
                            <div class="stat-label">Đơn hàng</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">@Model.TongTienMua.ToString("N0")đ</div>
                            <div class="stat-label">Tổng chi</div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Menu -->
                <nav class="sidebar-nav">
                    <!-- Tài khoản của tôi -->
                    <div class="nav-group">
                        <div class="nav-group-title">
                            <i class="fas fa-user-circle"></i>
                            Tài khoản của tôi
                        </div>
                        <a href="#profile" class="nav-item active" data-tab="profile">
                            <i class="fas fa-user"></i>
                            Hồ sơ
                        </a>
                        <a href="#address" class="nav-item" data-tab="address">
                            <i class="fas fa-map-marker-alt"></i>
                            Địa chỉ giao hàng
                        </a>
                        <a href="#password" class="nav-item" data-tab="password">
                            <i class="fas fa-lock"></i>
                            Đổi mật khẩu
                        </a>
                    </div>

                    <!-- Đơn hàng vật tư -->
                    <div class="nav-group">
                        <div class="nav-group-title">
                            <i class="fas fa-box"></i>
                            Đơn hàng vật tư
                        </div>
                        <a href="#orders" class="nav-item" data-tab="orders">
                            <i class="fas fa-shopping-bag"></i>
                            Đơn hàng của tôi
                            @if(Model.SoDonHang > 0) {
                                <span class="badge">@Model.SoDonHang</span>
                            }
                        </a>
                        <a href="#quotes" class="nav-item" data-tab="quotes">
                            <i class="fas fa-file-invoice"></i>
                            Yêu cầu báo giá
                        </a>
                        <a href="#history" class="nav-item" data-tab="history">
                            <i class="fas fa-history"></i>
                            Lịch sử mua hàng
                        </a>
                    </div>

                    <!-- Tài chính -->
                    <div class="nav-group">
                        <div class="nav-group-title">
                            <i class="fas fa-wallet"></i>
                            Tài chính
                        </div>
                        <a href="#debt" class="nav-item" data-tab="debt">
                            <i class="fas fa-money-bill-wave"></i>
                            Công nợ
                        </a>
                        <a href="#invoice" class="nav-item" data-tab="invoice">
                            <i class="fas fa-file-invoice-dollar"></i>
                            Hóa đơn VAT
                        </a>
                    </div>

                    <!-- Thông báo -->
                    <div class="nav-group">
                        <div class="nav-group-title">
                            <i class="fas fa-bell"></i>
                            Thông báo
                        </div>
                        <a href="#notifications" class="nav-item" data-tab="notifications">
                            <i class="fas fa-envelope"></i>
                            Thông báo hệ thống
                        </a>
                        <a href="#promotions" class="nav-item" data-tab="promotions">
                            <i class="fas fa-tags"></i>
                            Ưu đãi & Khuyến mãi
                        </a>
                    </div>

                    <!-- Cài đặt -->
                    <div class="nav-group">
                        <div class="nav-group-title">
                            <i class="fas fa-cog"></i>
                            Cài đặt
                        </div>
                        <a href="#settings" class="nav-item" data-tab="settings">
                            <i class="fas fa-sliders-h"></i>
                            Cài đặt thông báo
                        </a>
                        <a href="#privacy" class="nav-item" data-tab="privacy">
                            <i class="fas fa-shield-alt"></i>
                            Quyền riêng tư
                        </a>
                    </div>

                    <!-- Logout -->
                    <a href="@Url.Action("Logout", "Account")" class="nav-item logout">
                        <i class="fas fa-sign-out-alt"></i>
                        Đăng xuất
                    </a>
                </nav>
            </aside>

            <!-- MAIN CONTENT -->
            <main class="profile-content">
                
                <!-- TAB: HỒ SƠ -->
                <section class="tab-panel active" id="tab-profile">
                    <div class="content-card">
                        <div class="card-header">
                            <div class="card-header-left">
                                <h2 class="card-title">Hồ sơ của tôi</h2>
                                <p class="card-subtitle">Quản lý thông tin hồ sơ để bảo mật tài khoản</p>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="profile-form-grid">
                                <div class="form-fields">
                                    <!-- Họ và tên -->
                                    <div class="form-group">
                                        <label class="form-label">Họ và tên <span class="required">*</span></label>
                                        <input type="text" class="form-input" id="hoTen" value="@Model.KhachHang.HoTen" placeholder="Nhập họ tên">
                                    </div>

                                    <!-- Email & Phone -->
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Email <span class="required">*</span></label>
                                            <div class="input-with-badge">
                                                <input type="email" class="form-input" value="@Model.KhachHang.Email" disabled style="padding-right: 140px;">
                                                <div class="input-badge">
                                                    <span class="verified-badge"><i class="fas fa-check-circle"></i> Đã xác thực</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Số điện thoại <span class="required">*</span></label>
                                            <div class="input-with-badge">
                                                <input type="tel" class="form-input" id="soDienThoai" value="@Model.KhachHang.SoDienThoai" style="padding-right: 140px;">
                                                <div class="input-badge">
                                                    <span class="verified-badge"><i class="fas fa-check-circle"></i> Đã xác thực</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Giới tính -->
                                    <div class="form-group">
                                        <label class="form-label">Giới tính</label>
                                        <div class="gender-options">
                                            <label class="gender-option">
                                                <input type="radio" name="gioiTinh" value="nam" checked>
                                                <span>Nam</span>
                                            </label>
                                            <label class="gender-option">
                                                <input type="radio" name="gioiTinh" value="nu">
                                                <span>Nữ</span>
                                            </label>
                                            <label class="gender-option">
                                                <input type="radio" name="gioiTinh" value="khac">
                                                <span>Khác</span>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Ngày sinh -->
                                    <div class="form-group">
                                        <label class="form-label">Ngày sinh</label>
                                        <input type="date" class="form-input" id="ngaySinh" value="1985-03-15">
                                    </div>

                                    <!-- Công ty -->
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Công ty/Tổ chức</label>
                                            <input type="text" class="form-input" id="congTy" value="Công ty TNHH Xây Dựng ABC" placeholder="Tên công ty (nếu có)">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Chức vụ</label>
                                            <select class="form-select" id="chucVu">
                                                <option value="">-- Chọn chức vụ --</option>
                                                <option value="chudoanhnghiep">Chủ doanh nghiệp</option>
                                                <option value="giamdoc">Giám đốc</option>
                                                <option value="quanlykho" selected>Quản lý kho</option>
                                                <option value="nhanvienmuahang">Nhân viên mua hàng</option>
                                                <option value="kythuat">Kỹ thuật</option>
                                                <option value="khac">Khác</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- MST -->
                                    <div class="form-group">
                                        <label class="form-label">Mã số thuế</label>
                                        <input type="text" class="form-input" id="maSoThue" value="0123456789" placeholder="MST công ty (nếu có)">
                                    </div>

                                    <button type="button" class="btn-primary" onclick="saveProfile()">
                                        <i class="fas fa-save"></i>
                                        Lưu thay đổi
                                    </button>
                                </div>

                                <!-- Avatar Upload Section -->
                                <div class="avatar-upload-section">
                                    <img src="https://i.pravatar.cc/150?img=12" alt="Avatar" class="avatar-preview" id="avatarPreview">
                                    <label for="avatarInput" class="upload-btn">
                                        <i class="fas fa-upload"></i>
                                        Chọn ảnh
                                    </label>
                                    <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                                    <div class="upload-hint">
                                        Dung lượng tối đa 1MB<br>
                                        Định dạng: .JPG, .PNG
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- TAB: ĐỊA CHỈ GIAO HÀNG -->
                <section class="tab-panel" id="tab-address" style="display: none;">
                    <div class="content-card">
                        <div class="card-header">
                            <div class="card-header-left">
                                <h2 class="card-title">Địa chỉ giao hàng</h2>
                                <p class="card-subtitle">Quản lý địa chỉ nhận hàng của bạn</p>
                            </div>
                            <button class="btn-primary" onclick="openAddressModal()">
                                <i class="fas fa-plus"></i>
                                Thêm địa chỉ mới
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="address-list">
                                <!-- Address 1 - Default -->
                                <div class="address-card default">
                                    <div class="address-icon">
                                        <i class="fas fa-building"></i>
                                    </div>
                                    <div class="address-info">
                                        <div class="address-header">
                                            <span class="address-name">Nguyễn Văn An</span>
                                            <span class="address-phone">| 0987654321</span>
                                            <span class="address-default-badge">Mặc định</span>
                                            <span class="address-type-badge">Công ty</span>
                                        </div>
                                        <p class="address-text">
                                            123 Đường Lê Văn Việt, Phường Tăng Nhơn Phú A, Quận 9, Thành phố Hồ Chí Minh
                                        </p>
                                        <div class="address-actions">
                                            <a class="address-action" onclick="editAddress(1)">
                                                <i class="fas fa-edit"></i> Sửa
                                            </a>
                                            <a class="address-action" onclick="viewOnMap(10.8507, 106.7789)">
                                                <i class="fas fa-map-marker-alt"></i> Xem trên bản đồ
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <!-- Address 2 -->
                                <div class="address-card">
                                    <div class="address-icon">
                                        <i class="fas fa-warehouse"></i>
                                    </div>
                                    <div class="address-info">
                                        <div class="address-header">
                                            <span class="address-name">Trần Văn B</span>
                                            <span class="address-phone">| 0912345678</span>
                                            <span class="address-type-badge">Kho hàng</span>
                                        </div>
                                        <p class="address-text">
                                            456 Xa lộ Hà Nội, Phường Hiệp Phú, Quận 9, Thành phố Hồ Chí Minh
                                        </p>
                                        <div class="address-actions">
                                            <a class="address-action" onclick="editAddress(2)">
                                                <i class="fas fa-edit"></i> Sửa
                                            </a>
                                            <a class="address-action" onclick="setDefaultAddress(2)">
                                                <i class="fas fa-check"></i> Đặt mặc định
                                            </a>
                                            <a class="address-action" onclick="viewOnMap(10.8412, 106.7856)">
                                                <i class="fas fa-map-marker-alt"></i> Xem trên bản đồ
                                            </a>
                                            <a class="address-action delete" onclick="deleteAddress(2)">
                                                <i class="fas fa-trash"></i> Xóa
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <!-- Add New Address Button -->
                                <button class="add-address-btn" onclick="openAddressModal()">
                                    <i class="fas fa-plus-circle"></i>
                                    Thêm địa chỉ mới
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tùy chọn mua hàng -->
                    <div class="content-card" style="margin-top: 24px;">
                        <div class="card-header">
                            <div class="card-header-left">
                                <h2 class="card-title">Tùy chọn mua hàng</h2>
                                <p class="card-subtitle">Thiết lập tùy chọn giao nhận phù hợp với bạn</p>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="options-grid">
                                <!-- Phương thức nhận hàng -->
                                <div class="option-group">
                                    <h4 class="option-group-title">Phương thức nhận hàng ưu tiên</h4>
                                    <div class="radio-group">
                                        <label class="radio-option selected">
                                            <input type="radio" name="phuongThucNhan" value="giaotannoi" checked>
                                            <span>🚚 Giao hàng tận nơi</span>
                                        </label>
                                        <label class="radio-option">
                                            <input type="radio" name="phuongThucNhan" value="nhantaikho">
                                            <span>🏪 Nhận tại kho</span>
                                        </label>
                                        <label class="radio-option">
                                            <input type="radio" name="phuongThucNhan" value="dinhky">
                                            <span>📅 Giao theo lịch định kỳ</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Thời gian giao hàng -->
                                <div class="option-group">
                                    <h4 class="option-group-title">Thời gian giao hàng mong muốn</h4>
                                    <select class="form-select">
                                        <option value="sang" selected>Buổi sáng (7h - 12h)</option>
                                        <option value="chieu">Buổi chiều (13h - 18h)</option>
                                        <option value="linhhoat">Linh hoạt</option>
                                    </select>
                                </div>

                                <!-- Yêu cầu đặc biệt -->
                                <div class="option-group">
                                    <h4 class="option-group-title">Yêu cầu đặc biệt</h4>
                                    <div class="checkbox-group">
                                        <label class="checkbox-option">
                                            <input type="checkbox" checked>
                                            <span>📋 Cần hóa đơn VAT</span>
                                        </label>
                                        <label class="checkbox-option">
                                            <input type="checkbox" checked>
                                            <span>📄 Yêu cầu CO/CQ cho vật tư</span>
                                        </label>
                                        <label class="checkbox-option">
                                            <input type="checkbox" checked>
                                            <span>🔔 Nhận thông báo khuyến mãi</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Hạn mức công nợ -->
                                <div class="option-group">
                                    <h4 class="option-group-title">Hạn mức công nợ</h4>
                                    <div class="credit-limit-section">
                                        <div class="credit-header">
                                            <span class="credit-label">Hạn mức tối đa</span>
                                            <span class="credit-value">50.000.000đ</span>
                                        </div>
                                        <div class="credit-progress">
                                            <div class="credit-progress-bar" style="width: 30%;"></div>
                                        </div>
                                        <div class="credit-stats">
                                            <span>Đã sử dụng: 15.000.000đ</span>
                                            <span>Còn lại: 35.000.000đ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button type="button" class="btn-primary" style="margin-top: 24px;" onclick="saveOptions()">
                                <i class="fas fa-save"></i>
                                Lưu tùy chọn
                            </button>
                        </div>
                    </div>
                </section>

                <!-- TAB: ĐỔI MẬT KHẨU -->
                <section class="tab-panel" id="tab-password" style="display: none;">
                    <div class="content-card">
                        <div class="card-header">
                            <div class="card-header-left">
                                <h2 class="card-title">Đổi mật khẩu</h2>
                                <p class="card-subtitle">Cập nhật mật khẩu để bảo mật tài khoản</p>
                            </div>
                        </div>
                        <div class="card-body">
                            <form id="changePassForm" style="max-width: 500px;">
                                <input type="hidden" name="Id" value="@Model.KhachHang.ID" />
                                <div class="form-group" style="margin-bottom: 20px;">
                                    <label class="form-label">Mật khẩu hiện tại <span class="required">*</span></label>
                                    <input type="password" class="form-input" name="MatKhauCu" required placeholder="Nhập mật khẩu hiện tại">
                                </div>
                                <div class="form-group" style="margin-bottom: 20px;">
                                    <label class="form-label">Mật khẩu mới <span class="required">*</span></label>
                                    <input type="password" class="form-input" name="MatKhauMoi" required placeholder="Nhập mật khẩu mới">
                                </div>
                                <div class="form-group" style="margin-bottom: 24px;">
                                    <label class="form-label">Xác nhận mật khẩu mới <span class="required">*</span></label>
                                    <input type="password" class="form-input" name="XacNhanMatKhau" required placeholder="Nhập lại mật khẩu mới">
                                </div>
                                <button type="submit" class="btn-primary">
                                    <i class="fas fa-lock"></i>
                                    Cập nhật mật khẩu
                                </button>
                            </form>
                        </div>
                    </div>
                </section>

                <!-- TAB: ĐƠN HÀNG -->
                <section class="tab-panel" id="tab-orders" style="display: none;">
                    <div class="content-card">
                        <div class="card-header">
                            <div class="card-header-left">
                                <h2 class="card-title">Đơn hàng của tôi</h2>
                                <p class="card-subtitle">Theo dõi và quản lý đơn hàng</p>
                            </div>
                        </div>
                        <div class="card-body">
                            @if (Model.DonHangs != null && Model.DonHangs.Any())
                            {
                                foreach (var order in Model.DonHangs)
                                {
                                    <div class="address-card" style="margin-bottom: 16px;">
                                        <div class="address-icon" style="background: #dbeafe;">
                                            <i class="fas fa-box" style="color: #3b82f6;"></i>
                                        </div>
                                        <div class="address-info">
                                            <div class="address-header">
                                                <span class="address-name">Đơn hàng #@order.ID</span>
                                                <span class="address-phone">| @order.NgayDat.ToString("dd/MM/yyyy HH:mm")</span>
                                                <span class="address-type-badge" style="background: @GetStatusColor(order.TrangThai); color: white;">@order.TrangThai</span>
                                            </div>
                                            <p class="address-text" style="margin-bottom: 8px;">
                                                <strong style="color: #111827;">Tổng tiền: <span style="color: #ef4444;">@(order.TongTien?.ToString("N0") ?? "0")đ</span></strong>
                                            </p>
                                            @if (order.ChiTietDonHangs != null)
                                            {
                                                <div style="background: #f9fafb; padding: 12px; border-radius: 8px; font-size: 0.85rem;">
                                                    @foreach (var ct in order.ChiTietDonHangs)
                                                    {
                                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                                            <span style="color: #4b5563;">@ct.VatTu?.TenVatTu x @ct.SoLuong</span>
                                                            <span style="color: #111827; font-weight: 500;">@ct.ThanhTien.ToString("N0")đ</span>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div style="text-align: center; padding: 60px 20px; color: #6b7280;">
                                    <i class="fas fa-shopping-bag" style="font-size: 4rem; color: #e5e7eb; margin-bottom: 16px;"></i>
                                    <p style="margin-bottom: 16px;">Bạn chưa có đơn hàng nào.</p>
                                    <a href="/SanPham" class="btn-primary">
                                        <i class="fas fa-shopping-cart"></i>
                                        Mua sắm ngay
                                    </a>
                                </div>
                            }
                        </div>
                    </div>
                </section>

                <!-- Placeholder tabs -->
                <section class="tab-panel" id="tab-quotes" style="display: none;">
                    <div class="content-card">
                        <div class="card-header">
                            <h2 class="card-title">Yêu cầu báo giá</h2>
                        </div>
                        <div class="card-body" style="text-align: center; padding: 60px;">
                            <i class="fas fa-file-invoice" style="font-size: 4rem; color: #e5e7eb;"></i>
                            <p style="color: #6b7280; margin-top: 16px;">Chức năng đang được phát triển</p>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" id="tab-history" style="display: none;">
                    <div class="content-card">
                        <div class="card-header">
                            <h2 class="card-title">Lịch sử mua hàng</h2>
                        </div>
                        <div class="card-body" style="text-align: center; padding: 60px;">
                            <i class="fas fa-history" style="font-size: 4rem; color: #e5e7eb;"></i>
                            <p style="color: #6b7280; margin-top: 16px;">Xem chi tiết tại tab "Đơn hàng của tôi"</p>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" id="tab-debt" style="display: none;">
                    <div class="content-card">
                        <div class="card-header">
                            <h2 class="card-title">Công nợ</h2>
                        </div>
                        <div class="card-body">
                            <div class="credit-limit-section" style="max-width: 500px;">
                                <div class="credit-header">
                                    <span class="credit-label">Công nợ hiện tại</span>
                                    <span class="credit-value" style="color: #ef4444;">15.000.000đ</span>
                                </div>
                                <div class="credit-progress">
                                    <div class="credit-progress-bar" style="width: 30%; background: linear-gradient(90deg, #ef4444, #f59e0b);"></div>
                                </div>
                                <div class="credit-stats">
                                    <span>Hạn mức: 50.000.000đ</span>
                                    <span>Còn được mua: 35.000.000đ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" id="tab-invoice" style="display: none;">
                    <div class="content-card">
                        <div class="card-header">
                            <h2 class="card-title">Hóa đơn VAT</h2>
                        </div>
                        <div class="card-body" style="text-align: center; padding: 60px;">
                            <i class="fas fa-file-invoice-dollar" style="font-size: 4rem; color: #e5e7eb;"></i>
                            <p style="color: #6b7280; margin-top: 16px;">Chưa có hóa đơn VAT nào</p>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" id="tab-notifications" style="display: none;">
                    <div class="content-card">
                        <div class="card-header">
                            <h2 class="card-title">Thông báo hệ thống</h2>
                        </div>
                        <div class="card-body" style="text-align: center; padding: 60px;">
                            <i class="fas fa-bell" style="font-size: 4rem; color: #e5e7eb;"></i>
                            <p style="color: #6b7280; margin-top: 16px;">Không có thông báo mới</p>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" id="tab-promotions" style="display: none;">
                    <div class="content-card">
                        <div class="card-header">
                            <h2 class="card-title">Ưu đãi & Khuyến mãi</h2>
                        </div>
                        <div class="card-body" style="text-align: center; padding: 60px;">
                            <i class="fas fa-tags" style="font-size: 4rem; color: #e5e7eb;"></i>
                            <p style="color: #6b7280; margin-top: 16px;">Chưa có ưu đãi nào</p>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" id="tab-settings" style="display: none;">
                    <div class="content-card">
                        <div class="card-header">
                            <h2 class="card-title">Cài đặt thông báo</h2>
                        </div>
                        <div class="card-body">
                            <div class="checkbox-group" style="max-width: 500px;">
                                <label class="checkbox-option">
                                    <input type="checkbox" checked>
                                    <span>Nhận email cập nhật đơn hàng</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" checked>
                                    <span>Nhận SMS khi đơn hàng thay đổi trạng thái</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox">
                                    <span>Nhận thông báo về sản phẩm mới</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" checked>
                                    <span>Nhận email khuyến mãi hàng tuần</span>
                                </label>
                            </div>
                            <button type="button" class="btn-primary" style="margin-top: 24px;">
                                <i class="fas fa-save"></i>
                                Lưu cài đặt
                            </button>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" id="tab-privacy" style="display: none;">
                    <div class="content-card">
                        <div class="card-header">
                            <h2 class="card-title">Quyền riêng tư</h2>
                        </div>
                        <div class="card-body">
                            <div class="checkbox-group" style="max-width: 500px;">
                                <label class="checkbox-option">
                                    <input type="checkbox" checked>
                                    <span>Hiển thị tên trong danh sách đánh giá</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox">
                                    <span>Cho phép nhà bán hàng liên hệ trực tiếp</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" checked>
                                    <span>Lưu lịch sử tìm kiếm</span>
                                </label>
                            </div>
                            <button type="button" class="btn-primary" style="margin-top: 24px;">
                                <i class="fas fa-save"></i>
                                Lưu cài đặt
                            </button>
                        </div>
                    </div>
                </section>

            </main>
        </div>
    </div>
</div>

<!-- Map Modal -->
<div class="map-modal-overlay" id="mapModal">
    <div class="map-modal">
        <div class="map-modal-header">
            <h3 class="map-modal-title">📍 Chọn vị trí trên bản đồ</h3>
            <button class="map-modal-close" onclick="closeMapModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="map-search-box">
            <div class="map-search-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" class="map-search-input" id="mapSearchInput" placeholder="Tìm kiếm địa chỉ...">
            </div>
        </div>
        <div class="map-container">
            <div id="leaflet-map"></div>
        </div>
        <div class="map-modal-footer">
            <div class="selected-location" id="selectedLocation">
                <i class="fas fa-map-pin"></i>
                <span>Chưa chọn vị trí</span>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn-secondary" onclick="closeMapModal()">Hủy</button>
                <button class="btn-primary" onclick="confirmLocation()">
                    <i class="fas fa-check"></i>
                    Xác nhận vị trí
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // Tab Navigation
    document.querySelectorAll('.nav-item[data-tab]').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const tabName = this.dataset.tab;
            switchTab(tabName);
            
            // Update active state
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            this.classList.add('active');
        });
    });

    function switchTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-panel').forEach(tab => {
            tab.style.display = 'none';
        });
        
        // Show selected tab
        const targetTab = document.getElementById('tab-' + tabName);
        if (targetTab) {
            targetTab.style.display = 'block';
        }
    }

    // Radio option selection style
    document.querySelectorAll('.radio-option input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const group = this.closest('.radio-group');
            group.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
            this.closest('.radio-option').classList.add('selected');
        });
    });

    // Avatar Upload Preview
    document.getElementById('avatarInput')?.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('avatarPreview').src = e.target.result;
                document.getElementById('userAvatar').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('avatarUpload')?.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('avatarPreview').src = e.target.result;
                document.getElementById('userAvatar').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    // Map functionality
    let map;
    let marker;
    let selectedLat = null;
    let selectedLng = null;

    function openAddressModal() {
        document.getElementById('mapModal').classList.add('active');
        initMap();
    }

    function closeMapModal() {
        document.getElementById('mapModal').classList.remove('active');
    }

    function initMap() {
        if (!map) {
            // Default to Ho Chi Minh City
            map = L.map('leaflet-map').setView([10.8231, 106.6297], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Add marker on click
            map.on('click', function(e) {
                setMarker(e.latlng.lat, e.latlng.lng);
            });
        }
        setTimeout(() => map.invalidateSize(), 100);
    }

    function setMarker(lat, lng) {
        selectedLat = lat;
        selectedLng = lng;
        
        if (marker) {
            map.removeLayer(marker);
        }
        
        marker = L.marker([lat, lng], { draggable: true }).addTo(map);
        
        marker.on('dragend', function(e) {
            const pos = e.target.getLatLng();
            selectedLat = pos.lat;
            selectedLng = pos.lng;
            updateLocationDisplay(pos.lat, pos.lng);
        });

        updateLocationDisplay(lat, lng);
    }

    function updateLocationDisplay(lat, lng) {
        document.getElementById('selectedLocation').innerHTML = 
            `<i class="fas fa-map-pin"></i><span>Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}</span>`;
    }

    function viewOnMap(lat, lng) {
        openAddressModal();
        setTimeout(() => {
            if (map) {
                map.setView([lat, lng], 16);
                setMarker(lat, lng);
            }
        }, 300);
    }

    function confirmLocation() {
        if (selectedLat && selectedLng) {
            showToast('Đã chọn vị trí thành công!', 'success');
            closeMapModal();
        } else {
            showToast('Vui lòng chọn vị trí trên bản đồ', 'error');
        }
    }

    // Toast notifications
    function showToast(message, type = 'success') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            <span>${message}</span>
        `;
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Save functions
    function saveProfile() {
        showToast('Đã lưu thông tin hồ sơ thành công!', 'success');
    }

    function saveOptions() {
        showToast('Đã lưu tùy chọn thành công!', 'success');
    }

    function editAddress(id) {
        showToast('Chức năng sửa địa chỉ đang được phát triển', 'success');
    }

    function setDefaultAddress(id) {
        showToast('Đã đặt địa chỉ mặc định!', 'success');
    }

    function deleteAddress(id) {
        if (confirm('Bạn có chắc muốn xóa địa chỉ này?')) {
            showToast('Đã xóa địa chỉ!', 'success');
        }
    }

    // Change Password Form
    document.getElementById('changePassForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        const form = this;
        const matKhauMoi = form.querySelector('[name="MatKhauMoi"]').value;
        const xacNhan = form.querySelector('[name="XacNhanMatKhau"]').value;
        
        if (matKhauMoi !== xacNhan) {
            showToast('Mật khẩu xác nhận không khớp!', 'error');
            return;
        }

        // AJAX call
        fetch('@Url.Action("ChangePassword", "Customer")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
            },
            body: new URLSearchParams(new FormData(form))
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showToast('Đổi mật khẩu thành công!', 'success');
                form.reset();
            } else {
                showToast(data.message || 'Có lỗi xảy ra!', 'error');
            }
        })
        .catch(() => {
            showToast('Không thể kết nối đến server!', 'error');
        });
    });
</script>

@functions {
    public string GetStatusColor(string status)
    {
        return status switch
        {
            "Moi" => "#3b82f6",
            "Chờ xử lý" => "#f59e0b",
            "DaGiao" => "#10b981",
            "Huy" => "#ef4444",
            _ => "#6b7280"
        };
    }
}