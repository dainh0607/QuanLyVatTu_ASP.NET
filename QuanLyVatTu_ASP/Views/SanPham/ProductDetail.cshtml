@model QuanLyVatTu_ASP.Areas.Admin.Models.VatTu
@{
    ViewData["Title"] = Model.TenVatTu;
    Layout = "~/Views/Shared/_Layout_Customer.cshtml";
}

<div class="product-detail-page py-5" style="background-color: var(--md-sys-color-surface);">
    <div class="container-fluid px-4 px-lg-5 py-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-4">
                <li class="breadcrumb-item"><a href="/" class="text-decoration-none text-muted small">Trang chủ</a></li>
                <li class="breadcrumb-item"><a href="/SanPham" class="text-decoration-none text-muted small">Sản phẩm</a></li>
                <li class="breadcrumb-item active text-dark fw-bold small" aria-current="page">@Model.TenVatTu</li>
            </ol>
        </nav>

        <div class="row g-5">
            <!-- Gallery Section -->
            <div class="col-lg-5">
                <div class="product-gallery position-sticky" style="top: 100px;">
                    <div class="main-image mb-3 bg-white rounded-4 shadow-sm overflow-hidden d-flex align-items-center justify-content-center border border-light" style="aspect-ratio: 1/1;">
                       <img src="@(string.IsNullOrEmpty(Model.HinhAnh) ? $"/user/images/{Model.TenVatTu}.jpg" : Model.HinhAnh)" 
                            alt="@Model.TenVatTu" id="currentImg" class="img-fluid" style="max-height: 90%; object-fit: contain;" /> 
                    </div>
                    <div class="d-flex gap-2 thumbnail-list overflow-auto pb-2">
                       <img src="@(string.IsNullOrEmpty(Model.HinhAnh) ? $"/user/images/{Model.TenVatTu}.jpg" : Model.HinhAnh)" 
                                class="rounded-3 border border-2 border-primary active-thumb cursor-pointer" 
                                style="width: 70px; height: 70px; object-fit: cover;"
                                onclick="changeImage(this)" 
                                alt="@Model.TenVatTu">

                            @if (ViewBag.RelatedProducts != null)
                            {
                                foreach (var item in (IEnumerable<QuanLyVatTu_ASP.Areas.Admin.Models.VatTu>)ViewBag.RelatedProducts)
                                {
                                    <img src="@(string.IsNullOrEmpty(item.HinhAnh) ? $"/user/images/{item.TenVatTu}.jpg" : item.HinhAnh)" 
                                        class="rounded-3 border border-light cursor-pointer opacity-75 hover-opacity-100" 
                                        style="width: 70px; height: 70px; object-fit: cover;"
                                        onclick="changeImage(this)" 
                                        alt="@item.TenVatTu">
                                }
                            }
                    </div>
                </div>
            </div>

            <!-- Product Info Section -->
            <div class="col-lg-7">
                <div class="ps-lg-4">
                    <div class="d-flex align-items-center gap-2 mb-2">
                         @if (Model.SoLuongTon > 0)
                        {
                            <span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill px-3">Còn hàng</span>
                        }
                        else
                        {
                            <span class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill px-3">Hết hàng</span>
                        }
                        <span class="text-muted small">Mã: @Model.ID</span>
                    </div>

                    <h1 class="display-5 fw-bold mb-3" style="font-family: 'Google Sans', sans-serif; color: var(--md-sys-color-on-surface);">@Model.TenVatTu</h1>
                    
                    <div class="d-flex align-items-center gap-3 mb-4">
                        <div class="d-flex align-items-center text-warning">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star-half-alt"></i>
                            <span class="text-dark fw-bold ms-2">4.8</span>
                        </div>
                        <span class="text-muted">|</span>
                        <span class="text-muted">150 Đánh giá</span>
                        <span class="text-muted">|</span>
                        <span class="text-muted">300+ Đã bán</span>
                    </div>

                    <div class="price-section mb-4 p-4 rounded-4 bg-light bg-opacity-50">
                        <h2 class="display-6 fw-bold text-primary mb-0">@(Model.GiaBan?.ToString("N0") ?? "0")đ</h2>
                        <small class="text-muted">Giá đã bao gồm VAT</small>
                    </div>

                    <p class="lead text-secondary mb-4" style="font-size: 1.1rem;">@Model.MoTa</p>
                    
                    @if (Model.SoLuongTon > 0)
                    {
                        <div class="action-area border-top pt-4 mt-4">
                            <div class="row align-items-end g-3">
                                <div class="col-sm-4 col-md-3">
                                    <label class="fw-bold mb-2 small text-uppercase text-muted">Số lượng</label>
                                    <div class="input-group">
                                        <button class="btn btn-outline-secondary rounded-start-pill border-end-0 ps-3" type="button" onclick="updateQty(-1)">-</button>
                                        <input type="number" id="qty" class="form-control text-center border-start-0 border-end-0 fw-bold" value="1" min="1" max="@Model.SoLuongTon" style="max-width: 60px;">
                                        <button class="btn btn-outline-secondary rounded-end-pill border-start-0 pe-3" type="button" onclick="updateQty(1)">+</button>
                                    </div>
                                </div>
                                <div class="col-sm-8 col-md-9">
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-primary rounded-pill py-3 px-4 fw-bold flex-grow-1" onclick="addToCart(@Model.ID, document.getElementById('qty').value)">
                                            <i class="fas fa-cart-plus me-2"></i>Thêm vào giỏ
                                        </button>
                                        <button class="btn btn-primary rounded-pill py-3 px-5 fw-bold flex-grow-1 shadow-sm" onclick="buyNow(@Model.ID)">
                                            Mua ngay
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <button class="btn btn-secondary w-100 py-3 rounded-pill" disabled>Tạm hết hàng</button>
                    }

                    <div class="service-features mt-5">
                         <div class="row g-3">
                             <div class="col-md-6">
                                 <div class="d-flex gap-3 align-items-center p-3 rounded-3 bg-white shadow-sm border border-light h-100">
                                     <div class="icon-circle bg-blue-light text-primary rounded-circle p-2"><i class="fas fa-truck"></i></div>
                                     <div>
                                         <small class="d-block fw-bold text-dark">Giao hàng toàn quốc</small>
                                         <small class="text-muted" style="font-size: 0.75rem;">Nhận hàng trong 2-3 ngày</small>
                                     </div>
                                 </div>
                             </div>
                             <div class="col-md-6">
                                 <div class="d-flex gap-3 align-items-center p-3 rounded-3 bg-white shadow-sm border border-light h-100">
                                     <div class="icon-circle bg-green-light text-success rounded-circle p-2"><i class="fas fa-shield-alt"></i></div>
                                     <div>
                                         <small class="d-block fw-bold text-dark">Bảo hành chính hãng</small>
                                         <small class="text-muted" style="font-size: 0.75rem;">Đổi trả trong 7 ngày</small>
                                     </div>
                                 </div>
                             </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>

            <!-- Sidebar merged into main content -->
        </div>

        <!-- Material Tabs -->
        <div class="product-details-section mt-5">
            <ul class="nav nav-tabs border-bottom-0 gap-4 mb-4" id="productTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active fw-bold bg-transparent border-0 border-bottom border-3 border-primary px-0 text-primary rounded-0" 
                            id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" 
                            style="border-color: var(--md-sys-color-primary) !important;">
                        Chi tiết sản phẩm
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link fw-bold bg-transparent border-0 text-muted px-0 rounded-0" 
                            id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab"
                            onclick="this.classList.add('border-bottom', 'border-3', 'border-primary', 'text-primary'); document.getElementById('details-tab').classList.remove('border-bottom', 'border-3', 'border-primary', 'text-primary'); document.getElementById('details-tab').classList.add('text-muted');">
                        Đánh giá sản phẩm
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="productTabsContent">
                <!-- Tab Chi tiết sản phẩm -->
                <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="p-4 rounded-4 bg-light bg-opacity-50">
                                <h5 class="fw-bold mb-4" style="font-family: 'Google Sans', sans-serif;">Thông số kỹ thuật</h5>
                                <table class="table table-borderless mb-0">
                                    <tbody>
                                        <tr class="border-bottom border-light">
                                            <td class="text-muted py-3" style="width: 40%;">Mã sản phẩm</td>
                                            <td class="fw-medium py-3">@Model.ID</td>
                                        </tr>
                                        <tr class="border-bottom border-light">
                                            <td class="text-muted py-3">Tên sản phẩm</td>
                                            <td class="fw-medium py-3">@Model.TenVatTu</td>
                                        </tr>
                                        <tr class="border-bottom border-light">
                                            <td class="text-muted py-3">Danh mục</td>
                                            <td class="fw-medium py-3">@ViewBag.TenLoai</td>
                                        </tr>
                                        <tr class="border-bottom border-light">
                                            <td class="text-muted py-3">Đơn vị tính</td>
                                            <td class="fw-medium py-3">@(Model.DonViTinh ?? "Cái")</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted py-3">Xuất xứ</td>
                                            <td class="fw-medium py-3">Việt Nam</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="p-4 rounded-4 border border-light h-100">
                                <h5 class="fw-bold mb-3" style="font-family: 'Google Sans', sans-serif;">Mô tả sản phẩm</h5>
                                <p class="text-secondary mb-4" style="line-height: 1.6;">@Model.MoTa</p>
                                
                                <h6 class="fw-bold mb-3">Đặc điểm nổi bật</h6>
                                <ul class="list-unstyled d-flex flex-column gap-2">
                                    <li class="d-flex align-items-center gap-2">
                                        <i class="fas fa-check-circle text-primary"></i>
                                        <span>Thiết kế hiện đại, tinh tế</span>
                                    </li>
                                    <li class="d-flex align-items-center gap-2">
                                        <i class="fas fa-check-circle text-primary"></i>
                                        <span>Chất liệu cao cấp, bền bỉ</span>
                                    </li>
                                    <li class="d-flex align-items-center gap-2">
                                        <i class="fas fa-check-circle text-primary"></i>
                                        <span>Dễ dàng lắp đặt và sử dụng</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Đánh giá sản phẩm -->
                <div class="tab-pane fade" id="reviews" role="tabpanel" aria-labelledby="reviews-tab">
                     <!-- Reuse the bottom reviews section logic but styled better here if needed, or just link to it -->
                     <!-- For now, we will simply scroll to the bottom reviews section or replicate it. 
                          The bottom section has ID 'reviewsSection'. We can move it here or just let the tabs be layout.
                          Actually, the original file had a "Product Reviews Section" at line 374 which is DUPLICATE logic to the tab content?
                          Wait, let me check the original file again.
                          Line 142 starts tabs.
                          Line 224 starts "Tab Đánh giá sản phẩm" content which seems to calculate ratings.
                          Line 374 starts ANOTHER "Product Reviews Section" with ID reviewsSection.
                          This looks like duplicate code or two different ways of showing reviews.
                          I strictly want to clean this up. I will keep the Tab structure and put the Reviews UI INSIDE the tab, merging logic.
                      -->
                    <div class="row g-4 mt-2">
                        <!-- Rating Summary Column -->
                        <div class="col-lg-4">
                            <div class="card border-0 bg-light bg-opacity-50 rounded-4 h-100">
                                <div class="card-body p-4 text-center">
                                    <h5 class="fw-bold mb-4" style="font-family: 'Google Sans', sans-serif;">Tổng quan</h5>
                                    
                                    <div class="rating-big mb-3">
                                        <div class="display-3 fw-bold text-primary" id="avgScore">@ViewBag.DiemTrungBinh</div>
                                        <div class="text-muted small">trên 5.0</div>
                                    </div>

                                    <div class="mb-3 text-warning fs-5" id="avgStars">
                                        <!-- Stars will be injected via JS -->
                                        <i class="fas fa-star text-muted opacity-25"></i>
                                        <i class="fas fa-star text-muted opacity-25"></i>
                                        <i class="fas fa-star text-muted opacity-25"></i>
                                        <i class="fas fa-star text-muted opacity-25"></i>
                                        <i class="fas fa-star text-muted opacity-25"></i>
                                    </div>

                                    <div class="text-muted mb-4"><span id="totalReviews" class="fw-bold text-dark">0</span> đánh giá</div>

                                    <div class="rating-breakdown text-start px-2">
                                        <!-- Breakdown bars will be injected via JS but we keep structure -->
                                        <div class="d-flex align-items-center mb-2 gap-2 small">
                                            <span>5</span> <i class="fas fa-star text-warning"></i>
                                            <div class="progress flex-grow-1" style="height: 6px; border-radius: 99px;">
                                                <div class="progress-bar bg-warning" id="bar5" style="width: 0%"></div>
                                            </div>
                                            <span class="text-muted" id="percent5" style="width: 35px; text-align: right;">0%</span>
                                        </div>
                                        <div class="d-flex align-items-center mb-2 gap-2 small">
                                            <span>4</span> <i class="fas fa-star text-warning"></i>
                                            <div class="progress flex-grow-1" style="height: 6px; border-radius: 99px;">
                                                <div class="progress-bar bg-warning" id="bar4" style="width: 0%"></div>
                                            </div>
                                            <span class="text-muted" id="percent4" style="width: 35px; text-align: right;">0%</span>
                                        </div>
                                        <div class="d-flex align-items-center mb-2 gap-2 small">
                                            <span>3</span> <i class="fas fa-star text-warning"></i>
                                            <div class="progress flex-grow-1" style="height: 6px; border-radius: 99px;">
                                                <div class="progress-bar bg-warning" id="bar3" style="width: 0%"></div>
                                            </div>
                                            <span class="text-muted" id="percent3" style="width: 35px; text-align: right;">0%</span>
                                        </div>
                                        <div class="d-flex align-items-center mb-2 gap-2 small">
                                            <span>2</span> <i class="fas fa-star text-warning"></i>
                                            <div class="progress flex-grow-1" style="height: 6px; border-radius: 99px;">
                                                <div class="progress-bar bg-warning" id="bar2" style="width: 0%"></div>
                                            </div>
                                            <span class="text-muted" id="percent2" style="width: 35px; text-align: right;">0%</span>
                                        </div>
                                        <div class="d-flex align-items-center mb-2 gap-2 small">
                                            <span>1</span> <i class="fas fa-star text-warning"></i>
                                            <div class="progress flex-grow-1" style="height: 6px; border-radius: 99px;">
                                                <div class="progress-bar bg-warning" id="bar1" style="width: 0%"></div>
                                            </div>
                                            <span class="text-muted" id="percent1" style="width: 35px; text-align: right;">0%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Review List Column -->
                        <div class="col-lg-8">
                            <!-- Filters -->
                            <div class="d-flex gap-2 overflow-auto pb-2 mb-4 review-filters">
                                <button class="btn btn-sm btn-outline-primary rounded-pill px-3 active filter-btn fw-bold" data-filter="all">Tất cả</button>
                                <button class="btn btn-sm btn-outline-secondary rounded-pill px-3 filter-btn" data-filter="5">5 sao</button>
                                <button class="btn btn-sm btn-outline-secondary rounded-pill px-3 filter-btn" data-filter="4">4 sao</button>
                                <button class="btn btn-sm btn-outline-secondary rounded-pill px-3 filter-btn" data-filter="3">3 sao</button>
                                <button class="btn btn-sm btn-outline-secondary rounded-pill px-3 filter-btn" data-filter="2">2 sao</button>
                                <button class="btn btn-sm btn-outline-secondary rounded-pill px-3 filter-btn" data-filter="1">1 sao</button>
                            </div>

                            <!-- Write Review Form -->
                             @if (Context.Session.GetInt32("KhachHangId") != null)
                            {
                                <div class="card border-primary border-opacity-10 shadow-sm mb-4 rounded-4" id="writeReviewForm">
                                    <div class="card-body p-4">
                                        <h6 class="fw-bold mb-3 text-primary"><i class="fas fa-pen me-2"></i>Viết đánh giá của bạn</h6>
                                        <form id="reviewForm">
                                            <div class="mb-3">
                                                 <label class="form-label small fw-bold text-muted text-uppercase">Đánh giá chung</label>
                                                 <div class="star-rating-input fs-4 text-warning cursor-pointer">
                                                     <!-- Reversed radio trick or just js handling? We'll use the existing JS logic but simplified HTML -->
                                                     <div class="rating-group d-flex gap-2">
                                                         <i class="far fa-star rating-star" data-rating="1"></i>
                                                         <i class="far fa-star rating-star" data-rating="2"></i>
                                                         <i class="far fa-star rating-star" data-rating="3"></i>
                                                         <i class="far fa-star rating-star" data-rating="4"></i>
                                                         <i class="far fa-star rating-star" data-rating="5"></i>
                                                         <input type="hidden" name="rating" id="ratingValue" value="">
                                                     </div>
                                                 </div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label small fw-bold text-muted text-uppercase">Nội dung</label>
                                                <textarea class="form-control bg-light border-0 rounded-3" id="reviewComment" rows="3" placeholder="Chia sẻ cảm nhận của bạn về sản phẩm..."></textarea>
                                            </div>
                                            <div class="text-end">
                                                <button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold">
                                                    <i class="fas fa-paper-plane me-2"></i>Gửi đánh giá
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-light border-0 bg-light rounded-4 d-flex align-items-center gap-3 mb-4">
                                    <i class="fas fa-info-circle text-primary fs-4"></i>
                                    <div>
                                        Bạn cần <a href="/Account/Login" class="fw-bold text-decoration-none">đăng nhập</a> để viết đánh giá.
                                    </div>
                                </div>
                            }

                            <!-- List -->
                            <div id="reviewsList" class="d-flex flex-column gap-3">
                                <!-- Ajax content goes here -->
                                <div class="text-center py-5 text-muted">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Related Products -->
        <div class="related-products mt-5 pt-5">
            <h3 class="fw-bold mb-4" style="font-family: 'Google Sans', sans-serif;">Sản phẩm liên quan</h3>
            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
                @{
                    var relatedProducts = ViewBag.RelatedProducts as IEnumerable<QuanLyVatTu_ASP.Areas.Admin.Models.VatTu>;
                }
                @if (relatedProducts != null && relatedProducts.Any())
                {
                    foreach (var item in relatedProducts)
                    {
                        <div class="col">
                            <div class="card md-card h-100 border-0 position-relative group-hover-trigger">
                                <div class="position-relative overflow-hidden bg-light rounded-top" style="height: 200px; border-radius: 12px 12px 0 0;">
                                    <a href="@Url.Action("ProductDetail", "SanPham", new { id = item.ID })" class="d-flex align-items-center justify-content-center h-100 w-100">
                                        <img src="@(string.IsNullOrEmpty(item.HinhAnh) ? $"/user/images/{item.TenVatTu}.jpg" : item.HinhAnh)" 
                                             class="img-fluid p-3" 
                                             alt="@item.TenVatTu" 
                                             style="max-height: 100%; object-fit: contain; transition: transform 0.3s;">
                                    </a>
                                </div>
                                
                                <div class="card-body p-3 d-flex flex-column">
                                    <h6 class="card-title fw-bold mb-1 text-truncate">
                                        <a href="@Url.Action("ProductDetail", "SanPham", new { id = item.ID })" class="text-decoration-none text-dark" title="@item.TenVatTu">
                                            @item.TenVatTu
                                        </a>
                                    </h6>
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-star text-warning small me-1"></i>
                                        <span class="small text-muted">4.5</span>
                                    </div>
                                    <div class="mt-auto d-flex justify-content-between align-items-center">
                                        <span class="fw-bold text-primary">@(item.GiaBan?.ToString("N0") ?? "0")đ</span>
                                        <button class="btn btn-light rounded-circle shadow-sm" style="width: 32px; height: 32px; padding: 0;" onclick="window.location.href='@Url.Action("ProductDetail", "SanPham", new { id = item.ID })'">
                                            <i class="fas fa-arrow-right small"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                     <div class="col-12 text-center text-muted py-4">
                        <p>Không có sản phẩm liên quan nào.</p>
                    </div>
                }
            </div>
        </div>



<!-- Modal Thông báo thêm giỏ hàng -->
<div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold text-success" id="cartModalLabel">
            <i class="fas fa-check-circle me-2"></i>Thành công
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center py-4">
        <p class="mb-0 fs-5">Sản phẩm đã được thêm vào giỏ hàng!</p>
      </div>
      <div class="modal-footer border-0 justify-content-center pb-4">
        <button type="button" class="btn btn-outline-secondary px-4 rounded-3" data-bs-dismiss="modal">Tiếp tục mua sắm</button>
        <a href="/GioHang/GioHang" class="btn btn-primary px-4 rounded-3">Xem giỏ hàng</a>
      </div>
    </div>
  </div>
</div>

@section Scripts {
    <script>
        var productId = @Model.ID;

        // Xử lý nút tăng giảm số lượng
        function updateQty(change) {
            var input = document.getElementById('qty');
            var newVal = parseInt(input.value) + change;
            var max = parseInt(input.getAttribute('max'));
            
            if (newVal >= 1 && newVal <= max) {
                input.value = newVal;
            }
        }

        // Validate quantity input - prevent user from typing more than available stock
        $(document).ready(function() {
            $('#qty').on('input', function() {
                var max = parseInt($(this).attr('max'));
                var value = parseInt($(this).val());
                
                if (value > max) {
                    $(this).val(max);
                    // Show warning message
                    showQuantityWarning(max);
                } else if (value < 1 || isNaN(value)) {
                    $(this).val(1);
                }
            });

            // Star rating click handler
            $('.rating-star').on('click', function() {
                var rating = $(this).data('rating');
                $('#ratingValue').val(rating);
                
                // Update star display
                $('.rating-star').each(function(index) {
                    if (index < rating) {
                        $(this).removeClass('far').addClass('fas');
                    } else {
                        $(this).removeClass('fas').addClass('far');
                    }
                });
            });

            // Star rating hover effect
            $('.rating-star').on('mouseenter', function() {
                var rating = $(this).data('rating');
                $('.rating-star').each(function(index) {
                    if (index < rating) {
                        $(this).removeClass('far').addClass('fas');
                    } else {
                        $(this).removeClass('fas').addClass('far');
                    }
                });
            });

            // Reset stars on mouse leave to selected rating
            $('.star-rating').on('mouseleave', function() {
                var selectedRating = $('#ratingValue').val();
                $('.rating-star').each(function(index) {
                    if (index < selectedRating) {
                        $(this).removeClass('far').addClass('fas');
                    } else {
                        $(this).removeClass('fas').addClass('far');
                    }
                });
            });
        });

        // Show quantity warning
        function showQuantityWarning(max) {
            // Create a temporary toast/alert
            var toast = $('<div class="alert alert-warning alert-dismissible fade show position-fixed top-0 end-0 m-3" role="alert" style="z-index: 9999;">' +
                          '<i class="fas fa-exclamation-triangle me-2"></i>Số lượng tối đa: ' + max + ' sản phẩm' +
                          '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                          '</div>');
            $('body').append(toast);
            setTimeout(function() {
                toast.alert('close');
            }, 3000);
        }

        // Xử lý đổi ảnh khi click thumbnail
        function changeImage(element) {
            var mainImg = document.getElementById('currentImg');
            mainImg.src = element.src.replace('100x100', '600x600');
            
            document.querySelectorAll('.thumbnail-list img').forEach(img => img.classList.remove('active-thumb', 'border-primary'));
            element.classList.add('active-thumb', 'border', 'border-primary');
        }

        // Ajax thêm vào giỏ hàng
        function addToCart(id) {
            var qty = $('#qty').val();
            var max = parseInt($('#qty').attr('max'));
            
            // Validate before adding to cart
            if (parseInt(qty) > max) {
                showQuantityWarning(max);
                $('#qty').val(max);
                return;
            }
            
            $.post('/GioHang/AddToCart', { productId: id, quantity: qty }, function(res) {
                if(res.success) {
                    var myModal = new bootstrap.Modal(document.getElementById('cartModal'));
                    myModal.show();
                    if(res.count) $('.cart-count').text(res.count);
                } else {
                    alert("Có lỗi xảy ra: " + res.message);
                }
            });
        }

        // Mua ngay
        function buyNow(id) {
            var qty = $('#qty').val();
            var max = parseInt($('#qty').attr('max'));
            
            // Validate before buying
            if (parseInt(qty) > max) {
                showQuantityWarning(max);
                $('#qty').val(max);
                return;
            }
            
            $.post('/GioHang/AddToCart', { productId: id, quantity: qty }, function(res) {
                if(res.success) {
                    window.location.href = "/GioHang/GioHang";
                } else {
                    alert("Có lỗi xảy ra: " + res.message);
                }
            });
        }

        // ============ REVIEWS FUNCTIONALITY ============
        
        // Load reviews on page load
        $(document).ready(function() {
            loadReviews();
            
            // Filter buttons
            $('.filter-btn').on('click', function() {
                $('.filter-btn').removeClass('active');
                $(this).addClass('active');
                var filter = $(this).data('filter');
                loadReviews(filter === 'all' ? null : filter);
            });
            
            // Breakdown row click
            $('.breakdown-row').on('click', function() {
                var star = $(this).data('star');
                $('.filter-btn').removeClass('active');
                $('.filter-btn[data-filter="' + star + '"]').addClass('active');
                loadReviews(star);
            });
            
            // Submit review form
            $('#reviewForm').on('submit', function(e) {
                e.preventDefault();
                submitReview();
            });
        });

        function loadReviews(starFilter) {
            var url = '/DanhGia/GetReviews?maVatTu=' + productId;
            if (starFilter) url += '&soSao=' + starFilter;
            
            $.get(url, function(res) {
                if (res.success) {
                    updateStats(res.stats);
                    renderReviews(res.reviews);
                }
            });
        }

        function updateStats(stats) {
            $('#avgScore').text(stats.diemTrungBinh);
            $('#totalReviews').text(stats.tongSo);
            
            // Update stars
            var fullStars = Math.floor(stats.diemTrungBinh);
            var starsHtml = '';
            for (var i = 0; i < 5; i++) {
                starsHtml += '<i class="fas fa-star ' + (i < fullStars ? '' : 'empty') + '"></i>';
            }
            $('#avgStars').html(starsHtml);
            
            // Update breakdown bars
            var total = stats.tongSo || 1;
            for (var i = 1; i <= 5; i++) {
                var count = stats['sao' + i];
                var percent = Math.round((count / total) * 100);
                $('#bar' + i).css('width', percent + '%');
                $('#percent' + i).text(percent + '%');
            }
        }

        function renderReviews(reviews) {
            var container = $('#reviewsList');
            
            if (!reviews || reviews.length === 0) {
                container.html(`
                    <div class="reviews-empty">
                        <i class="far fa-comment-dots"></i>
                        <h4>Chưa có đánh giá nào</h4>
                        <p>Hãy là người đầu tiên đánh giá sản phẩm này!</p>
                    </div>
                `);
                return;
            }
            
            var html = '';
            reviews.forEach(function(r) {
                var starsHtml = '';
                for (var i = 0; i < 5; i++) {
                    starsHtml += '<i class="fas fa-star ' + (i < r.soSao ? '' : 'empty') + '"></i>';
                }
                
                var dateStr = new Date(r.ngayDanhGia).toLocaleDateString('vi-VN');
                
                html += `
                    <div class="review-card" data-id="${r.id}">
                        <div class="review-header">
                            <img src="${r.avatarUrl}" alt="Avatar" class="review-avatar">
                            <div class="review-info">
                                <h5 class="review-author">${r.tenKhachHang}</h5>
                                <div class="review-meta">
                                    <div class="review-stars">${starsHtml}</div>
                                    <span class="review-date">${dateStr}</span>
                                    <span class="review-quality">Chất lượng: ${r.chatLuongSanPham}/5</span>
                                </div>
                            </div>
                        </div>
                        ${r.binhLuan ? '<p class="review-content">' + r.binhLuan + '</p>' : ''}
                        <div class="review-footer">
                            <button class="review-like-btn" onclick="likeReview(${r.id}, this)">
                                <i class="far fa-thumbs-up"></i> <span>${r.luotThich}</span>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.html(html);
        }

        function submitReview() {
            var rating = $('input[name="rating"]:checked').val();
            var quality = $('input[name="quality"]:checked').val() || rating;
            var comment = $('#reviewComment').val();
            
            if (!rating) {
                alert('Vui lòng chọn số sao đánh giá');
                return;
            }
            
            $.ajax({
                url: '/DanhGia/Create',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    maVatTu: productId,
                    soSao: parseInt(rating),
                    chatLuongSanPham: parseInt(quality),
                    binhLuan: comment
                }),
                success: function(res) {
                    if (res.success) {
                        alert('Đánh giá thành công!');
                        $('#reviewForm')[0].reset();
                        loadReviews();
                        $('#writeReviewForm').hide();
                    } else {
                        alert(res.message);
                    }
                },
                error: function() {
                    alert('Có lỗi xảy ra, vui lòng thử lại');
                }
            });
        }

        function likeReview(reviewId, btn) {
            $.ajax({
                url: '/DanhGia/Like',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ maDanhGia: reviewId }),
                success: function(res) {
                    if (res.success) {
                        $(btn).find('span').text(res.luotThich);
                        if (res.liked) {
                            $(btn).addClass('liked');
                            $(btn).find('i').removeClass('far').addClass('fas');
                        } else {
                            $(btn).removeClass('liked');
                            $(btn).find('i').removeClass('fas').addClass('far');
                        }
                }
            });
        }
    </script>
}

@section Styles {
    <link rel="stylesheet" href="~/user/css/reviews.css" />
    <style>
        /* CSS Riêng cho trang chi tiết */
        .product-gallery .img-thumbnail {
            cursor: pointer;
            width: 80px;
            height: 80px;
            object-fit: cover;
            opacity: 0.6;
            transition: 0.3s;
        }
        .product-gallery .img-thumbnail:hover, 
        .product-gallery .img-thumbnail.active-thumb {
            opacity: 1;
            border-color: var(--bs-primary) !important;
        }
        
        .quantity-group input::-webkit-outer-spin-button,
        .quantity-group input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Hiệu ứng hover cho thẻ sản phẩm liên quan */
        .product-card-hover {
            transition: transform 0.2s;
        }
        .product-card-hover:hover {
            transform: translateY(-5px);
        }

        .service-box {
            background-color: #f8f9fa;
        }
        .btn-dark {
            background-color: #000;
            border: none;
        }
        .btn-dark:hover {
            background-color: #333;
        }

        /* Product Details Tabs */
        .nav-tabs .nav-link {
            color: #6c757d;
            border: none;
            border-bottom: 3px solid transparent;
            padding: 12px 24px;
            transition: all 0.3s;
        }
        .nav-tabs .nav-link:hover {
            color: #0d6efd;
            border-bottom-color: #e9ecef;
        }
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            border-bottom-color: #0d6efd;
            background: transparent;
        }

        /* Star Rating */
        .star-rating {
            font-size: 2rem;
            cursor: pointer;
            display: inline-block;
        }
        .star-rating i {
            color: #ffc107;
            transition: all 0.2s;
            margin: 0 2px;
        }
        .star-rating i:hover {
            transform: scale(1.2);
        }
        .rating-star {
            cursor: pointer;
        }

        /* Review Items */
        .review-item {
            transition: box-shadow 0.3s;
        }
        .review-item:hover {
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1) !important;
        }

        /* Rating Summary */
        .rating-summary {
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        }

        /* Progress bars for rating breakdown */
        .progress {
            height: 8px;
        }

        /* Tab content styling */
        .tab-content {
            min-height: 400px;
        }

        /* Product features list */
        .product-features ul li {
            font-size: 0.95rem;
        }

        /* Write review form */
        .write-review {
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        }

        /* Responsive adjustments */
        @@media (max-width: 768px) {
            .star-rating {
                font-size: 1.5rem;
            }
            .nav-tabs .nav-link {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
        }
    </style>
}