@model QuanLyVatTu_ASP.Areas.Admin.Models.VatTu
@{
    ViewData["Title"] = Model.TenVatTu;

    // Danh sách ảnh có sẵn trong folder wwwroot/user/images
    var availableImages = new string[] {
        "/user/images/Máy khoan cầm tay mẫu 1.jpg",
        "/user/images/Máy khoan cầm tay mẫu 2.jpg",
        "/user/images/Máy khoan cầm tay mẫu 3.jpg",
        "/user/images/Máy khoan cầm tay mẫu 4.jpg",
        "/user/images/Máy cắt - Uốn.jpg",
        "/user/images/Máy cắt bê tông KC16 (Không động cơ).jpg",
        "/user/images/Máy cắt sắt thủy lực cầm tay RC-25.jpg",
        "/user/images/Máy làm nền.jpg",
        "/user/images/Máy mài sàn bê tông DMS250.jpg",
        "/user/images/Máy xoa nền đôi Conmec (Ngồi lái).jpg",
        "/user/images/Máy xoa nền đơn Honda GX160.jpg",
        "/user/images/Máy đầm cóc Mikasa MT55.jpg",
        "/user/images/Máy đầm dùi chạy điện Jinlong 1.5KW.jpg",
        "/user/images/Máy đầm.jpg",
        "/user/images/Đầm bàn PC60.jpg"
    };

    // Helper function để lấy ảnh cho sản phẩm (xoay vòng theo ID)
    Func<int, string?, string> GetProductImage = (productId, existingImage) => {
        if (!string.IsNullOrEmpty(existingImage)) return existingImage;
        return availableImages[productId % availableImages.Length];
    };

    // Lấy ảnh cho sản phẩm hiện tại
    var mainProductImage = GetProductImage(Model.ID, Model.HinhAnh);
}
<style>
    /* Custom Shopee-like Styles */
    :root {
        --shopee-orange: #d0011b; /* Shopee brand color fallback */
        --shopee-price: #ee4d2d;
        --shopee-black: #000;
    }
    
    .product-detail-page {
        background-color: #f5f5f5;
        padding-top: 20px;
    }

    .shopee-box {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid #f0f0f0;
    }

    /* Gallery */
    .active-thumb {
        border: 2px solid var(--shopee-price) !important;
        border-radius: 8px !important;
    }

    /* Product Info */
    .product-title {
        font-size: 1.5rem;
        font-weight: 600;
        line-height: 1.2;
        color: #222;
        margin-bottom: 12px;
    }

    .product-price-box {
        background: #fafafa;
        padding: 15px 20px;
        margin-bottom: 25px;
        border-radius: 8px;
    }

    .product-price {
        font-size: 2rem;
        font-weight: 600;
        color: #d0011b; /* Shopee Red/Orange match */
    }

    .shopee-btn-black {
        background-color: #000;
        color: #fff;
        border: 1px solid #000;
        border-radius: 8px;
        height: 48px;
        font-size: 16px;
        text-transform: uppercase;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 16px;
        text-transform: uppercase;
        font-weight: 500;
    }
    .shopee-btn-black:hover {
        background-color: #333;
        color: #fff;
    }

    .shopee-btn-primary {
        background-color: var(--shopee-orange);
        color: #fff;
        border: 1px solid var(--shopee-orange);
        border-radius: 8px;
        height: 48px;
        font-size: 16px;
        text-transform: uppercase;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .shopee-btn-primary:hover {
        background-color: #a80015;
        color: #fff;
    }

    /* Policy Sidebar */
    .policy-list .policy-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 15px;
        font-size: 0.9rem;
    }
    .policy-item i {
        width: 25px;
        margin-top: 3px;
    }

    /* Reviews */
    .review-section-header {
        font-size: 1.125rem;
        color: rgba(0,0,0,.87);
        margin-bottom: 1.5rem;
        text-transform: uppercase;
        font-weight: 500;
    }
    
    .review-form-container {
        background-color: #f0f7ff; /* Light blue tint from image */
        border-radius: 8px;
        padding: 20px;
    }
    
    .star-rating i {
        cursor: pointer;
        font-size: 24px;
        color: #ccc;
        transition: color 0.2s;
    }
    .star-rating i.active, .star-rating i:hover, .star-rating i.hover {
        color: #ffc107; /* Warning yellow */
    }

</style>

<div class="product-detail-page pb-5">
    <div class="container">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb mb-0 small">
                <li class="breadcrumb-item"><a href="/" class="text-decoration-none text-muted">Trang chủ</a></li>
                <li class="breadcrumb-item"><a href="/SanPham" class="text-decoration-none text-muted">Danh mục sản phẩm</a></li>
                <li class="breadcrumb-item active" aria-current="page">@Model.TenVatTu</li>
            </ol>
        </nav>

        <!-- Main Product Section -->
        <div class="shopee-box">
            <div class="row g-4">
                <!-- 1. Column: Image (Left) -->
                <div class="col-lg-5">
                    <div class="product-gallery">
                        <div class="main-image mb-3 border border-light d-flex align-items-center justify-content-center bg-white" style="height: 400px; cursor: pointer; border-radius: 12px; overflow: hidden;">
                            <img src="@mainProductImage" 
                                 alt="@Model.TenVatTu" id="currentImg" class="img-fluid" style="max-height: 100%; object-fit: contain;" />
                        </div>
                        <div class="d-flex gap-2 overflow-auto">
                            <!-- Main Thumb -->
                             <img src="@mainProductImage" 
                                  class="border active-thumb cursor-pointer" 
                                  style="width: 82px; height: 82px; object-fit: cover; border-radius: 8px;"
                                  onclick="changeImage(this)" alt="Thumb">
                            
                            <!-- Related Thumbs (Mock or actual logic) -->
                            @if (ViewBag.RelatedProducts != null)
                            {
                                int limit = 0;
                                foreach (var item in (IEnumerable<QuanLyVatTu_ASP.Areas.Admin.Models.VatTu>)ViewBag.RelatedProducts)
                                {
                                    if(limit++ > 3) break;
                                    <img src="@GetProductImage(item.ID, item.HinhAnh)" 
                                         class="border cursor-pointer opacity-75 hover-opacity-100" 
                                         style="width: 82px; height: 82px; object-fit: cover; border-radius: 8px;"
                                         onclick="changeImage(this)" alt="@item.TenVatTu">
                                }
                            }
                        </div>
                    </div>
                </div>

                <!-- 2. Column: Info (Center) -->
                <div class="col-lg-4 border-end-lg">
                    <h1 class="product-title fw-bold">@Model.TenVatTu</h1>
                    
                    <div class="d-flex align-items-center mb-3 small">
                        <div class="text-warning me-2" id="headerRatingStars">
                            <!-- Will be filled by JS or default -->
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                        </div>
                        <span class="text-danger border-bottom border-danger me-3">4.9</span>
                        <span class="text-muted border-start ps-3 me-3">1.2k Đánh giá</span>
                        <span class="text-muted border-start ps-3">Đã bán 5.4k</span>
                    </div>

                    <div class="product-price-box">
                        <span class="product-price text-warning">@(Model.GiaBan?.ToString("N0") ?? "0")đ</span>
                    </div>

                    <div class="mb-4 small">
                        <div class="mb-2">
                            <span class="text-muted w-25 d-inline-block">Mã sản phẩm:</span>
                            <span>@Model.ID</span>
                        </div>
                        <div class="mb-2">
                            <span class="text-muted w-25 d-inline-block">Tình trạng:</span>
                            @if (Model.SoLuongTon > 0)
                            {
                                <span class="text-success">Còn hàng</span>
                            }
                            else
                            {
                                <span class="text-danger">Hết hàng</span>
                            }
                        </div>
                        <div class="mb-2">
                            <p class="text-muted mb-0">Sản phẩm chất lượng cao, bền bỉ, phù hợp với mọi nhu cầu sử dụng của gia đình và công trình.</p>
                        </div>
                    </div>

                    @if (Model.SoLuongTon > 0)
                    {
                        <div class="quantity-section mb-4">
                            <label class="d-block mb-2 fw-semibold" style="color: #374151;">Số lượng:</label>
                            <div class="d-flex align-items-center gap-3">
                                <div class="d-flex align-items-center" style="background: white; border-radius: 8px; overflow: hidden; border: 1px solid #d1d5db; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                    <button class="btn btn-link text-dark p-0 d-flex align-items-center justify-content-center" 
                                            style="width: 40px; height: 40px; text-decoration: none; border-right: 1px solid #e5e7eb; transition: background 0.2s;"
                                            type="button" onclick="updateQty(-1)" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                                        <i class="fas fa-minus" style="font-size: 0.75rem;"></i>
                                    </button>
                                    <input type="number" id="product-qty" 
                                           class="text-center border-0 fw-bold" 
                                           style="width: 60px; height: 40px; background: white; font-size: 1rem; outline: none; -moz-appearance: textfield;"
                                           value="1" min="1" max="@Model.SoLuongTon"
                                           oninput="validateQty(this)">
                                    <button class="btn btn-link text-dark p-0 d-flex align-items-center justify-content-center" 
                                            style="width: 40px; height: 40px; text-decoration: none; border-left: 1px solid #e5e7eb; transition: background 0.2s;"
                                            type="button" onclick="updateQty(1)" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                                        <i class="fas fa-plus" style="font-size: 0.75rem;"></i>
                                    </button>
                                </div>
                                <div class="text-secondary small">
                                    <span class="d-block">Còn lại: <span class="fw-bold text-dark">@Model.SoLuongTon</span> sản phẩm</span>
                                    <div id="qtyWarning" style="display:none; color: #dc2626; font-weight: 500; font-size: 0.8rem; margin-top: 2px;">
                                        <i class="fas fa-exclamation-triangle"></i> <span>Quá số lượng tồn</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-3">
                            <button class="btn shopee-btn-black flex-grow-1" id="btnAddToCart" onclick="addToCartAction(@Model.ID)">
                                <i class="fas fa-shopping-cart me-2"></i> THÊM VÀO GIỎ HÀNG
                            </button>
                            <button class="btn shopee-btn-primary flex-grow-1" id="btnBuyNow" onclick="buyNowAction(@Model.ID)">
                                Mua Ngay
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-3">
                            <div style="background: linear-gradient(135deg, #fef2f2, #fee2e2); padding: 16px 24px; border-radius: 12px; border: 1px solid #fecaca;">
                                <i class="fas fa-box-open" style="font-size: 1.5rem; color: #ef4444; margin-bottom: 8px;"></i>
                                <p class="mb-0 fw-bold" style="color: #dc2626;">TẠM HẾT HÀNG</p>
                                <p class="mb-0 small" style="color: #9ca3af;">Sản phẩm sẽ sớm được bổ sung</p>
                            </div>
                        </div>
                    }
                </div>

                <!-- 3. Column: Policies (Right) -->
                <div class="col-lg-3">
                    <div class="ps-lg-3">
                        <div class="policy-list">
                            <div class="policy-item">
                                <i class="fas fa-phone-alt text-danger me-2"></i>
                                <div>
                                    <span class="fw-bold d-block">SĐT/Zalo:</span>
                                    <span class="text-primary">0302370432</span>
                                </div>
                            </div>
                            <div class="policy-item">
                                <i class="fas fa-shipping-fast text-warning me-2"></i>
                                <div>
                                    <span class="fw-bold d-block">Giao hàng nhanh chóng</span>
                                    <span class="text-muted small">Vận chuyển toàn quốc</span>
                                </div>
                            </div>
                            <div class="policy-item">
                                <i class="fas fa-clock text-info me-2"></i>
                                <div>
                                    <span class="fw-bold d-block">Giờ làm việc</span>
                                    <span class="text-muted small">8h30 - 17h30 (T2 - T7)</span>
                                </div>
                            </div>
                            <div class="policy-item">
                                <i class="fas fa-globe text-success me-2"></i>
                                <div>
                                    <span class="fw-bold d-block">Mua online:</span>
                                    <span class="text-muted small">cuahangvattu.com</span>
                                </div>
                            </div>
                            <div class="policy-item">
                                <i class="fas fa-sync-alt text-success me-2"></i>
                                <div>
                                    <span class="fw-bold d-block">Đổi trả dễ dàng</span>
                                    <span class="text-muted small">Chính sách đổi trả trong 7 ngày</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Description & Reviews -->
        <!-- We use simple stacked layout -->
        
        <!-- Description -->
        <div class="shopee-box">
             <div class="bg-light p-3 mb-3">
                 <h5 class="m-0 text-uppercase text-dark" style="font-size: 1.125rem;">CHI TIẾT SẢN PHẨM</h5>
             </div>
             <div class="product-description p-3" style="line-height: 1.8; color: rgba(0,0,0,.8);">
                 @Html.Raw(Model.MoTa?.Replace("\n", "<br>"))
             </div>
        </div>
        
        <!-- Reviews Section -->
        <div class="shopee-box" id="reviews-section">
            <h5 class="review-section-header">ĐÁNH GIÁ SẢN PHẨM</h5>
            
            <!-- Write Review Form -->
            <div class="mb-4">
                 @if (Context.Session.GetInt32("KhachHangId") != null)
                 {
                    <div style="background: linear-gradient(135deg, #eff6ff, #f0f9ff); border-radius: 16px; padding: 28px; border: 1px solid #dbeafe; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(59,130,246,0.05); border-radius: 50%;"></div>
                        <div class="d-flex align-items-center mb-4">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <i class="fas fa-pen" style="color: white; font-size: 0.85rem;"></i>
                            </div>
                            <div>
                                <h6 class="m-0 fw-bold" style="color: #1e3a5f;">Viết đánh giá của bạn</h6>
                                <span class="small" style="color: #6b7280;">Chia sẻ trải nghiệm để giúp người mua khác</span>
                            </div>
                        </div>
                        <form id="reviewForm">
                            <div class="mb-4">
                                <label class="form-label fw-semibold" style="color: #374151;">Đánh giá sao <span class="text-danger">*</span></label>
                                <div class="d-flex align-items-center gap-3">
                                    <div class="star-rating" id="starRatingInput" style="display: flex; gap: 4px;">
                                        <i class="fas fa-star" data-value="1" style="font-size: 28px; cursor: pointer; transition: all 0.2s;"></i>
                                        <i class="fas fa-star" data-value="2" style="font-size: 28px; cursor: pointer; transition: all 0.2s;"></i>
                                        <i class="fas fa-star" data-value="3" style="font-size: 28px; cursor: pointer; transition: all 0.2s;"></i>
                                        <i class="fas fa-star" data-value="4" style="font-size: 28px; cursor: pointer; transition: all 0.2s;"></i>
                                        <i class="fas fa-star" data-value="5" style="font-size: 28px; cursor: pointer; transition: all 0.2s;"></i>
                                        <input type="hidden" id="ratingValue" name="rating" value="5">
                                    </div>
                                    <span id="ratingText" class="fw-semibold" style="color: #f59e0b; font-size: 0.9rem;">Tuyệt vời</span>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="form-label fw-semibold" style="color: #374151;">Nhận xét của bạn</label>
                                <textarea class="form-control" id="reviewComment" rows="4" 
                                          placeholder="Chia sẻ trải nghiệm của bạn về sản phẩm này..."
                                          style="border: 1.5px solid #e5e7eb; border-radius: 12px; padding: 14px; font-size: 0.9rem; resize: vertical; transition: border-color 0.3s;"
                                          onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'"
                                          onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
                                          ></textarea>
                                <div class="text-end mt-1"><span id="charCount" class="small text-muted">0/500</span></div>
                            </div>
                            
                            <button type="submit" class="btn px-5 py-2 fw-bold" id="btnSubmitReview"
                                    style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 10px; font-size: 0.95rem; transition: all 0.3s;"
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(59,130,246,0.4)'"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <i class="fas fa-paper-plane me-2"></i> Gửi đánh giá
                            </button>
                        </form>
                    </div>
                 }
                 else
                 {
                    <div style="background: linear-gradient(135deg, #eff6ff, #f0f9ff); border-radius: 12px; padding: 20px; border: 1px solid #dbeafe; display: flex; align-items: center; gap: 16px;">
                        <div style="width: 48px; height: 48px; background: #dbeafe; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas fa-sign-in-alt" style="color: #3b82f6; font-size: 1.1rem;"></i>
                        </div>
                        <div>
                             <span style="color: #374151;">Vui lòng</span> <a href="/Account/Login?returnUrl=/SanPham/ProductDetail/@Model.ID" style="font-weight: 700; text-decoration: none; color: #2563eb;">đăng nhập</a> <span style="color: #374151;">để viết đánh giá sản phẩm.</span>
                        </div>
                    </div>
                 }
            </div>

            <!-- Filters -->
             <div class="review-filters bg-light p-4 rounded-4 border border-light mb-4 d-flex align-items-center gap-2 flex-wrap" style="background-color: #fffbf8; border: 1px solid #f9ede5;">
                <div class="text-center me-4">
                     <div class="text-danger fs-3 fw-bold"><span id="avgScore">4.9</span> <span class="fs-6 text-muted">trên 5</span></div>
                     <div class="text-warning small" id="avgStarsDisplay">
                         <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                     </div>
                </div>
                <button class="btn btn-outline-secondary bg-white px-3 active filter-btn rounded-pill border-0 shadow-sm" data-filter="all">Tất cả</button>
                <button class="btn btn-outline-secondary bg-white px-3 filter-btn rounded-pill border-0 shadow-sm" data-filter="5">5 Sao</button>
                <button class="btn btn-outline-secondary bg-white px-3 filter-btn rounded-pill border-0 shadow-sm" data-filter="4">4 Sao</button>
                <button class="btn btn-outline-secondary bg-white px-3 filter-btn rounded-pill border-0 shadow-sm" data-filter="3">3 Sao</button>
                <button class="btn btn-outline-secondary bg-white px-3 filter-btn rounded-pill border-0 shadow-sm" data-filter="2">2 Sao</button>
                <button class="btn btn-outline-secondary bg-white px-3 filter-btn rounded-pill border-0 shadow-sm" data-filter="1">1 Sao</button>
            </div>

            <!-- Reviews List -->
            <div id="reviewsList" class="d-flex flex-column gap-3">
                <!-- Ajax Load -->
            </div>
        </div>

        <!-- Related Products -->
        @if (ViewBag.RelatedProducts != null)
        {
            <div class="mt-4">
                <h5 class="text-uppercase text-secondary fw-bold mb-3">SẢN PHẨM LIÊN QUAN</h5>
                <div class="row row-cols-2 row-cols-md-4 row-cols-lg-6 g-3">
                    @foreach (var item in (IEnumerable<QuanLyVatTu_ASP.Areas.Admin.Models.VatTu>)ViewBag.RelatedProducts)
                    {
                        <div class="col">
                            <div class="card h-100 border-0 shadow-sm hover-shadow transition-all rounded-4 overflow-hidden">
                                <a href="/SanPham/ProductDetail/@item.ID" class="text-decoration-none text-dark">
                                    <div class="position-relative bg-white rounded-4 m-2 border border-light">
                                        <img src="@GetProductImage(item.ID, item.HinhAnh)" 
                                             class="card-img-top p-2" alt="@item.TenVatTu" style="height: 180px; object-fit: contain;">
                                        @if(item.HinhAnh == null) {
                                            <!-- Fallback visible if image broken handled by error event ideally -->
                                        }
                                    </div>
                                    <div class="card-body p-3">
                                        <h6 class="card-title text-truncate mb-1 fw-bold text-dark">@item.TenVatTu</h6>
                                        <div class="d-flex justify-content-between align-items-center mt-2">
                                            <span class="text-danger fw-bold header-font">@(item.GiaBan?.ToString("N0") ?? "0")đ</span>
                                            <span class="text-muted small" style="font-size: 0.75rem;">Đã bán 123</span>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>

<!-- Add Cart Modal -->
<div class="modal fade" id="cartModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content text-center border-0 rounded-3">
      <div class="modal-body py-4">
          <div class="mb-3 text-success">
              <i class="fas fa-check-circle" style="font-size: 3rem;"></i>
          </div>
          <h5 class="fw-bold mb-2">Đã thêm vào giỏ</h5>
          <p class="text-muted small mb-4">Sản phẩm đã được thêm vào giỏ hàng của bạn.</p>
          <div class="d-grid gap-2">
              <a href="/GioHang/GioHang" class="btn btn-primary btn-sm">Xem giỏ hàng</a>
              <button type="button" class="btn btn-light btn-sm text-muted" data-bs-dismiss="modal">Mua tiếp</button>
          </div>
      </div>
    </div>
  </div>
</div>

@section Scripts {
    <script>
        const productId = @Model.ID;
        const maxStock = @Model.SoLuongTon;
        const ratingLabels = ['', 'Rất tệ', 'Tệ', 'Bình thường', 'Tốt', 'Tuyệt vời'];

        // Image Gallery
        function changeImage(el) {
            document.getElementById('currentImg').src = el.src;
            document.querySelectorAll('.active-thumb').forEach(t => t.classList.remove('active-thumb'));
            el.classList.add('active-thumb');
        }

        // Qty Validation
        function validateQty(input) {
            let val = parseInt(input.value);
            const warn = document.getElementById('qtyWarning');
            if (isNaN(val) || val < 1) {
                input.value = 1;
                warn.style.display = 'none';
                return;
            }
            if (val > maxStock) {
                input.value = maxStock;
                warn.querySelector('span').textContent = `Tối đa ${maxStock} sản phẩm`;
                warn.style.display = 'block';
                setTimeout(() => { warn.style.display = 'none'; }, 3000);
                return;
            }
            warn.style.display = 'none';
        }

        function updateQty(delta) {
            const input = document.getElementById('product-qty');
            let val = parseInt(input.value) + delta;
            if (val < 1) val = 1;
            if (val > maxStock) {
                val = maxStock;
                const warn = document.getElementById('qtyWarning');
                if (warn) {
                    warn.querySelector('span').textContent = `Tối đa ${maxStock} sản phẩm`;
                    warn.style.display = 'block';
                    setTimeout(() => { warn.style.display = 'none'; }, 3000);
                }
            }
            input.value = val;
        }

        // Add to Cart with stock validation
        window.addToCartAction = function(id) {
            const qtyInput = document.getElementById('product-qty');
            if (!qtyInput) { Swal.fire('Lỗi', 'Không tìm thấy ô nhập số lượng!', 'error'); return; }
            let qty = parseInt(qtyInput.value);
            
            if (isNaN(qty) || qty < 1) {
                Swal.fire('Lỗi', 'Số lượng không hợp lệ', 'error');
                return;
            }
            if (qty > maxStock) {
                Swal.fire('Vượt quá tồn kho', `Chỉ còn ${maxStock} sản phẩm trong kho.`, 'warning');
                qtyInput.value = maxStock;
                return;
            }
            const btn = document.getElementById('btnAddToCart');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Đang thêm...';

            $.post('/GioHang/AddToCart', { productId: id, quantity: qty }, function(res) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-shopping-cart me-2"></i> THÊM VÀO GIỎ HÀNG';
                if (res.success) {
                    new bootstrap.Modal(document.getElementById('cartModal')).show();
                    if (res.cartCount && $('.cart-count').length) $('.cart-count').text(res.cartCount);
                } else {
                    Swal.fire('Lỗi', res.message, 'error');
                }
            }).fail(function() {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-shopping-cart me-2"></i> THÊM VÀO GIỎ HÀNG';
                Swal.fire('Lỗi', 'Không thể kết nối đến server!', 'error');
            });
        };

        // Buy Now with stock validation
        window.buyNowAction = function(id) {
            const qtyInput = document.getElementById('product-qty');
            if (!qtyInput) { Swal.fire('Lỗi', 'Không tìm thấy ô nhập số lượng!', 'error'); return; }
            let qty = parseInt(qtyInput.value);
            
            if (isNaN(qty) || qty < 1) {
                Swal.fire('Lỗi', 'Số lượng không hợp lệ', 'error');
                return;
            }
            if (qty > maxStock) {
                Swal.fire('Vượt quá tồn kho', `Chỉ còn ${maxStock} sản phẩm trong kho.`, 'warning');
                return;
            }
            const btn = document.getElementById('btnBuyNow');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>';

            $.post('/GioHang/BuyNow', { productId: id, quantity: qty }, function(res) {
                if (res.success) {
                    window.location.href = "/ThanhToan/Checkout?isBuyNow=true";
                } else {
                    btn.disabled = false;
                    btn.innerHTML = 'Mua Ngay';
                    Swal.fire('Lỗi', res.message, 'error');
                }
            }).fail(function() {
                btn.disabled = false;
                btn.innerHTML = 'Mua Ngay';
                Swal.fire('Lỗi', 'Không thể kết nối đến server!', 'error');
            });
        };

        // Character counter for review
        const commentEl = document.getElementById('reviewComment');
        if (commentEl) {
            commentEl.addEventListener('input', function() {
                const len = this.value.length;
                document.getElementById('charCount').textContent = len + '/500';
                if (len > 500) this.value = this.value.substring(0, 500);
            });
        }

        // Reviews Logic
        $(document).ready(function() {
            loadReviews();

            // Star Interaction in Form
            $('#starRatingInput i').hover(
                function() {
                    const val = $(this).data('value');
                    $(this).parent().children('i').each(function() {
                        $(this).css('color', $(this).data('value') <= val ? '#fbbf24' : '#d1d5db');
                        $(this).css('transform', $(this).data('value') <= val ? 'scale(1.2)' : 'scale(1)');
                    });
                },
                function() {
                    const currentVal = parseInt($('#ratingValue').val());
                    $(this).parent().children('i').each(function() {
                        $(this).css('color', $(this).data('value') <= currentVal ? '#fbbf24' : '#d1d5db');
                        $(this).css('transform', 'scale(1)');
                    });
                }
            ).click(function() {
                const val = $(this).data('value');
                $('#ratingValue').val(val);
                $('#ratingText').text(ratingLabels[val]);
                $(this).parent().children('i').each(function() {
                    $(this).css('color', $(this).data('value') <= val ? '#fbbf24' : '#d1d5db');
                });
            });

            // Initialize stars (default 5)
            $('#starRatingInput i').each(function() {
                $(this).css('color', '#fbbf24').addClass('fas').removeClass('far');
            });

            // Filter Buttons
            $('.filter-btn').click(function() {
                $('.filter-btn').removeClass('active border-primary text-primary').addClass('btn-outline-secondary bg-white');
                $(this).removeClass('btn-outline-secondary bg-white').addClass('active border-primary text-primary bg-white');
                const filter = $(this).data('filter');
                loadReviews(filter === 'all' ? null : filter);
            });

            // Submit Review
            $('#reviewForm').on('submit', function(e) {
                e.preventDefault();
                var rating = parseInt($('#ratingValue').val());
                var comment = $('#reviewComment').val();
                
                if (!rating || rating < 1 || rating > 5) {
                    Swal.fire('Lỗi', 'Vui lòng chọn số sao đánh giá.', 'warning');
                    return;
                }

                var btn = document.getElementById('btnSubmitReview');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Đang gửi...';
                
                var xhrCreate = new XMLHttpRequest();
                xhrCreate.open('POST', '/DanhGia/Create', true);
                xhrCreate.setRequestHeader('Content-Type', 'application/json');
                xhrCreate.onload = function() {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-paper-plane me-2"></i> Gửi đánh giá';
                    var res = JSON.parse(xhrCreate.responseText);
                    if (res.success) {
                        $('#reviewForm')[0].reset();
                        $('#starRatingInput i').css('color', '#fbbf24');
                        $('#ratingValue').val(5);
                        $('#ratingText').text('Tuyệt vời');
                        $('#charCount').text('0/500');
                        // Load reviews FIRST, then show success toast
                        loadReviewsNoCache(function() {
                            Swal.fire({ icon: 'success', title: 'Cảm ơn bạn!', text: 'Đánh giá thành công.', confirmButtonColor: '#3b82f6', timer: 2000, timerProgressBar: true });
                        });
                    } else {
                        Swal.fire('Lỗi', res.message, 'error');
                    }
                };
                xhrCreate.onerror = function() {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-paper-plane me-2"></i> Gửi đánh giá';
                    Swal.fire('Lỗi', 'Không thể gửi đánh giá!', 'error');
                };
                xhrCreate.send(JSON.stringify({ maVatTu: productId, soSao: rating, binhLuan: comment }));
            });
        });

        // Load reviews using fetch (no cache)
        function loadReviewsNoCache(callback) {
            var url = '/DanhGia/GetReviews?maVatTu=' + productId + '&_=' + new Date().getTime();
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.setRequestHeader('Cache-Control', 'no-cache, no-store, must-revalidate');
            xhr.setRequestHeader('Pragma', 'no-cache');
            xhr.onload = function() {
                if (xhr.status === 200) {
                    var res = JSON.parse(xhr.responseText);
                    if (res.success) renderReviews(res);
                }
                if (typeof callback === 'function') callback();
            };
            xhr.onerror = function() {
                if (typeof callback === 'function') callback();
            };
            xhr.send();
        }

        function loadReviews(starFilter) {
            var url = '/DanhGia/GetReviews?maVatTu=' + productId + '&_=' + new Date().getTime();
            if (starFilter) url += '&soSao=' + starFilter;
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.setRequestHeader('Cache-Control', 'no-cache, no-store, must-revalidate');
            xhr.setRequestHeader('Pragma', 'no-cache');
            xhr.onload = function() {
                if (xhr.status === 200) {
                    var res = JSON.parse(xhr.responseText);
                    if (res.success) renderReviews(res);
                }
            };
            xhr.send();
        }

        function renderReviews(res) {
            var currentUserId = res.currentKhachHangId;
            $('#avgScore').text(res.stats.diemTrungBinh);
            var starsHtml = '';
            for (var i = 1; i <= 5; i++) {
                if (i <= Math.round(res.stats.diemTrungBinh)) starsHtml += '<i class="fas fa-star"></i>';
                else starsHtml += '<i class="far fa-star"></i>';
            }
            $('#avgStarsDisplay').html(starsHtml);
            $('#headerRatingStars').html(starsHtml);

            var list = document.getElementById('reviewsList');
            if (!list) return;
            list.innerHTML = '';

            if (!res.reviews || !res.reviews.length) {
                list.innerHTML = '<div class="text-center py-5"><i class="far fa-comment-dots" style="font-size:3rem;color:#d1d5db;"></i><p class="mt-3" style="color:#9ca3af;">Chưa có đánh giá nào. Hãy là người đầu tiên!</p></div>';
                return;
            }

            for (var idx = 0; idx < res.reviews.length; idx++) {
                var r = res.reviews[idx];
                var rStars = '';
                for (var j = 1; j <= 5; j++) {
                    if (j <= r.soSao) rStars += '<i class="fas fa-star" style="color:#fbbf24;"></i>';
                    else rStars += '<i class="far fa-star" style="color:#d1d5db;"></i>';
                }

                var isOwner = currentUserId && r.maKhachHang === currentUserId;
                var ownerBadge = isOwner ? ' <span class="badge bg-primary" style="font-size:0.65rem;vertical-align:middle;">Bạn</span>' : '';

                var replyBlock = '';
                if (r.phanHoi) {
                    replyBlock = '<div class="ms-5" style="background:#f9fafb;padding:14px 16px;border-radius:10px;margin-left:56px !important;border-left:3px solid #fbbf24;"><div class="d-flex align-items-center gap-2 mb-1"><span style="background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#1a1a2e;font-size:0.7rem;padding:2px 8px;border-radius:4px;font-weight:700;">SHOP</span><small style="color:#9ca3af;">' + new Date(r.ngayPhanHoi).toLocaleDateString('vi-VN') + '</small></div><p class="mb-0 small" style="color:#4b5563;">' + r.phanHoi + '</p></div>';
                }

                var editBtnHtml = isOwner ? '<button class="btn btn-sm p-0 ms-auto btn-edit-rv" data-rid="' + r.id + '" data-rss="' + r.soSao + '" data-rbl="' + encodeURIComponent(r.binhLuan || '') + '" style="color:#9ca3af;transition:color 0.2s;" onmouseover="this.style.color=\'#f59e0b\'" onmouseout="this.style.color=\'#9ca3af\'" title="Sửa đánh giá"><i class="fas fa-pencil-alt"></i> Sửa</button>' : '';

                var div = document.createElement('div');
                div.style.cssText = 'padding:20px 0;border-bottom:1px solid #f3f4f6;';
                div.innerHTML =
                    '<div class="d-flex gap-3 mb-2">' +
                        '<img src="' + r.avatarUrl + '" class="rounded-circle" width="44" height="44" style="border:2px solid #e5e7eb;object-fit:cover;">' +
                        '<div class="flex-grow-1">' +
                            '<div class="d-flex justify-content-between align-items-start">' +
                                '<div>' +
                                    '<div class="fw-bold" style="color:#111827;">' + r.tenKhachHang + ownerBadge + '</div>' +
                                    '<div class="mt-1" id="review-stars-' + r.id + '">' + rStars + '</div>' +
                                '</div>' +
                                '<div class="d-flex align-items-center gap-2">' +
                                    '<span class="small" style="color:#9ca3af;">' + new Date(r.ngayDanhGia).toLocaleDateString('vi-VN') + '</span>' +
                                    editBtnHtml +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div id="review-content-' + r.id + '" class="mb-2 ms-5" style="padding-left:12px;">' +
                        '<p style="font-size:0.95rem;color:#374151;margin:0;">' + (r.binhLuan || '') + '</p>' +
                    '</div>' +
                    replyBlock +
                    '<div class="d-flex gap-3 mt-2" style="padding-left:56px;">' +
                        '<button class="btn btn-sm p-0 btn-like-rv" data-lid="' + r.id + '" style="color:#9ca3af;transition:color 0.2s;" onmouseover="this.style.color=\'#3b82f6\'" onmouseout="this.style.color=\'#9ca3af\'">' +
                            '<i class="far fa-thumbs-up"></i> <span>' + (r.luotThich || 0) + '</span> Hữu ích' +
                        '</button>' +
                    '</div>';
                list.appendChild(div);
            }

            // Attach edit handlers
            var editBtns = document.querySelectorAll('.btn-edit-rv');
            for (var e = 0; e < editBtns.length; e++) {
                editBtns[e].addEventListener('click', function() {
                    editReviewInline(parseInt(this.dataset.rid), parseInt(this.dataset.rss), decodeURIComponent(this.dataset.rbl), this);
                });
            }

            // Attach like handlers
            var likeBtns = document.querySelectorAll('.btn-like-rv');
            for (var l = 0; l < likeBtns.length; l++) {
                likeBtns[l].addEventListener('click', function() {
                    likeReview(parseInt(this.dataset.lid), this);
                });
            }
        }

        function editReviewInline(reviewId, currentSoSao, currentBinhLuan, editBtn) {
            if (document.getElementById('edit-area-' + reviewId)) return;
            var contentDiv = document.getElementById('review-content-' + reviewId);
            if (!contentDiv) return;
            editBtn.style.display = 'none';
            var originalHTML = contentDiv.innerHTML;

            var starPickerHtml = '<div id="edit-stars-' + reviewId + '" style="margin-bottom:8px;">';
            for (var i = 1; i <= 5; i++) {
                var cls2 = i <= currentSoSao ? 'fas' : 'far';
                var clr2 = i <= currentSoSao ? '#fbbf24' : '#d1d5db';
                starPickerHtml += '<i class="' + cls2 + ' fa-star inline-star-pick" data-val="' + i + '" data-review="' + reviewId + '" style="cursor:pointer;font-size:1.1rem;color:' + clr2 + ';margin-right:3px;"></i>';
            }
            starPickerHtml += '<input type="hidden" id="edit-sosao-' + reviewId + '" value="' + currentSoSao + '"></div>';

            contentDiv.innerHTML =
                '<div id="edit-area-' + reviewId + '">' +
                    starPickerHtml +
                    '<textarea id="edit-textarea-' + reviewId + '" style="width:100%;min-height:60px;max-height:150px;padding:10px 12px;border:2px solid #3b82f6;border-radius:10px;font-size:0.95rem;color:#374151;resize:none;outline:none;font-family:inherit;background:#f8fafc;" maxlength="500">' + (currentBinhLuan || '') + '</textarea>' +
                    '<div style="display:flex;align-items:center;justify-content:space-between;margin-top:6px;">' +
                        '<span style="font-size:0.75rem;color:#9ca3af;">Enter = Lưu · Esc = Hủy</span>' +
                        '<div style="display:flex;gap:6px;">' +
                            '<button id="edit-cancel-' + reviewId + '" class="btn btn-sm btn-outline-secondary" style="font-size:0.8rem;">Hủy</button>' +
                            '<button id="edit-save-' + reviewId + '" class="btn btn-sm btn-primary" style="font-size:0.8rem;"><i class="fas fa-check me-1"></i>Lưu</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';

            var textarea = document.getElementById('edit-textarea-' + reviewId);
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            textarea.style.height = 'auto'; textarea.style.height = textarea.scrollHeight + 'px';
            textarea.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px'; });

            var stars = document.querySelectorAll('#edit-stars-' + reviewId + ' .inline-star-pick');
            for (var s = 0; s < stars.length; s++) {
                stars[s].addEventListener('click', function() {
                    var val = parseInt(this.dataset.val);
                    document.getElementById('edit-sosao-' + this.dataset.review).value = val;
                    var allSt = document.querySelectorAll('#edit-stars-' + this.dataset.review + ' .inline-star-pick');
                    for (var k = 0; k < allSt.length; k++) {
                        if (k < val) { allSt[k].className = 'fas fa-star inline-star-pick'; allSt[k].style.color = '#fbbf24'; }
                        else { allSt[k].className = 'far fa-star inline-star-pick'; allSt[k].style.color = '#d1d5db'; }
                    }
                });
            }
            function cancelEdit() { contentDiv.innerHTML = originalHTML; editBtn.style.display = ''; }
            function saveEdit() {
                var newBl = document.getElementById('edit-textarea-' + reviewId).value;
                var newSs = parseInt(document.getElementById('edit-sosao-' + reviewId).value);
                var svBtn = document.getElementById('edit-save-' + reviewId);
                if (svBtn) { svBtn.disabled = true; svBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; }
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/DanhGia/Update', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.onload = function() {
                    var data = JSON.parse(xhr.responseText);
                    if (data.success) { loadReviewsNoCache(); }
                    else { Swal.fire('Lỗi', data.message, 'error'); cancelEdit(); }
                };
                xhr.onerror = function() { Swal.fire('Lỗi', 'Lỗi kết nối!', 'error'); cancelEdit(); };
                xhr.send(JSON.stringify({ id: reviewId, soSao: newSs, binhLuan: newBl }));
            }
            textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); saveEdit(); }
                if (e.key === 'Escape') { e.preventDefault(); cancelEdit(); }
            });
            document.getElementById('edit-cancel-' + reviewId).addEventListener('click', cancelEdit);
            document.getElementById('edit-save-' + reviewId).addEventListener('click', saveEdit);
        }

        function likeReview(id, btn) {
            var xhr3 = new XMLHttpRequest();
            xhr3.open('POST', '/DanhGia/Like', true);
            xhr3.setRequestHeader('Content-Type', 'application/json');
            xhr3.onload = function() {
                var res = JSON.parse(xhr3.responseText);
                if (res.success) {
                    var span = btn.querySelector('span');
                    if (span) span.textContent = res.luotThich;
                    var icon = btn.querySelector('i');
                    if (res.liked) {
                        btn.style.color = '#3b82f6';
                        if (icon) { icon.classList.remove('far'); icon.classList.add('fas'); }
                    } else {
                        btn.style.color = '#9ca3af';
                        if (icon) { icon.classList.remove('fas'); icon.classList.add('far'); }
                    }
                }
            };
            xhr3.send(JSON.stringify({ maDanhGia: id }));
        }
    </script>
}