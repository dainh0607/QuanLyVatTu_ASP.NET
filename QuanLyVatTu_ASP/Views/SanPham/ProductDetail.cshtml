@model QuanLyVatTu_ASP.Areas.Admin.Models.VatTu
@{
    ViewData["Title"] = Model.TenVatTu;
    Layout = "~/Views/Shared/_Layout_Customer.cshtml";
}

<div class="product-detail-page py-5 bg-white">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb bg-transparent p-0 mb-4">
                <li class="breadcrumb-item"><a href="/" class="text-decoration-none text-muted">Trang chủ</a></li>
                <li class="breadcrumb-item"><a href="/SanPham" class="text-decoration-none text-muted">Danh mục sản phẩm</a></li>
                <li class="breadcrumb-item active text-dark fw-bold" aria-current="page">@Model.TenVatTu</li>
            </ol>
        </nav>

        <div class="row g-4">
            <div class="col-lg-5 col-md-6">
                <div class="product-gallery">
                    <div class="main-image mb-3 border rounded overflow-hidden position-relative">
                        <img src="https://placehold.co/600x600?text=@Model.TenVatTu" id="currentImg" class="img-fluid w-100" alt="@Model.TenVatTu" style="object-fit: cover; aspect-ratio: 1/1;">
                    </div>
                    <div class="d-flex gap-2 thumbnail-list">
                        <img src="https://placehold.co/100x100?text=1" class="img-thumbnail active-thumb" onclick="changeImage(this)">
                        <img src="https://placehold.co/100x100?text=2" class="img-thumbnail" onclick="changeImage(this)">
                        <img src="https://placehold.co/100x100?text=3" class="img-thumbnail" onclick="changeImage(this)">
                        <img src="https://placehold.co/100x100?text=4" class="img-thumbnail" onclick="changeImage(this)">
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-6">
                <h1 class="fw-bold h3 mb-2">@Model.TenVatTu</h1>
                
                <div class="mb-3">
                    <span class="text-warning fw-bold h4">@(Model.GiaBan?.ToString("N0") ?? "0")đ</span>
                </div>

                <div class="mb-3 text-muted" style="font-size: 0.9rem;">
                    <p class="mb-1">Mã sản phẩm: <strong>@Model.ID</strong></p>
                    <p class="mb-1">Tình trạng: 
                        @if (Model.SoLuongTon > 0)
                        {
                            <span class="text-success fw-bold">Còn hàng</span>
                        }
                        else
                        {
                            <span class="text-danger fw-bold">Hết hàng</span>
                        }
                    </p>
                </div>

                <div class="product-description mb-4 text-secondary">
                    <p>@Model.MoTa</p>
                    <p>Sản phẩm chất lượng cao, bền bỉ, phù hợp với mọi nhu cầu sử dụng của gia đình và công trình.</p>
                </div>

                @if (Model.SoLuongTon > 0)
                {
                    <div class="action-area">
                        <label class="mb-2 fw-bold d-block">Số lượng:</label>
                        <div class="d-flex align-items-center gap-3 mb-4">
                            <div class="input-group quantity-group" style="width: 140px;">
                                <button class="btn btn-outline-secondary" type="button" onclick="updateQty(-1)">-</button>
                                <input type="number" id="qty" class="form-control text-center border-secondary" value="1" min="1" max="@Model.SoLuongTon">
                                <button class="btn btn-outline-secondary" type="button" onclick="updateQty(1)">+</button>
                            </div>
                        </div>

                        <div class="d-flex gap-2 w-100">
                            <button class="btn btn-dark flex-grow-1 py-3 rounded-3 fw-bold text-uppercase" onclick="addToCart(@Model.ID, document.getElementById('qty').value)">
                                Thêm vào giỏ hàng
                            </button>
                            <button class="btn btn-danger flex-grow-1 py-3 rounded-3 fw-bold text-uppercase" onclick="buyNow(@Model.ID)">
                                Mua ngay
                            </button>
                        </div>
                    </div>
                }
                else
                {
                    <button class="btn btn-secondary w-100 py-3 rounded-3" disabled>Tạm hết hàng</button>
                }
            </div>

            <div class="col-lg-3 mt-4 mt-lg-0">
                <div class="service-box bg-light p-4 rounded-3 h-100">
                    <ul class="list-unstyled mb-0 d-flex flex-column gap-3">
                        <li class="d-flex gap-3">
                            <i class="fas fa-phone-alt text-danger mt-1"></i>
                            <div>
                                <strong class="d-block">SĐT/Zalo:</strong>
                                <span>0302370432</span>
                            </div>
                        </li>
                        <li class="d-flex gap-3">
                            <i class="fas fa-truck text-warning mt-1"></i>
                            <div>
                                <strong class="d-block">Giao hàng nhanh chóng</strong>
                                <span class="text-muted small">Vận chuyển toàn quốc</span>
                            </div>
                        </li>
                        <li class="d-flex gap-3">
                            <i class="fas fa-clock text-primary mt-1"></i>
                            <div>
                                <strong class="d-block">Giờ làm việc</strong>
                                <span class="text-muted small">8h30 - 17h30 (T2 - T7)</span>
                            </div>
                        </li>
                        <li class="d-flex gap-3">
                            <i class="fas fa-globe text-info mt-1"></i>
                            <div>
                                <strong class="d-block">Mua online:</strong>
                                <span class="text-muted small">cuahangvattu.com</span>
                            </div>
                        </li>
                        <li class="d-flex gap-3">
                            <i class="fas fa-sync-alt text-success mt-1"></i>
                            <div>
                                <strong class="d-block">Đổi trả dễ dàng</strong>
                                <span class="text-muted small">Chính sách đổi trả trong 7 ngày</span>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="related-products mt-5 pt-5 border-top">
            <h3 class="fw-bold mb-4">Sản phẩm liên quan</h3>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4">
                @{
                    var relatedProducts = ViewBag.RelatedProducts as IEnumerable<QuanLyVatTu_ASP.Areas.Admin.Models.VatTu>;
                }
                @if (relatedProducts != null && relatedProducts.Any())
                {
                    @foreach(var item in relatedProducts)
                    {
                        <div class="col">
                            <div class="card h-100 border-0 shadow-sm product-card-hover">
                                <div class="position-relative overflow-hidden rounded-top">
                                    <!-- Sử dụng placeholder vì chưa có trường ảnh trong DB -->
                                    <img src="https://placehold.co/300x200?text=@System.Net.WebUtility.UrlEncode(item.TenVatTu)" class="card-img-top" alt="@item.TenVatTu" style="height: 200px; object-fit: cover;">
                                </div>
                                <div class="card-body">
                                    <h6 class="card-title fw-bold text-truncate" title="@item.TenVatTu">@item.TenVatTu</h6>
                                    <p class="card-text text-warning fw-bold">@(item.GiaBan?.ToString("N0") ?? "0")đ</p>
                                </div>
                                <div class="card-footer bg-transparent border-0 pb-3">
                                    <a href="/SanPham/ProductDetail/@item.ID" class="btn btn-light w-100 fw-bold">Xem chi tiết</a>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                     <div class="col-12 text-center text-muted py-4">
                        <p>Không có sản phẩm liên quan nào.</p>
                    </div>
                }
            </div>
        </div>

        <!-- Product Reviews Section -->
        <div class="product-reviews mt-5 pt-5 border-top" id="reviewsSection">
            <div class="reviews-header">
                <h3 class="reviews-title"><i class="fas fa-star"></i> Đánh giá sản phẩm</h3>
            </div>

            <!-- Stats Overview -->
            <div class="reviews-overview" id="reviewsOverview">
                <div class="rating-big">
                    <div class="rating-score" id="avgScore">0</div>
                    <span class="rating-max">/5.0</span>
                    <div class="rating-stars-big" id="avgStars">
                        <i class="fas fa-star empty"></i>
                        <i class="fas fa-star empty"></i>
                        <i class="fas fa-star empty"></i>
                        <i class="fas fa-star empty"></i>
                        <i class="fas fa-star empty"></i>
                    </div>
                    <div class="rating-count"><span id="totalReviews">0</span> đánh giá</div>
                </div>
                <div class="rating-breakdown">
                    <div class="breakdown-row" data-star="5">
                        <div class="breakdown-stars">
                            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                        </div>
                        <div class="breakdown-bar"><div class="breakdown-fill" id="bar5" style="width: 0%"></div></div>
                        <span class="breakdown-percent" id="percent5">0%</span>
                    </div>
                    <div class="breakdown-row" data-star="4">
                        <div class="breakdown-stars">
                            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star empty"></i>
                        </div>
                        <div class="breakdown-bar"><div class="breakdown-fill" id="bar4" style="width: 0%"></div></div>
                        <span class="breakdown-percent" id="percent4">0%</span>
                    </div>
                    <div class="breakdown-row" data-star="3">
                        <div class="breakdown-stars">
                            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star empty"></i><i class="fas fa-star empty"></i>
                        </div>
                        <div class="breakdown-bar"><div class="breakdown-fill" id="bar3" style="width: 0%"></div></div>
                        <span class="breakdown-percent" id="percent3">0%</span>
                    </div>
                    <div class="breakdown-row" data-star="2">
                        <div class="breakdown-stars">
                            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star empty"></i><i class="fas fa-star empty"></i><i class="fas fa-star empty"></i>
                        </div>
                        <div class="breakdown-bar"><div class="breakdown-fill" id="bar2" style="width: 0%"></div></div>
                        <span class="breakdown-percent" id="percent2">0%</span>
                    </div>
                    <div class="breakdown-row" data-star="1">
                        <div class="breakdown-stars">
                            <i class="fas fa-star"></i><i class="fas fa-star empty"></i><i class="fas fa-star empty"></i><i class="fas fa-star empty"></i><i class="fas fa-star empty"></i>
                        </div>
                        <div class="breakdown-bar"><div class="breakdown-fill" id="bar1" style="width: 0%"></div></div>
                        <span class="breakdown-percent" id="percent1">0%</span>
                    </div>
                </div>
            </div>

            <!-- Write Review Section -->
            @if (Context.Session.GetInt32("KhachHangId") != null)
            {
                <div class="write-review-section" id="writeReviewForm">
                    <div class="write-review-header">
                        <i class="fas fa-edit"></i>
                        <h4>Viết đánh giá của bạn</h4>
                    </div>
                    <form id="reviewForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="rating-group">
                                    <label>Đánh giá sao <span class="text-danger">*</span></label>
                                    <div class="star-rating-input">
                                        <input type="radio" id="star5" name="rating" value="5"><label for="star5"><i class="fas fa-star"></i></label>
                                        <input type="radio" id="star4" name="rating" value="4"><label for="star4"><i class="fas fa-star"></i></label>
                                        <input type="radio" id="star3" name="rating" value="3"><label for="star3"><i class="fas fa-star"></i></label>
                                        <input type="radio" id="star2" name="rating" value="2"><label for="star2"><i class="fas fa-star"></i></label>
                                        <input type="radio" id="star1" name="rating" value="1"><label for="star1"><i class="fas fa-star"></i></label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="rating-group">
                                    <label>Chất lượng sản phẩm</label>
                                    <div class="star-rating-input">
                                        <input type="radio" id="quality5" name="quality" value="5"><label for="quality5"><i class="fas fa-star"></i></label>
                                        <input type="radio" id="quality4" name="quality" value="4"><label for="quality4"><i class="fas fa-star"></i></label>
                                        <input type="radio" id="quality3" name="quality" value="3"><label for="quality3"><i class="fas fa-star"></i></label>
                                        <input type="radio" id="quality2" name="quality" value="2"><label for="quality2"><i class="fas fa-star"></i></label>
                                        <input type="radio" id="quality1" name="quality" value="1"><label for="quality1"><i class="fas fa-star"></i></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="rating-group">
                            <label>Nhận xét của bạn</label>
                            <textarea class="review-textarea" id="reviewComment" placeholder="Chia sẻ trải nghiệm của bạn về sản phẩm này..."></textarea>
                        </div>
                        <button type="submit" class="submit-review-btn">
                            <i class="fas fa-paper-plane"></i> Gửi đánh giá
                        </button>
                    </form>
                </div>
            }
            else
            {
                <div class="login-prompt">
                    <i class="fas fa-info-circle"></i>
                    <p>Vui lòng <a href="/Account/Login">đăng nhập</a> để viết đánh giá sản phẩm.</p>
                </div>
            }

            <!-- Filter Buttons -->
            <div class="review-filters">
                <button class="filter-btn active" data-filter="all">Tất cả</button>
                <button class="filter-btn" data-filter="5">5 sao</button>
                <button class="filter-btn" data-filter="4">4 sao</button>
                <button class="filter-btn" data-filter="3">3 sao</button>
                <button class="filter-btn" data-filter="2">2 sao</button>
                <button class="filter-btn" data-filter="1">1 sao</button>
            </div>

            <!-- Reviews List -->
            <div class="reviews-list" id="reviewsList">
                <!-- Reviews will be loaded here via AJAX -->
                <div class="reviews-empty">
                    <i class="far fa-comment-dots"></i>
                    <h4>Chưa có đánh giá nào</h4>
                    <p>Hãy là người đầu tiên đánh giá sản phẩm này!</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Thông báo thêm giỏ hàng -->
<div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold text-success" id="cartModalLabel">
            <i class="fas fa-check-circle me-2"></i>Thành công
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center py-4">
        <p class="mb-0 fs-5">Sản phẩm đã được thêm vào giỏ hàng!</p>
      </div>
      <div class="modal-footer border-0 justify-content-center pb-4">
        <button type="button" class="btn btn-outline-secondary px-4 rounded-3" data-bs-dismiss="modal">Tiếp tục mua sắm</button>
        <a href="/GioHang/GioHang" class="btn btn-primary px-4 rounded-3">Xem giỏ hàng</a>
      </div>
    </div>
  </div>
</div>

@section Scripts {
    <script>
        var productId = @Model.ID;

        // Xử lý nút tăng giảm số lượng
        function updateQty(change) {
            var input = document.getElementById('qty');
            var newVal = parseInt(input.value) + change;
            var max = parseInt(input.getAttribute('max'));
            
            if (newVal >= 1 && newVal <= max) {
                input.value = newVal;
            }
        }

        // Xử lý đổi ảnh khi click thumbnail
        function changeImage(element) {
            var mainImg = document.getElementById('currentImg');
            mainImg.src = element.src.replace('100x100', '600x600');
            
            document.querySelectorAll('.thumbnail-list img').forEach(img => img.classList.remove('active-thumb', 'border-primary'));
            element.classList.add('active-thumb', 'border', 'border-primary');
        }

        // Ajax thêm vào giỏ hàng
        function addToCart(id) {
            var qty = $('#qty').val();
            $.post('/GioHang/AddToCart', { productId: id, quantity: qty }, function(res) {
                if(res.success) {
                    var myModal = new bootstrap.Modal(document.getElementById('cartModal'));
                    myModal.show();
                    if(res.count) $('.cart-count').text(res.count);
                } else {
                    alert("Có lỗi xảy ra: " + res.message);
                }
            });
        }

        // Mua ngay
        function buyNow(id) {
            var qty = $('#qty').val();
            $.post('/GioHang/AddToCart', { productId: id, quantity: qty }, function(res) {
                if(res.success) {
                    window.location.href = "/GioHang/GioHang";
                } else {
                    alert("Có lỗi xảy ra: " + res.message);
                }
            });
        }

        // ============ REVIEWS FUNCTIONALITY ============
        
        // Load reviews on page load
        $(document).ready(function() {
            loadReviews();
            
            // Filter buttons
            $('.filter-btn').on('click', function() {
                $('.filter-btn').removeClass('active');
                $(this).addClass('active');
                var filter = $(this).data('filter');
                loadReviews(filter === 'all' ? null : filter);
            });
            
            // Breakdown row click
            $('.breakdown-row').on('click', function() {
                var star = $(this).data('star');
                $('.filter-btn').removeClass('active');
                $('.filter-btn[data-filter="' + star + '"]').addClass('active');
                loadReviews(star);
            });
            
            // Submit review form
            $('#reviewForm').on('submit', function(e) {
                e.preventDefault();
                submitReview();
            });
        });

        function loadReviews(starFilter) {
            var url = '/DanhGia/GetReviews?maVatTu=' + productId;
            if (starFilter) url += '&soSao=' + starFilter;
            
            $.get(url, function(res) {
                if (res.success) {
                    updateStats(res.stats);
                    renderReviews(res.reviews);
                }
            });
        }

        function updateStats(stats) {
            $('#avgScore').text(stats.diemTrungBinh);
            $('#totalReviews').text(stats.tongSo);
            
            // Update stars
            var fullStars = Math.floor(stats.diemTrungBinh);
            var starsHtml = '';
            for (var i = 0; i < 5; i++) {
                starsHtml += '<i class="fas fa-star ' + (i < fullStars ? '' : 'empty') + '"></i>';
            }
            $('#avgStars').html(starsHtml);
            
            // Update breakdown bars
            var total = stats.tongSo || 1;
            for (var i = 1; i <= 5; i++) {
                var count = stats['sao' + i];
                var percent = Math.round((count / total) * 100);
                $('#bar' + i).css('width', percent + '%');
                $('#percent' + i).text(percent + '%');
            }
        }

        function renderReviews(reviews) {
            var container = $('#reviewsList');
            
            if (!reviews || reviews.length === 0) {
                container.html(`
                    <div class="reviews-empty">
                        <i class="far fa-comment-dots"></i>
                        <h4>Chưa có đánh giá nào</h4>
                        <p>Hãy là người đầu tiên đánh giá sản phẩm này!</p>
                    </div>
                `);
                return;
            }
            
            var html = '';
            reviews.forEach(function(r) {
                var starsHtml = '';
                for (var i = 0; i < 5; i++) {
                    starsHtml += '<i class="fas fa-star ' + (i < r.soSao ? '' : 'empty') + '"></i>';
                }
                
                var dateStr = new Date(r.ngayDanhGia).toLocaleDateString('vi-VN');
                
                html += `
                    <div class="review-card" data-id="${r.id}">
                        <div class="review-header">
                            <img src="${r.avatarUrl}" alt="Avatar" class="review-avatar">
                            <div class="review-info">
                                <h5 class="review-author">${r.tenKhachHang}</h5>
                                <div class="review-meta">
                                    <div class="review-stars">${starsHtml}</div>
                                    <span class="review-date">${dateStr}</span>
                                    <span class="review-quality">Chất lượng: ${r.chatLuongSanPham}/5</span>
                                </div>
                            </div>
                        </div>
                        ${r.binhLuan ? '<p class="review-content">' + r.binhLuan + '</p>' : ''}
                        <div class="review-footer">
                            <button class="review-like-btn" onclick="likeReview(${r.id}, this)">
                                <i class="far fa-thumbs-up"></i> <span>${r.luotThich}</span>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.html(html);
        }

        function submitReview() {
            var rating = $('input[name="rating"]:checked').val();
            var quality = $('input[name="quality"]:checked').val() || rating;
            var comment = $('#reviewComment').val();
            
            if (!rating) {
                alert('Vui lòng chọn số sao đánh giá');
                return;
            }
            
            $.ajax({
                url: '/DanhGia/Create',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    maVatTu: productId,
                    soSao: parseInt(rating),
                    chatLuongSanPham: parseInt(quality),
                    binhLuan: comment
                }),
                success: function(res) {
                    if (res.success) {
                        alert('Đánh giá thành công!');
                        $('#reviewForm')[0].reset();
                        loadReviews();
                        $('#writeReviewForm').hide();
                    } else {
                        alert(res.message);
                    }
                },
                error: function() {
                    alert('Có lỗi xảy ra, vui lòng thử lại');
                }
            });
        }

        function likeReview(reviewId, btn) {
            $.ajax({
                url: '/DanhGia/Like',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ maDanhGia: reviewId }),
                success: function(res) {
                    if (res.success) {
                        $(btn).find('span').text(res.luotThich);
                        if (res.liked) {
                            $(btn).addClass('liked');
                            $(btn).find('i').removeClass('far').addClass('fas');
                        } else {
                            $(btn).removeClass('liked');
                            $(btn).find('i').removeClass('fas').addClass('far');
                        }
                    } else {
                        alert(res.message);
                    }
                }
            });
        }
    </script>
}

@section Styles {
    <link rel="stylesheet" href="~/user/css/reviews.css" />
    <style>
        /* CSS Riêng cho trang chi tiết */
        .product-gallery .img-thumbnail {
            cursor: pointer;
            width: 80px;
            height: 80px;
            object-fit: cover;
            opacity: 0.6;
            transition: 0.3s;
        }
        .product-gallery .img-thumbnail:hover, 
        .product-gallery .img-thumbnail.active-thumb {
            opacity: 1;
            border-color: var(--bs-primary) !important;
        }
        
        .quantity-group input::-webkit-outer-spin-button,
        .quantity-group input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Hiệu ứng hover cho thẻ sản phẩm liên quan */
        .product-card-hover {
            transition: transform 0.2s;
        }
        .product-card-hover:hover {
            transform: translateY(-5px);
        }

        .service-box {
            background-color: #f8f9fa; /* Màu xám nhạt giống ảnh */
        }
        .btn-dark {
            background-color: #000;
            border: none;
        }
        .btn-dark:hover {
            background-color: #333;
        }
    </style>
}