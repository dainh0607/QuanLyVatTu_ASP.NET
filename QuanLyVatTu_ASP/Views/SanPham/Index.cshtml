@model IEnumerable<QuanLyVatTu_ASP.Areas.Admin.Models.VatTu>
@{
    ViewData["Title"] = "Danh mục sản phẩm";

    // Danh sách ảnh có sẵn trong folder wwwroot/user/images
    var availableImages = new string[] {
        "/user/images/Máy khoan cầm tay mẫu 1.jpg",
        "/user/images/Máy khoan cầm tay mẫu 2.jpg",
        "/user/images/Máy khoan cầm tay mẫu 3.jpg",
        "/user/images/Máy khoan cầm tay mẫu 4.jpg",
        "/user/images/Máy cắt - Uốn.jpg",
        "/user/images/Máy cắt bê tông KC16 (Không động cơ).jpg",
        "/user/images/Máy cắt sắt thủy lực cầm tay RC-25.jpg",
        "/user/images/Máy làm nền.jpg",
        "/user/images/Máy mài sàn bê tông DMS250.jpg",
        "/user/images/Máy xoa nền đôi Conmec (Ngồi lái).jpg",
        "/user/images/Máy xoa nền đơn Honda GX160.jpg",
        "/user/images/Máy đầm cóc Mikasa MT55.jpg",
        "/user/images/Máy đầm dùi chạy điện Jinlong 1.5KW.jpg",
        "/user/images/Máy đầm.jpg",
        "/user/images/Đầm bàn PC60.jpg"
    };

    // Helper function để lấy ảnh cho sản phẩm (xoay vòng theo index)
    Func<int, string?, string> GetProductImage = (index, existingImage) => {
        if (!string.IsNullOrEmpty(existingImage)) return existingImage;
        return availableImages[index % availableImages.Length];
    };
    
    // Helper to get names for active filters
    var categories = (ViewBag.Categories as IEnumerable<QuanLyVatTu_ASP.Areas.Admin.Models.LoaiVatTu>) ?? Enumerable.Empty<QuanLyVatTu_ASP.Areas.Admin.Models.LoaiVatTu>();
    var suppliers = (ViewBag.Suppliers as IEnumerable<QuanLyVatTu_ASP.Areas.Admin.Models.NhaCungCap>) ?? Enumerable.Empty<QuanLyVatTu_ASP.Areas.Admin.Models.NhaCungCap>();
    
    var activeLoaiIds = (ViewBag.CurrentLoaiIds as int[]) ?? Array.Empty<int>();
    var activeSupIds = (ViewBag.CurrentNhaCungCapIds as int[]) ?? Array.Empty<int>();
    var activePriceRanges = (ViewBag.CurrentPriceRanges as string[]) ?? Array.Empty<string>();
    
    // Dictionary for Price Ranges Display
    var priceRangeDisplay = new Dictionary<string, string> {
        { "under1m", "Dưới 1 triệu" },
        { "1m-2.5m", "1.000.000 - 2.500.000" },
        { "2.5m-5m", "2.500.000 - 5.000.000" },
        { "5m-10m", "5.000.000 - 10.000.000" },
        { "above10m", "Trên 10 triệu" }
    };
}

<div class="categories-page py-5" style="background-color: var(--md-sys-color-surface);">
    <div class="container">
        <div class="row g-4">
            <!-- Sidebar Filters -->
            <div class="col-lg-3 mb-4">
                <div class="card md-card border-0 h-100">
                    <div class="card-header bg-white border-bottom-0 pt-4 px-4 pb-0">
                        <h5 class="card-title fw-bold mb-0 text-dark d-flex align-items-center gap-2">
                            <i class="fas fa-filter text-primary"></i> Bộ lọc
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <form action="/SanPham" method="get" id="filterForm">
                            <input type="hidden" name="page" id="pageInput" value="1" />

                            <!-- Category Filter -->
                            <div class="mb-4">
                                <h6 class="fw-bold mb-3 small text-uppercase text-muted" style="letter-spacing: 0.5px;">Danh mục</h6>
                                <div class="filter-group d-flex flex-column gap-2" style="max-height: 200px; overflow-y: auto;">
                                    @foreach (var cat in categories)
                                    {
                                        <div class="form-check custom-checkbox">
                                            <input class="form-check-input" type="checkbox" name="loaiIds" value="@cat.ID" id="cat_@cat.ID" @(activeLoaiIds.Contains(cat.ID) ? "checked" : "") onchange="submitFilter()" style="border-radius: 4px;">
                                            <label class="form-check-label text-dark" for="cat_@cat.ID">@cat.TenLoaiVatTu</label>
                                        </div>
                                    }
                                </div>
                            </div>

                            <hr class="text-muted opacity-10 my-4">

                            <!-- Supplier Filter -->
                            <div class="mb-4">
                                <h6 class="fw-bold mb-3 small text-uppercase text-muted" style="letter-spacing: 0.5px;">Nhà cung cấp</h6>
                                <div class="filter-group d-flex flex-column gap-2" style="max-height: 200px; overflow-y: auto;">
                                    @foreach (var sup in suppliers)
                                    {
                                        <div class="form-check custom-checkbox">
                                            <input class="form-check-input" type="checkbox" name="nhaCungCapIds" value="@sup.ID" id="sup_@sup.ID" @(activeSupIds.Contains(sup.ID) ? "checked" : "") onchange="submitFilter()" style="border-radius: 4px;">
                                            <label class="form-check-label text-dark" for="sup_@sup.ID">@sup.TenNhaCungCap</label>
                                        </div>
                                    }
                                </div>
                            </div>

                            <hr class="text-muted opacity-10 my-4">

                            <!-- Price Filter -->
                            <div class="mb-3">
                                <h6 class="fw-bold mb-3 small text-uppercase text-muted" style="letter-spacing: 0.5px;">Khoảng giá</h6>
                                <div class="filter-group d-flex flex-column gap-2">
                                    @foreach (var range in priceRangeDisplay)
                                    {
                                         <div class="form-check custom-checkbox">
                                            <input class="form-check-input" type="checkbox" name="priceRanges" value="@range.Key" id="price_@range.Key" @(activePriceRanges.Contains(range.Key) ? "checked" : "") onchange="submitFilter()" style="border-radius: 4px;">
                                            <label class="form-check-label text-dark" for="price_@range.Key">@range.Value</label>
                                        </div>
                                    }
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Product List -->
            <div class="col-lg-9">
                
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                    <h2 class="fw-bold mb-0 text-dark" style="font-family: 'Google Sans', sans-serif;">Sản phẩm</h2>
                    <span class="text-muted">@(Model?.Count() ?? 0) kết quả</span>
                </div>

                <!-- Active Filters Chips -->
                @if (activeLoaiIds.Any() || activeSupIds.Any() || activePriceRanges.Any())
                {
                    <div class="active-filters mb-4 d-flex flex-wrap gap-2 align-items-center">
                        @foreach(var id in activeLoaiIds)
                        {
                            var name = categories.FirstOrDefault(c => c.ID == id)?.TenLoaiVatTu;
                            <span class="badge bg-primary-subtle text-primary border border-primary-subtle px-3 py-2 rounded-pill d-flex align-items-center gap-2">
                                <span>@name</span>
                                <i class="fas fa-times cursor-pointer" onclick="uncheckAndSubmit('cat_@id')"></i>
                            </span>
                        }

                        @foreach(var id in activeSupIds)
                        {
                            var name = suppliers.FirstOrDefault(s => s.ID == id)?.TenNhaCungCap;
                            <span class="badge bg-primary-subtle text-primary border border-primary-subtle px-3 py-2 rounded-pill d-flex align-items-center gap-2">
                                <span>@name</span>
                                <i class="fas fa-times cursor-pointer" onclick="uncheckAndSubmit('sup_@id')"></i>
                            </span>
                        }

                        @foreach(var range in activePriceRanges)
                        {
                            <span class="badge bg-primary-subtle text-primary border border-primary-subtle px-3 py-2 rounded-pill d-flex align-items-center gap-2">
                                <span>@priceRangeDisplay[range]</span>
                                <i class="fas fa-times cursor-pointer" onclick="uncheckAndSubmit('price_@range')"></i>
                            </span>
                        }

                        <a href="/SanPham" class="btn btn-link btn-sm text-danger text-decoration-none fw-bold ms-2">Xóa bộ lọc</a>
                    </div>
                }

                <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
                    @if (Model != null && Model.Any())
                    {
                        var productList = Model.ToList();
                        for (int i = 0; i < productList.Count; i++)
                        {
                            var product = productList[i];
                            var productImage = GetProductImage(i, product.HinhAnh);
                            <div class="col">
                                <div class="card md-card h-100 border-0 position-relative" style="transition: transform 0.2s, box-shadow 0.2s;">
                                     <div class="position-relative overflow-hidden bg-light rounded-top" style="height: 220px; border-radius: 12px 12px 0 0;">
                                        <a href="@Url.Action("ProductDetail", "SanPham", new { id = product.ID })" class="d-flex align-items-center justify-content-center h-100 w-100">
                                            <img src="@productImage" 
                                                 class="img-fluid p-4" 
                                                 alt="@product.TenVatTu" 
                                                 style="max-height: 100%; object-fit: contain; transition: transform 0.3s;">
                                        </a>
                                        <!-- Wishlist Icon -->
                                        <button class="btn btn-light rounded-circle shadow-sm position-absolute top-0 end-0 m-3 d-flex align-items-center justify-content-center" 
                                                onclick="addToWishlist(@product.ID)" 
                                                style="width: 36px; height: 36px; color: #aaa;"
                                                title="Thêm vào yêu thích">
                                            <i class="far fa-heart"></i>
                                        </button>
                                    </div>

                                    <div class="card-body d-flex flex-column p-3">
                                        <h6 class="card-title fw-bold mb-2 text-truncate">
                                            <a href="@Url.Action("ProductDetail", "SanPham", new { id = product.ID })" class="text-decoration-none text-dark" title="@product.TenVatTu">
                                                @product.TenVatTu
                                            </a>
                                        </h6>
                                        
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="text-warning small me-2">
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                            </div>
                                            <span class="text-muted small" style="font-size: 0.8rem;">(4.9)</span>
                                        </div>

                                        <div class="mt-auto">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <span class="fs-5 fw-bold" style="color: var(--md-sys-color-primary);">@(product.GiaBan?.ToString("N0") ?? "0")đ</span>
                                            </div>

                                            @if (product.SoLuongTon > 0)
                                            {
                                                <button class="btn btn-primary w-100 rounded-pill fw-bold" onclick="quickAdd(@product.ID)">
                                                    Thêm vào giỏ
                                                </button>
                                            }
                                            else
                                            {
                                                <button class="btn btn-secondary w-100 rounded-pill" disabled>Tạm hết hàng</button>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="col-12 py-5 text-center">
                            <div class="text-muted mb-3">
                                <i class="fas fa-search fa-3x text-light-emphasis"></i>
                            </div>
                            <h4 class="fw-bold text-secondary">Không tìm thấy sản phẩm</h4>
                            <p class="text-muted">Vui lòng thử lại với từ khóa hoặc bộ lọc khác.</p>
                            <a href="/SanPham" class="btn btn-outline-primary rounded-pill mt-2 px-4">Xóa bộ lọc</a>
                        </div>
                    }
                </div>

                <!-- Pagination -->
                @if (ViewBag.TotalPages > 1)
                {
                    <div class="d-flex justify-content-center mt-5">
                        <nav aria-label="Page navigation">
                            <ul class="pagination pagination-sm custom-pagination gap-1">
                                <!-- Previous -->
                                <li class="page-item @(ViewBag.CurrentPage == 1 ? "disabled" : "")">
                                    <a class="page-link rounded-circle border-0 shadow-sm" href="javascript:void(0)" onclick="goToPage(@(ViewBag.CurrentPage - 1))" aria-label="Previous">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                </li>

                                @for (int i = 1; i <= ViewBag.TotalPages; i++)
                                {
                                    <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                                        <a class="page-link rounded-circle border-0 shadow-sm" href="javascript:void(0)" onclick="goToPage(@i)">
                                            @i
                                        </a>
                                    </li>
                                }

                                <!-- Next -->
                                <li class="page-item @(ViewBag.CurrentPage == ViewBag.TotalPages ? "disabled" : "")">
                                    <a class="page-link rounded-circle border-0 shadow-sm" href="javascript:void(0)" onclick="goToPage(@(ViewBag.CurrentPage + 1))" aria-label="Next">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                }
            </div>
        </div>
    </div>
</div>
<!-- End Content -->

<link rel="stylesheet" href="~/user/css/categories.css" />

<style>
    /* Custom Round Pagination */
    .custom-pagination .page-item .page-link {
        width: 36px;
        height: 36px;
        border-radius: 50% !important;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 4px;
        border: 1px solid #dee2e6;
        color: #333;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.2s;
    }
    .custom-pagination .page-item.active .page-link {
        background-color: var(--bs-primary);
        border-color: var(--bs-primary);
        color: #fff;
        box-shadow: 0 4px 10px rgba(13, 110, 253, 0.3);
    }
    .custom-pagination .page-item.disabled .page-link {
        opacity: 0.6;
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }
    .custom-pagination .page-item:not(.active):not(.disabled) .page-link:hover {
        background-color: #e9ecef;
        color: var(--bs-primary);
        transform: translateY(-2px);
    }
    
    .cursor-pointer {
        cursor: pointer;
    }

    .filter-group::-webkit-scrollbar {
        width: 4px;
    }
    .filter-group::-webkit-scrollbar-track {
        background: #f1f1f1; 
    }
    .filter-group::-webkit-scrollbar-thumb {
        background: #ccc; 
        border-radius: 4px;
    }
    .filter-group::-webkit-scrollbar-thumb:hover {
        background: #aaa; 
    }
</style>

@section Scripts {
    <script>
        // Submit filter form when a checkbox changes
        function submitFilter() {
            // Reset to page 1 on new filter
            document.getElementById('pageInput').value = 1; 
            document.getElementById('filterForm').submit();
        }

        // Uncheck filter and submit (for Active Chips)
        function uncheckAndSubmit(elementId) {
            var el = document.getElementById(elementId);
            if(el) {
                el.checked = false;
                submitFilter();
            }
        }

        // Pagination Navigation
        function goToPage(page) {
            document.getElementById('pageInput').value = page;
            document.getElementById('filterForm').submit();
        }

        // Quick Add Function - uses global addToCart from layout
        function quickAdd(id) {
            if (typeof addToCart === 'function') {
                addToCart(id, 1);
            } else {
                // Fallback if global function not available
                $.post('/GioHang/AddToCart', { productId: id, quantity: 1 }, function(res) {
                    if(res.success) {
                        alert("Đã thêm vào giỏ hàng!"); 
                    } else {
                        alert(res.message);
                    }
                });
            }
        }
    </script>
}