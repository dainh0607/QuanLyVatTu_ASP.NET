@model IEnumerable<QuanLyVatTu_ASP.Areas.Admin.Models.VatTu>
@{
    ViewData["Title"] = "Danh mục sản phẩm";
    Layout = "~/Views/Shared/_Layout_Customer.cshtml";
    
    // Helper to get names for active filters
    var categories = (ViewBag.Categories as IEnumerable<QuanLyVatTu_ASP.Areas.Admin.Models.LoaiVatTu>) ?? Enumerable.Empty<QuanLyVatTu_ASP.Areas.Admin.Models.LoaiVatTu>();
    var suppliers = (ViewBag.Suppliers as IEnumerable<QuanLyVatTu_ASP.Areas.Admin.Models.NhaCungCap>) ?? Enumerable.Empty<QuanLyVatTu_ASP.Areas.Admin.Models.NhaCungCap>();
    
    var activeLoaiIds = (ViewBag.CurrentLoaiIds as int[]) ?? Array.Empty<int>();
    var activeSupIds = (ViewBag.CurrentNhaCungCapIds as int[]) ?? Array.Empty<int>();
    var activePriceRanges = (ViewBag.CurrentPriceRanges as string[]) ?? Array.Empty<string>();
    
    // Dictionary for Price Ranges Display
    var priceRangeDisplay = new Dictionary<string, string> {
        { "under1m", "Dưới 1 triệu" },
        { "1m-2.5m", "1.000.000 - 2.500.000" },
        { "2.5m-5m", "2.500.000 - 5.000.000" },
        { "5m-10m", "5.000.000 - 10.000.000" },
        { "above10m", "Trên 10 triệu" }
    };
}

<div class="categories-page py-5 bg-light">
    <div class="container">
        <div class="row">
            <!-- Sidebar Filters -->
            <div class="col-lg-3 mb-4">
                <div class="card border-0 shadow-sm rounded-3">
                    <div class="card-header bg-white border-bottom py-3">
                        <h5 class="card-title fw-bold mb-0 text-dark">
                            <i class="fas fa-filter me-2 text-primary"></i>Bộ lọc tìm kiếm
                        </h5>
                    </div>
                    <div class="card-body">
                        <form action="/SanPham" method="get" id="filterForm">
                            <input type="hidden" name="page" id="pageInput" value="1" />

                            <!-- Category Filter -->
                            <div class="mb-4">
                                <h6 class="fw-bold mb-2 small text-uppercase text-muted">Danh mục</h6>
                                <div class="filter-group" style="max-height: 200px; overflow-y: auto;">
                                    @foreach (var cat in categories)
                                    {
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" name="loaiIds" value="@cat.ID" id="cat_@cat.ID" @(activeLoaiIds.Contains(cat.ID) ? "checked" : "") onchange="submitFilter()">
                                            <label class="form-check-label" for="cat_@cat.ID">@cat.TenLoaiVatTu</label>
                                        </div>
                                    }
                                </div>
                            </div>

                            <hr class="text-muted opacity-25">

                            <!-- Supplier Filter -->
                            <div class="mb-4">
                                <h6 class="fw-bold mb-2 small text-uppercase text-muted">Nhà cung cấp</h6>
                                <div class="filter-group" style="max-height: 200px; overflow-y: auto;">
                                    @foreach (var sup in suppliers)
                                    {
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" name="nhaCungCapIds" value="@sup.ID" id="sup_@sup.ID" @(activeSupIds.Contains(sup.ID) ? "checked" : "") onchange="submitFilter()">
                                            <label class="form-check-label" for="sup_@sup.ID">@sup.TenNhaCungCap</label>
                                        </div>
                                    }
                                </div>
                            </div>

                            <hr class="text-muted opacity-25">

                            <!-- Price Filter -->
                            <div class="mb-3">
                                <h6 class="fw-bold mb-3 small text-uppercase text-muted">Khoảng giá</h6>
                                <div class="filter-group">
                                    @foreach (var range in priceRangeDisplay)
                                    {
                                         <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" name="priceRanges" value="@range.Key" id="price_@range.Key" @(activePriceRanges.Contains(range.Key) ? "checked" : "") onchange="submitFilter()">
                                            <label class="form-check-label" for="price_@range.Key">@range.Value</label>
                                        </div>
                                    }
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Product List -->
            <div class="col-lg-9">
                
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                    <h2 class="fw-bold mb-0 text-dark">Sản phẩm</h2>
                    <span class="text-muted">Hiển thị @(Model?.Count() ?? 0) trên tổng số @(ViewBag.TotalItems ?? 0) kết quả</span>
                </div>

                <!-- Active Filters Chips -->
                @if (activeLoaiIds.Any() || activeSupIds.Any() || activePriceRanges.Any())
                {
                    <div class="active-filters mb-4 d-flex flex-wrap gap-2 align-items-center">
                        <span class="small fw-bold text-muted me-2">Đang lọc:</span>
                        
                        @foreach(var id in activeLoaiIds)
                        {
                            var name = categories.FirstOrDefault(c => c.ID == id)?.TenLoaiVatTu;
                            <span class="badge bg-white text-dark border shadow-sm text-decoration-none px-3 py-2 rounded-pill d-flex align-items-center gap-2">
                                <span>@name</span>
                                <i class="fas fa-times text-danger cursor-pointer" onclick="uncheckAndSubmit('cat_@id')"></i>
                            </span>
                        }

                        @foreach(var id in activeSupIds)
                        {
                            var name = suppliers.FirstOrDefault(s => s.ID == id)?.TenNhaCungCap;
                            <span class="badge bg-white text-dark border shadow-sm text-decoration-none px-3 py-2 rounded-pill d-flex align-items-center gap-2">
                                <span>@name</span>
                                <i class="fas fa-times text-danger cursor-pointer" onclick="uncheckAndSubmit('sup_@id')"></i>
                            </span>
                        }

                        @foreach(var range in activePriceRanges)
                        {
                            <span class="badge bg-white text-dark border shadow-sm text-decoration-none px-3 py-2 rounded-pill d-flex align-items-center gap-2">
                                <span>@priceRangeDisplay[range]</span>
                                <i class="fas fa-times text-danger cursor-pointer" onclick="uncheckAndSubmit('price_@range')"></i>
                            </span>
                        }

                        <a href="/SanPham" class="btn btn-link btn-sm text-danger text-decoration-none fw-bold">Xóa tất cả</a>
                    </div>
                }

                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                    @if (Model != null && Model.Any())
                    {
                        foreach (var product in Model)
                        {
                            <div class="col">
                                <div class="card h-100 border-0 shadow-sm product-card-hover rounded-3 overflow-hidden">
                                     <div class="position-relative">
                                        <a href="@Url.Action("ProductDetail", "SanPham", new { id = product.ID })">
                                            <img src="/user/images/@($"{product.TenVatTu}.jpg")" class="card-img-top" alt="@product.TenVatTu" style="height: 250px; object-fit: cover;">
                                        </a>
                                    </div>

                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title text-truncate mb-2">
                                            <a href="@Url.Action("ProductDetail", "SanPham", new { id = product.ID })" class="text-decoration-none text-dark fw-bold" title="@product.TenVatTu">
                                                @product.TenVatTu
                                            </a>
                                        </h5>
                                        
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="text-warning small me-2">
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star-half-alt"></i>
                                            </div>
                                            <span class="text-muted small">(5.0)</span>
                                        </div>

                                        <div class="mt-auto">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <span class="fs-5 fw-bold text-primary">@(product.GiaBan?.ToString("N0") ?? "0")đ</span>
                                            </div>

                                            @if (product.SoLuongTon > 0)
                                            {
                                                <button class="btn btn-outline-primary w-100 fw-bold rounded-3" onclick="quickAdd(@product.ID)">
                                                    <i class="fas fa-cart-plus me-1"></i> Thêm vào giỏ
                                                </button>
                                            }
                                            else
                                            {
                                                <button class="btn btn-secondary w-100 rounded-3" disabled>Tạm hết hàng</button>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="col-12 py-5 text-center">
                            <div class="text-muted mb-3">
                                <i class="fas fa-search fa-3x"></i>
                            </div>
                            <h4>Không tìm thấy sản phẩm nào.</h4>
                            <p class="text-muted">Thử thay đổi hoặc xóa bộ lọc tìm kiếm.</p>
                            <a href="/SanPham" class="btn btn-primary mt-2">Xem tất cả sản phẩm</a>
                        </div>
                    }
                </div>

                <!-- Pagination -->
                @if (ViewBag.TotalPages > 1)
                {
                    <div class="d-flex justify-content-center mt-5">
                        <nav aria-label="Page navigation">
                            <ul class="pagination pagination-sm custom-pagination">
                                <!-- Previous -->
                                <li class="page-item @(ViewBag.CurrentPage == 1 ? "disabled" : "")">
                                    <a class="page-link" href="javascript:void(0)" onclick="goToPage(@(ViewBag.CurrentPage - 1))" aria-label="Previous">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                </li>

                                @for (int i = 1; i <= ViewBag.TotalPages; i++)
                                {
                                    <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                                        <a class="page-link" href="javascript:void(0)" onclick="goToPage(@i)">
                                            @i
                                        </a>
                                    </li>
                                }

                                <!-- Next -->
                                <li class="page-item @(ViewBag.CurrentPage == ViewBag.TotalPages ? "disabled" : "")">
                                    <a class="page-link" href="javascript:void(0)" onclick="goToPage(@(ViewBag.CurrentPage + 1))" aria-label="Next">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                }
            </div>
        </div>
    </div>
</div>
<!-- End Content -->

<link rel="stylesheet" href="~/user/css/categories.css" />

<style>
    /* Custom Round Pagination */
    .custom-pagination .page-item .page-link {
        width: 36px;
        height: 36px;
        border-radius: 50% !important;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 4px;
        border: 1px solid #dee2e6;
        color: #333;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.2s;
    }
    .custom-pagination .page-item.active .page-link {
        background-color: var(--bs-primary);
        border-color: var(--bs-primary);
        color: #fff;
        box-shadow: 0 4px 10px rgba(13, 110, 253, 0.3);
    }
    .custom-pagination .page-item.disabled .page-link {
        opacity: 0.6;
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }
    .custom-pagination .page-item:not(.active):not(.disabled) .page-link:hover {
        background-color: #e9ecef;
        color: var(--bs-primary);
        transform: translateY(-2px);
    }
    
    .cursor-pointer {
        cursor: pointer;
    }

    .filter-group::-webkit-scrollbar {
        width: 4px;
    }
    .filter-group::-webkit-scrollbar-track {
        background: #f1f1f1; 
    }
    .filter-group::-webkit-scrollbar-thumb {
        background: #ccc; 
        border-radius: 4px;
    }
    .filter-group::-webkit-scrollbar-thumb:hover {
        background: #aaa; 
    }
</style>

@section Scripts {
    <script>
        // Submit filter form when a checkbox changes
        function submitFilter() {
            // Reset to page 1 on new filter
            document.getElementById('pageInput').value = 1; 
            document.getElementById('filterForm').submit();
        }

        // Uncheck filter and submit (for Active Chips)
        function uncheckAndSubmit(elementId) {
            var el = document.getElementById(elementId);
            if(el) {
                el.checked = false;
                submitFilter();
            }
        }

        // Pagination Navigation
        function goToPage(page) {
            document.getElementById('pageInput').value = page;
            document.getElementById('filterForm').submit();
        }

        // Quick Add Function
        function quickAdd(id) {
             $.post('/GioHang/AddToCart', { productId: id, quantity: 1 }, function(res) {
                if(res.success) {
                    alert("Đã thêm vào giỏ hàng!"); 
                } else {
                    alert(res.message);
                }
            });
        }
    </script>
}