@using QuanLyVatTu_ASP.Models.ViewModels
@model QuanLyVatTu_ASP.Areas.Admin.Models.KhachHang
@{
    Layout = null; // Independent Page
    var cart = ViewBag.Cart as List<CartItem>;
    var total = (decimal?)ViewBag.Total ?? 0;
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thanh toán - Quản lý vật tư</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Core CSS -->
    <link rel="stylesheet" href="~/user/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="~/user/css/site.css" />
    <link rel="stylesheet" href="~/user/css/checkout.css" asp-append-version="true" />
    
    <style>
        body { 
            background-color: #f9fafb; 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        /* Toast Notification */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1f2937;
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 9999;
            transition: transform 0.3s ease;
            visibility: hidden;
        }
        
        .toast-notification.active {
            transform: translateX(-50%) translateY(0);
            visibility: visible;
        }
    </style>
</head>
<body>

    <!-- Minimal Header -->
    <header class="checkout-page-header">
        <div class="checkout-container">
            <a href="/" class="logo-text">
                <i class="fas fa-tools"></i>
                <span>Quản lý vật tư</span>
            </a>
        </div>
    </header>

    <div class="checkout-page">
        <div class="checkout-container">
            
            <form action="/ThanhToan/ProcessCheckout" method="post" id="checkoutForm">
                <input type="hidden" name="isBuyNow" value="@((ViewBag.IsBuyNow == true) ? "true" : "false")" />
                <div class="checkout-layout">
                    
                    <!-- LEFT COLUMN: Forms -->
                    <div class="col-left checkout-form-column">
                        
                        <!-- Header & Steps -->
                        <div class="mb-3">
                            <h1 class="checkout-title">Thông tin thanh toán</h1>
                            <div class="text-muted" style="font-size: 0.9rem;">
                                <a href="/GioHang/GioHang" class="text-decoration-none" style="color: #6b7280;">Giỏ hàng</a> 
                                <i class="fas fa-chevron-right mx-2" style="font-size: 0.65rem; color: #9ca3af;"></i> 
                                <span style="color: #111827; font-weight: 600;">Thanh toán</span>
                            </div>
                        </div>

                        <!-- 1. Shipping Info -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fa-regular fa-id-card"></i>
                                </div>
                                <h2 class="section-title">Thông tin vận chuyển</h2>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group w-100">
                                    <label class="form-label">Họ và tên <span class="text-danger">*</span></label>
                                    <input type="text" class="form-input w-100" name="HoTen" value="@Model?.HoTen" required placeholder="Nhập họ tên người nhận">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Email <span class="text-danger">*</span></label>
                                    <input type="email" class="form-input w-100" name="Email" value="@Model?.Email" required placeholder="email@example.com">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-input w-100" name="soDienThoai" value="@Model?.SoDienThoai" required placeholder="Nhập số điện thoại">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Địa chỉ chi tiết <span class="text-danger">*</span></label>
                                <input type="text" class="form-input w-100" name="diaChi" value="@Model?.DiaChi" required placeholder="Số nhà, tên đường, phường/xã...">
                            </div>
                        </div>

                        <!-- 2. Shipping Method -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fa-solid fa-truck-fast"></i>
                                </div>
                                <h2 class="section-title">Phương thức vận chuyển</h2>
                            </div>
                            
                            <div class="shipping-options">
                                <!-- Self Delivery - No Unloading -->
                                <label class="custom-radio-card">
                                    <input type="radio" name="shippingMethod" value="delivery" checked>
                                    <div class="radio-content">
                                        <div class="radio-circle"></div>
                                        <div class="radio-info">
                                            <span class="radio-title">🚚 Cửa hàng giao tận nơi (Không dỡ hàng)</span>
                                            <span class="radio-desc">Xe cửa hàng giao đến công trình - Quý khách tự bốc xếp</span>
                                        </div>
                                        <span class="radio-price">Phí theo khoảng cách</span>
                                    </div>
                                </label>
                                
                                <!-- Self Delivery - With Unloading -->
                                <label class="custom-radio-card">
                                    <input type="radio" name="shippingMethod" value="delivery_unload">
                                    <div class="radio-content">
                                        <div class="radio-circle"></div>
                                        <div class="radio-info">
                                            <span class="radio-title">🚚 Cửa hàng giao + Dỡ hàng</span>
                                            <span class="radio-desc">Nhân viên cửa hàng hỗ trợ dỡ hàng tại điểm giao</span>
                                        </div>
                                        <span class="radio-price">Phí giao + 100.000₫/tấn</span>
                                    </div>
                                </label>
                                
                                <!-- Store Pickup -->
                                <label class="custom-radio-card">
                                    <input type="radio" name="shippingMethod" value="pickup">
                                    <div class="radio-content">
                                        <div class="radio-circle"></div>
                                        <div class="radio-info">
                                            <span class="radio-title">🏪 Nhận tại cửa hàng</span>
                                            <span class="radio-desc">Quý khách tự đến lấy hàng tại kho</span>
                                        </div>
                                        <span class="radio-price text-success">Miễn phí vận chuyển</span>
                                    </div>
                                </label>
                            </div>
                            
                            <!-- Self-delivery note -->
                            <div class="delivery-note mt-3">
                                <i class="fa-solid fa-circle-info"></i>
                                <span>Cửa hàng <strong>tự vận chuyển</strong> bằng xe tải riêng. Phí giao hàng sẽ được nhân viên thông báo sau khi xác nhận đơn.</span>
                            </div>
                            
                            <!-- Road Width Info -->
                            <div class="road-width-section mt-3">
                                <label class="form-label"><i class="fa-solid fa-road"></i> Độ rộng đường vào công trình</label>
                                <div class="road-options">
                                    <label class="road-option">
                                        <input type="radio" name="roadWidth" value="large" checked>
                                        <span>> 3.5m (Xe tải lớn)</span>
                                    </label>
                                    <label class="road-option">
                                        <input type="radio" name="roadWidth" value="medium">
                                        <span>2-3.5m (Xe tải nhỏ)</span>
                                    </label>
                                    <label class="road-option">
                                        <input type="radio" name="roadWidth" value="narrow">
                                        <span>< 2m (Xe ba gác)</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 3. Payment Method -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fa-solid fa-wallet"></i>
                                </div>
                                <h2 class="section-title">Phương thức thanh toán</h2>
                            </div>
                            
                            <div class="payment-methods">
                                <!-- COD -->
                                <label class="custom-radio-card">
                                    <input type="radio" name="paymentMethod" value="cod" checked>
                                    <div class="radio-content">
                                        <div class="radio-circle"></div>
                                        <div class="radio-info">
                                            <span class="radio-title">Thanh toán khi nhận hàng (COD)</span>
                                            <span class="radio-desc">Thanh toán tiền mặt cho nhân viên giao hàng</span>
                                        </div>
                                        <i class="fa-solid fa-money-bill-wave" style="color: #10b981; font-size: 1.25rem;"></i>
                                    </div>
                                </label>
                                
                                <!-- Bank Transfer -->
                                <label class="custom-radio-card">
                                    <input type="radio" name="paymentMethod" value="bank">
                                    <div class="radio-content">
                                        <div class="radio-circle"></div>
                                        <div class="radio-info">
                                            <span class="radio-title">Chuyển khoản ngân hàng</span>
                                            <span class="radio-desc">Chuyển khoản qua Internet Banking/QR Code</span>
                                        </div>
                                        <i class="fa-solid fa-building-columns" style="color: #3b82f6; font-size: 1.25rem;"></i>
                                    </div>
                                    
                                    <!-- Payment Details -->
                                    <div class="payment-details">
                                        <div class="bank-info-box">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <span style="color: #6b7280; font-size: 0.9rem;">Ngân hàng:</span>
                                                <strong style="color: #111827;">Vietcombank</strong>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <span style="color: #6b7280; font-size: 0.9rem;">Số tài khoản:</span>
                                                <div class="d-flex align-items-center gap-2">
                                                    <strong style="color: #3b82f6;" id="bankAccount">0071000123456</strong>
                                                    <button type="button" class="copy-btn" onclick="copyToClipboard('bankAccount')">
                                                        <i class="fa-regular fa-copy"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <span style="color: #6b7280; font-size: 0.9rem;">Chủ tài khoản:</span>
                                                <strong style="color: #111827; text-transform: uppercase; font-size: 0.9rem;">CTY MAY THIET BI KIM LONG</strong>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span style="color: #6b7280; font-size: 0.9rem;">Nội dung:</span>
                                                <div class="d-flex align-items-center gap-2">
                                                    <strong style="color: #ef4444;" id="transferContent">@Model?.HoTen @Model?.SoDienThoai</strong>
                                                    <button type="button" class="copy-btn" onclick="copyToClipboard('transferContent')">
                                                        <i class="fa-regular fa-copy"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- 4. VAT Invoice -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fa-solid fa-file-invoice"></i>
                                </div>
                                <h2 class="section-title">Xuất hóa đơn VAT</h2>
                                <label class="toggle-switch ms-auto">
                                    <input type="checkbox" name="xuatVAT" id="vatToggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            
                            <div id="vatForm" class="vat-form" style="display: none;">
                                <div class="form-group">
                                    <label class="form-label">Tên công ty <span class="text-danger">*</span></label>
                                    <input type="text" class="form-input w-100" name="tenCongTy" placeholder="Nhập tên công ty">
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Mã số thuế <span class="text-danger">*</span></label>
                                        <input type="text" class="form-input w-100" name="maSoThue" placeholder="VD: 0123456789">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Email nhận hóa đơn</label>
                                        <input type="email" class="form-input w-100" name="emailVAT" placeholder="hoadon@congty.vn">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Địa chỉ ĐKKD <span class="text-danger">*</span></label>
                                    <input type="text" class="form-input w-100" name="diaChiDKKD" placeholder="Địa chỉ đăng ký kinh doanh">
                                </div>
                            </div>
                        </div>

                        <!-- 5. Deposit Options REMOVED as per user request -->
                        <!-- Logic for high value orders handles deposit automatically in controller -->

                        <!-- 6. Notes -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fa-regular fa-message"></i>
                                </div>
                                <h2 class="section-title">Ghi chú đơn hàng</h2>
                            </div>
                            <div class="form-group w-100">
                                <textarea class="form-input w-100" name="ghiChu" rows="3" placeholder="Ghi chú về đơn hàng, yêu cầu giao hàng đặc biệt..."></textarea>
                            </div>
                        </div>

                        <!-- Actions Section -->
                        <div class="mt-2">
                             <!-- Terms Checkbox -->
                            <div class="form-check mb-4">
                                <input class="form-check-input" type="checkbox" id="termsCheck" required>
                                <label class="form-check-label" for="termsCheck">
                                    Tôi đã đọc và đồng ý với <a href="#" data-bs-toggle="modal" data-bs-target="#policyModal">Chính sách mua hàng</a>
                                </label>
                            </div>

                            <div class="d-flex justify-content-between align-items-center gap-3">
                                <a href="/GioHang/GioHang" class="btn-back-cart">
                                    <i class="fa-solid fa-arrow-left"></i>
                                    <span>Quay lại giỏ hàng</span>
                                </a>
                                <button type="submit" class="btn-place-order">
                                    <span>Đặt hàng</span>
                                    <i class="fa-solid fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>

                    </div>

                    <!-- RIGHT COLUMN: Summary -->
                    <div class="col-right checkout-summary-column">
                        <div class="summary-card">
                            <div class="summary-header">
                                <i class="fa-solid fa-shopping-bag"></i>
                                <h3>Đơn hàng của bạn (@(cart != null ? cart.Count : 0) sản phẩm)</h3>
                            </div>
                            
                            <div class="summary-products">
                                @if (cart != null)
                                {
                                    foreach (var item in cart)
                                    {
                                        <div class="summary-item">
                                            <div class="item-thumb">
                                                <img src="@item.HinhAnh" alt="@item.TenVatTu">
                                                <span class="item-badge">@item.SoLuong</span>
                                            </div>
                                            <div class="item-info">
                                                <span class="item-name">@item.TenVatTu</span>
                                                <span class="item-meta">Đơn giá: @item.DonGia.ToString("N0")₫</span>
                                            </div>
                                            <div class="item-price">
                                                @((item.DonGia * item.SoLuong).ToString("N0"))₫
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                            
                            <div class="summary-totals">
                                <div class="total-row">
                                    <span>Tạm tính</span>
                                    <span style="font-weight: 600; color: #111827;">@total.ToString("N0")₫</span>
                                </div>
                                <div class="total-row">
                                    <span>Phí vận chuyển</span>
                                    <span id="shippingFee" style="font-weight: 600;">47.000₫</span>
                                </div>
                                
                                <div class="total-row final">
                                    <span>Tổng cộng</span>
                                    <span class="value" id="finalTotal">@((total + 47000).ToString("N0"))₫</span>
                                </div>
                            </div>
                            
                            <div class="features-list">
                                <div class="feature-item">
                                    <i class="fa-solid fa-shield-halved"></i>
                                    <span>Thanh toán bảo mật 100%</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fa-solid fa-rotate-left"></i>
                                    <span>Đổi trả trong 7 ngày</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fa-solid fa-headset"></i>
                                    <span>Hỗ trợ khách hàng 24/7</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast-notification" id="checkoutToast">
        <i class="fa-solid fa-check-circle me-2"></i>
        <span>Đã sao chép!</span>
    </div>

    <script src="~/user/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/user/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Data from server
        // Data from server
        const totalAmount = @Json.Serialize(total);
        const depositThreshold = 5000000;
        
        // Shipping Fee Logic
        document.querySelectorAll('input[name="shippingMethod"]').forEach(radio => {
            radio.addEventListener('change', function() {
                updateTotal();
            });
        });

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            handleDepositLogic();
            updateTotal();
        });

        function handleDepositLogic() {
            const isHighValue = totalAmount >= depositThreshold;
            const pmRadios = document.querySelectorAll('input[name="paymentMethod"]');
            const depositSection = document.querySelector('.deposit-section');
            const depositOptions = document.querySelector('.deposit-options');
            const depositInfoBox = document.querySelector('.deposit-info-box');
            
            if (isHighValue) {
                // 1. Force Bank Transfer
                // Find and check 'bank' option
                const bankRadio = document.querySelector('input[name="paymentMethod"][value="bank"]');
                if(bankRadio) bankRadio.checked = true;
                
                // Disable 'cod' option
                const codRadio = document.querySelector('input[name="paymentMethod"][value="cod"]');
                if(codRadio) {
                    codRadio.disabled = true;
                    codRadio.closest('.custom-radio-card').style.opacity = '0.5';
                    codRadio.closest('.custom-radio-card').title = "Đơn hàng trên 5 triệu bắt buộc cọc qua chuyển khoản";
                }

                // 2. Hide Deposit Options (0, 30, 50, 100)
                // Removed from UI

                // 3. Show Mandatory Deposit Message
                if(depositInfoBox) {
                     depositInfoBox.innerHTML = `
                        <div class="alert alert-warning border-warning d-flex align-items-center mb-0">
                            <i class="fa-solid fa-triangle-exclamation me-3 fs-4"></i>
                            <div>
                                <strong>Đơn hàng giá trị lớn (>= 5.000.000₫):</strong><br>
                                Bắt buộc đặt cọc trước <strong>10%</strong> giá trị đơn hàng.<br>
                                Số tiền cọc cần thanh toán: <strong class="text-danger">${formatCurrency(totalAmount * 0.1)}₫</strong>
                            </div>
                        </div>
                    `;
                }
                
                // Update Button Text
                const btn = document.querySelector('.btn-place-order span');
                if(btn) btn.textContent = "Đặt hàng & Thanh toán cọc";
            }
        }

        function updateTotal() {
            const shippingMethod = document.querySelector('input[name="shippingMethod"]:checked').value;
            const shippingFeeEl = document.getElementById('shippingFee');
            const finalTotalEl = document.getElementById('finalTotal');
            
            let shippingFee = 0;
            if (shippingMethod === 'delivery' || shippingMethod === 'delivery_unload') {
                shippingFee = 47000; // Mock fee, adjust as needed
                shippingFeeEl.textContent = '47.000₫';
                shippingFeeEl.classList.remove('text-success');
                shippingFeeEl.style.color = '#111827';
            } else {
                shippingFee = 0;
                shippingFeeEl.textContent = 'Miễn phí';
                shippingFeeEl.classList.add('text-success');
            }
            
            // Check high value logic for display
             const isHighValue = totalAmount >= depositThreshold;
             if(isHighValue) {
                  // Show total but imply deposit is separate step
                  finalTotalEl.innerHTML = `
                    <div>${formatCurrency(totalAmount + shippingFee)}₫</div>
                    <div style="font-size: 0.8rem; color: #ef4444; font-weight: normal;">(Cọc trước: ${formatCurrency(totalAmount * 0.1)}₫)</div>
                  `;
             } else {
                  finalTotalEl.textContent = formatCurrency(totalAmount + shippingFee) + '₫';
             }
        }

        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(text).then(() => {
                showToast('Đã sao chép vào bộ nhớ tạm!');
            });
        }
        
        function formatCurrency(number) {
            return new Intl.NumberFormat('vi-VN').format(number);
        }

        function showToast(message) {
            const toast = document.getElementById('checkoutToast');
            toast.querySelector('span').textContent = message;
            toast.classList.add('active');
            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }

        // Display Server-Side Messages
        document.addEventListener('DOMContentLoaded', function() {
            var errorMessage = @Json.Serialize(TempData["Error"]);
            var warningMessage = @Json.Serialize(TempData["Warning"]);

            if (errorMessage) {
                showToast(errorMessage);
            }
            if (warningMessage) {
                showToast(warningMessage);
            }
        });

        // Form validation feedback
        document.getElementById('checkoutForm').addEventListener('submit', function(e) {
            const inputs = this.querySelectorAll('input[required]');
            let isValid = true;
            
            inputs.forEach(input => {
                if (!input.value.trim()) {
                    input.classList.add('is-invalid');
                    isValid = false;
                } else {
                    input.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                showToast('Vui lòng điền đầy đủ thông tin!');
            } else {
                // Show loading state
                const btn = document.querySelector('.btn-place-order');
                const originalContent = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
                btn.style.opacity = '0.7';
                btn.style.pointerEvents = 'none';
                
                // Optional: Timeout to reset if taking too long (e.g. 10s)
                setTimeout(() => {
                    if(!btn.disabled) { // If page hasn't unloaded
                         btn.innerHTML = originalContent;
                         btn.style.opacity = '1';
                         btn.style.pointerEvents = 'auto';
                    }
                }, 15000);
            }
        });

        // Remove invalid class on input
        document.querySelectorAll('.form-input').forEach(input => {
            input.addEventListener('input', function() {
                this.classList.remove('is-invalid');
            });
        });

        // VAT Toggle
        document.getElementById('vatToggle').addEventListener('change', function() {
            const vatForm = document.getElementById('vatForm');
            vatForm.style.display = this.checked ? 'block' : 'none';
        });

        // Shipping fee update for new options
        document.querySelectorAll('input[name="shippingMethod"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const shippingFeeEl = document.getElementById('shippingFee');
                if (this.value === 'pickup') {
                    shippingFeeEl.textContent = 'Miễn phí';
                    shippingFeeEl.classList.add('text-success');
                } else if (this.value === 'unloading') {
                    shippingFeeEl.textContent = 'Tính theo trọng lượng';
                    shippingFeeEl.classList.remove('text-success');
                } else {
                    shippingFeeEl.textContent = 'Tính theo khoảng cách';
                    shippingFeeEl.classList.remove('text-success');
                }
            });
        });
    </script>

    <!-- Policy Modal - Full Scroll-to-Accept -->
    <div class="modal fade" id="policyModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content policy-modal">
                <div class="modal-header policy-modal-header">
                    <div class="d-flex align-items-center gap-2">
                        <i class="fa-solid fa-file-shield fa-lg"></i>
                        <div>
                            <h5 class="modal-title mb-0">Chính sách mua hàng</h5>
                            <small class="text-white-50">Vui lòng đọc kỹ và cuộn xuống cuối để tiếp tục</small>
                        </div>
                    </div>
                </div>
                <div class="modal-body p-0">
                    <!-- Scroll Container -->
                    <div class="policy-scroll-container" id="policyScrollContainer">
                        
                        <!-- 1. Chính sách thanh toán -->
                        <div class="policy-section-modal">
                            <h4 class="policy-section-title">
                                <span class="section-number">1</span>
                                <i class="fa-solid fa-credit-card"></i>
                                Chính sách Thanh toán
                            </h4>
                            
                            <div class="policy-subsection">
                                <h5><i class="fa-solid fa-coins"></i> Quy định đặt cọc</h5>
                                <table class="policy-table">
                                    <tr>
                                        <td>Đơn hàng dưới 10 triệu</td>
                                        <td><span class="badge bg-success">Không cọc</span></td>
                                    </tr>
                                    <tr>
                                        <td>Đơn hàng 10 - 50 triệu</td>
                                        <td><span class="badge bg-warning text-dark">Cọc 30%</span></td>
                                    </tr>
                                    <tr>
                                        <td>Đơn hàng trên 50 triệu</td>
                                        <td><span class="badge bg-danger">Cọc 50%</span></td>
                                    </tr>
                                </table>
                            </div>

                            <div class="policy-subsection">
                                <h5><i class="fa-solid fa-chart-line"></i> Biến động giá</h5>
                                <ul class="policy-list-modal">
                                    <li>Giá sắt thép có thể thay đổi theo thị trường hàng ngày</li>
                                    <li>Giá được <strong>khóa sau khi đặt cọc</strong></li>
                                    <li>Nếu giá tăng sau cọc: Khách hàng giữ nguyên giá cũ</li>
                                    <li>Nếu giá giảm sau cọc: Được điều chỉnh theo giá mới</li>
                                </ul>
                            </div>

                            <div class="policy-subsection">
                                <h5><i class="fa-solid fa-wallet"></i> Phương thức thanh toán</h5>
                                <div class="payment-methods-mini">
                                    <div class="method-item">
                                        <i class="fa-solid fa-money-bill-wave"></i>
                                        <span>Tiền mặt khi nhận hàng (COD)</span>
                                    </div>
                                    <div class="method-item">
                                        <i class="fa-solid fa-building-columns"></i>
                                        <span>Chuyển khoản ngân hàng</span>
                                    </div>
                                    <div class="method-item">
                                        <i class="fa-solid fa-file-invoice"></i>
                                        <span>Xuất hóa đơn VAT (nếu yêu cầu)</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 2. Chính sách vận chuyển -->
                        <div class="policy-section-modal">
                            <h4 class="policy-section-title">
                                <span class="section-number">2</span>
                                <i class="fa-solid fa-truck"></i>
                                Chính sách Vận chuyển
                            </h4>
                            
                            <div class="policy-alert info">
                                <i class="fa-solid fa-circle-info"></i>
                                <div>Cửa hàng <strong>tự vận chuyển</strong> bằng xe tải riêng. Phí sẽ được thông báo sau khi xác nhận đơn.</div>
                            </div>

                            <div class="policy-subsection">
                                <h5><i class="fa-solid fa-location-dot"></i> Phạm vi giao hàng</h5>
                                <table class="policy-table">
                                    <tr>
                                        <td><strong>Giao cổng công trình</strong></td>
                                        <td>Tài xế giao đến cổng, quý khách tự bốc xếp</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Dịch vụ dỡ hàng</strong></td>
                                        <td>+100.000₫/tấn hàng</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Nhận tại kho</strong></td>
                                        <td>Miễn phí vận chuyển</td>
                                    </tr>
                                </table>
                            </div>

                            <div class="policy-subsection">
                                <h5><i class="fa-solid fa-road"></i> Yêu cầu đường vào công trình</h5>
                                <ul class="policy-list-modal">
                                    <li><strong>Đường > 3.5m:</strong> Xe tải lớn vào được</li>
                                    <li><strong>Đường 2-3.5m:</strong> Xe tải nhỏ/ba gác</li>
                                    <li><strong>Đường < 2m:</strong> Cần trung chuyển, phát sinh chi phí</li>
                                </ul>
                            </div>

                            <div class="policy-subsection">
                                <h5><i class="fa-solid fa-clock"></i> Phí chờ xe</h5>
                                <table class="policy-table">
                                    <tr>
                                        <td>0 - 30 phút</td>
                                        <td><span class="text-success fw-bold">Miễn phí</span></td>
                                    </tr>
                                    <tr>
                                        <td>30 phút - 1 giờ</td>
                                        <td>100.000₫</td>
                                    </tr>
                                    <tr>
                                        <td>Quá 2 giờ</td>
                                        <td>100.000₫/giờ tiếp theo</td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <!-- 3. Chính sách đổi trả -->
                        <div class="policy-section-modal">
                            <h4 class="policy-section-title">
                                <span class="section-number">3</span>
                                <i class="fa-solid fa-rotate-left"></i>
                                Chính sách Đổi trả
                            </h4>
                            
                            <div class="policy-subsection">
                                <h5><i class="fa-solid fa-check-circle"></i> Điều kiện đổi trả</h5>
                                <ul class="policy-list-modal">
                                    <li>Hàng <strong>nguyên đai, nguyên kiện</strong></li>
                                    <li>Trong vòng <strong>7 ngày</strong> kể từ ngày nhận hàng</li>
                                    <li>Có hóa đơn mua hàng hoặc phiếu giao hàng</li>
                                    <li><strong>Phí nhập kho:</strong> 10-15% giá trị sản phẩm</li>
                                </ul>
                            </div>

                            <div class="policy-alert danger">
                                <i class="fa-solid fa-ban"></i>
                                <div>
                                    <strong>KHÔNG chấp nhận đổi trả:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li>Xi măng rách bao</li>
                                        <li>Sơn đã pha màu theo yêu cầu</li>
                                        <li>Thép/Tôn đã cắt theo kích thước</li>
                                        <li>Hàng đặt theo yêu cầu riêng</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- 4. Chính sách bảo hành -->
                        <div class="policy-section-modal">
                            <h4 class="policy-section-title">
                                <span class="section-number">4</span>
                                <i class="fa-solid fa-shield-halved"></i>
                                Chính sách Bảo hành
                            </h4>
                            
                            <div class="policy-subsection">
                                <h5><i class="fa-solid fa-medal"></i> Cam kết chất lượng</h5>
                                <div class="commitment-list">
                                    <div class="commit-item">
                                        <i class="fa-solid fa-check-double"></i>
                                        <span>100% hàng chính hãng, có nguồn gốc rõ ràng</span>
                                    </div>
                                    <div class="commit-item">
                                        <i class="fa-solid fa-check-double"></i>
                                        <span>Đúng mác thép, đủ khối lượng như cam kết</span>
                                    </div>
                                    <div class="commit-item">
                                        <i class="fa-solid fa-check-double"></i>
                                        <span><strong>SAI HÀNG ĐỀN GẤP ĐÔI</strong></span>
                                    </div>
                                </div>
                            </div>

                            <div class="policy-subsection">
                                <h5><i class="fa-solid fa-wrench"></i> Bảo hành thiết bị</h5>
                                <table class="policy-table">
                                    <tr>
                                        <td>Máy móc điện cầm tay</td>
                                        <td>6 - 12 tháng</td>
                                    </tr>
                                    <tr>
                                        <td>Thiết bị vệ sinh (bồn cầu, lavabo)</td>
                                        <td>12 - 24 tháng</td>
                                    </tr>
                                    <tr>
                                        <td>Sơn (theo lô sản xuất)</td>
                                        <td>Theo hạn sử dụng</td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <!-- Scroll End Marker -->
                        <div class="scroll-end-marker" id="scrollEndMarker">
                            <i class="fa-solid fa-circle-check"></i>
                            <span>Bạn đã đọc hết chính sách</span>
                        </div>

                    </div>
                </div>
                <div class="modal-footer policy-modal-footer">
                    <div class="scroll-indicator" id="scrollIndicator">
                        <i class="fa-solid fa-arrow-down"></i>
                        <span>Cuộn xuống để đọc hết chính sách</span>
                    </div>
                    <a href="/ChinhSach" target="_blank" class="btn btn-outline-secondary btn-sm">
                        <i class="fa-solid fa-external-link-alt me-1"></i> Xem trang chính sách
                    </a>
                    <button type="button" class="btn btn-primary" id="policyAcceptBtn" disabled>
                        <i class="fa-solid fa-check me-1"></i> Tôi đã đọc và đồng ý
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Policy Modal Scroll Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const scrollContainer = document.getElementById('policyScrollContainer');
            const scrollIndicator = document.getElementById('scrollIndicator');
            const acceptBtn = document.getElementById('policyAcceptBtn');
            const modal = document.getElementById('policyModal');

            // Check if scrolled to bottom
            scrollContainer.addEventListener('scroll', function() {
                const isAtBottom = scrollContainer.scrollHeight - scrollContainer.scrollTop <= scrollContainer.clientHeight + 50;
                if (isAtBottom) {
                    scrollIndicator.classList.add('hidden');
                    acceptBtn.disabled = false;
                    acceptBtn.classList.add('btn-success');
                    acceptBtn.classList.remove('btn-primary');
                }
            });

            // Reset on modal open
            modal.addEventListener('show.bs.modal', function() {
                scrollContainer.scrollTop = 0;
                scrollIndicator.classList.remove('hidden');
                acceptBtn.disabled = true;
                acceptBtn.classList.remove('btn-success');
                acceptBtn.classList.add('btn-primary');
            });

            // Close modal and check checkbox on accept
            acceptBtn.addEventListener('click', function() {
                if (!this.disabled) {
                    document.getElementById('termsCheck').checked = true;
                    bootstrap.Modal.getInstance(modal).hide();
                }
            });
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
